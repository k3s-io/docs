<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-advanced" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">高度なオプション / 設定 | K3s</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.k3s.io/ja/advanced"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh"><meta data-rh="true" property="og:locale:alternate" content="kr"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="高度なオプション / 設定 | K3s"><meta data-rh="true" name="description" content="このセクションには、K3sを実行および管理するさまざまな方法や、K3sの使用に向けてホストOSを準備するために必要な手順についての高度な情報が含まれています。"><meta data-rh="true" property="og:description" content="このセクションには、K3sを実行および管理するさまざまな方法や、K3sの使用に向けてホストOSを準備するために必要な手順についての高度な情報が含まれています。"><link data-rh="true" rel="icon" href="/ja/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.k3s.io/ja/advanced"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/advanced" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/zh/advanced" hreflang="zh"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/kr/advanced" hreflang="kr"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/ja/advanced" hreflang="ja"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/advanced" hreflang="x-default"><link rel="stylesheet" href="/ja/assets/css/styles.753903f9.css">
<script src="/ja/assets/js/runtime~main.1f11c57e.js" defer="defer"></script>
<script src="/ja/assets/js/main.6c292dab.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="ナビゲーション" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="ナビゲーションバーを開く" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ja/"><div class="navbar__logo"><img src="/ja/img/k3s-logo-light.svg" alt="logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/ja/img/k3s-logo-dark.svg" alt="logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>日本語</a><ul class="dropdown__menu"><li><a href="/advanced" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/zh/advanced" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh">简体中文</a></li><li><a href="/kr/advanced" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="kr">한국어</a></li><li><a href="/ja/advanced" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="ja">日本語</a></li></ul></div><a href="https://github.com/k3s-io/k3s/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn">GitHub</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="ドキュメントのサイドバー" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ja/">K3s - 軽量なKubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ja/quick-start">クイックスタートガイド</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/ja/installation">Installation</a><button aria-label="&#x27;Installation&#x27;の目次を開く" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/ja/datastore">Cluster Datastore</a><button aria-label="&#x27;Cluster Datastore&#x27;の目次を開く" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/ja/upgrades">Upgrades</a><button aria-label="&#x27;Upgrades&#x27;の目次を開く" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/ja/security">Security</a><button aria-label="&#x27;Security&#x27;の目次を開く" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/ja/cli">CLI Tools</a><button aria-label="&#x27;CLI Tools&#x27;の目次を開く" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ja/architecture">アーキテクチャ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ja/cluster-access">クラスターアクセス</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ja/storage">ボリュームとストレージ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/ja/networking">Networking</a><button aria-label="&#x27;Networking&#x27;の目次を開く" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ja/helm">Helm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/ja/advanced">高度なオプション / 設定</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/ja/reference/env-variables">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/ja/release-notes/v1.30.X">Release Notes</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ja/related-projects">関連プロジェクト</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ja/known-issues">既知の問題</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ja/faq">FAQ</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="パンくずリストのナビゲーション"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ホームページ" class="breadcrumbs__link" href="/ja/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">高度なオプション / 設定</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>高度なオプション / 設定</h1></header><p>このセクションには、K3sを実行および管理するさまざまな方法や、K3sの使用に向けてホストOSを準備するために必要な手順についての高度な情報が含まれています。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="証明書管理">証明書管理<a href="#証明書管理" class="hash-link" aria-label="証明書管理 への直接リンク" title="証明書管理 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="証明書認証局-ca-証明書">証明書認証局 (CA) 証明書<a href="#証明書認証局-ca-証明書" class="hash-link" aria-label="証明書認証局 (CA) 証明書 への直接リンク" title="証明書認証局 (CA) 証明書 への直接リンク">​</a></h3>
<p>K3sは、最初のサーバーノードの起動時に自己署名の証明書認証局 (CA) 証明書を生成します。これらのCA証明書は10年間有効であり、自動的に更新され  ません。</p>
<p>カスタムCA証明書の使用や自己署名CA証明書の更新についての情報は、<a href="/ja/cli/certificate#certificate-authority-ca-certificates"><code>k3s certificate rotate-ca</code> コマンドのドキュメント</a>を参照してください。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="クライアントおよびサーバー証明書">クライアントおよびサーバー証明書<a href="#クライアントおよびサーバー証明書" class="hash-link" aria-label="クライアントおよびサーバー証明書 への直接リンク" title="クライアントおよびサーバー証明書 への直接リンク">​</a></h3>
<p>K3sのクライアントおよびサーバー証明書は、発行日から365日間有効です。期限が切れているか、期限が切れるまで90日以内の証明書は、K3sが起動するたびに自動的に更新されます。</p>
<p>クライアントおよびサーバー証明書を手動で回転させる方法については、<a href="/ja/cli/certificate#client-and-server-certificates"><code>k3s certificate rotate</code> コマンドのドキュメント</a>を参照してください。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="トークン管理">トークン管理<a href="#トークン管理" class="hash-link" aria-label="トークン管理 への直接リンク" title="トークン管理 への直接リンク">​</a></h2>
<p>デフォルトでは、K3sはサーバーとエージェントの両方に対して単一の静的トークンを使用します。このトークンはクラスターが作成された後に変更することはできません。
エージェントの参加にのみ使用できる2番目の静的トークンを有効にするか、自動的に期限切れになる一時的な <code>kubeadm</code> スタイルの参加トークンを作成することが可能です。
詳細については、<a href="/ja/cli/token"><code>k3s token</code> コマンドのドキュメ  ント</a>を参照してください。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="httpプロキシの設定">HTTPプロキシの設定<a href="#httpプロキシの設定" class="hash-link" aria-label="HTTPプロキシの設定 への直接リンク" title="HTTPプロキシの設定 への直接リンク">​</a></h2>
<p>K3sをHTTPプロキシを介してのみ外部接続が可能な環境で実行している場合、K3sのsystemdサービスでプロキシ設定を構成できます。これらのプロキシ設定はK3sで使用され、埋め込まれたcontainerdおよびkubeletに渡されます。</p>
<p>K3sのインストールスクリプトは、現在のシェルに存在する場合、<code>HTTP_PROXY</code>、<code>HTTPS_PROXY</code>、<code>NO_PROXY</code>、および <code>CONTAINERD_HTTP_PROXY</code>、<code>CONTAINERD_HTTPS_PROXY</code>、<code>CONTAINERD_NO_PROXY</code> 変数を自動的に取得し、通常は次の環境ファイルに書き込みます：</p>
<ul>
<li><code>/etc/systemd/system/k3s.service.env</code></li>
<li><code>/etc/systemd/system/k3s-agent.service.env</code></li>
</ul>
<p>もちろん、これらのファイルを編集してプロキシを設定することもできます。</p>
<p>K3sはクラスター内部のPodおよびサービスIP範囲とクラスターDNSドメインを <code>NO_PROXY</code> エントリのリストに自動的に追加します。Kubernetesノード自体が使用するIPアドレス範囲（つまり、ノードのパブリックおよびプライベートIP）が <code>NO_PROXY</code> リストに含まれているか、ノードがプロキシを介して到達可能であることを確認する必要があります。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTP_PROXY=http://your-proxy.example.com:8888</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTPS_PROXY=http://your-proxy.example.com:8888</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NO_PROXY=127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>containerdのプロキシ設定をK3sおよびKubeletに影響を与えずに構成したい場合は、変数に <code>CONTAINERD_</code> をプレフィックスとして付けることができます：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CONTAINERD_HTTP_PROXY=http://your-proxy.example.com:8888</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CONTAINERD_HTTPS_PROXY=http://your-proxy.example.com:8888</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CONTAINERD_NO_PROXY=127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dockerをコンテナランタイムとして使用する">Dockerをコンテナランタイムとして使用する<a href="#dockerをコンテナランタイムとして使用する" class="hash-link" aria-label="Dockerをコンテナランタイムとして使用する への直接リンク" title="Dockerをコンテナランタイムとして使用する への直接リンク">​</a></h2>
<p>K3sには業界標準のコンテナランタイムである<a href="https://containerd.io/" target="_blank" rel="noopener noreferrer">containerd</a>が含まれており、デフォルトで使用されます。
Kubernetes 1.24以降、Kubeletにはdockershimが含まれておらず、Kubeletがdockerdと通信するためのコンポーネントがありません。
K3s 1.24以降には<a href="https://github.com/Mirantis/cri-dockerd" target="_blank" rel="noopener noreferrer">cri-dockerd</a>が含まれており、Dockerコンテナランタイムを引き続き使用しながら、以前のリリースからシームレスにアップグレードできます。</p>
<p>Dockerをcontainerdの代わりに使用するには：</p>
<ol>
<li>
<p>K3sノードにDockerをインストールします。Rancherの<a href="https://github.com/rancher/install-docker" target="_blank" rel="noopener noreferrer">Dockerインストールスクリプト</a>の1つを使用 してDockerをインストールできます：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">curl https://releases.rancher.com/install-docker/20.10.sh | sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><code>--docker</code> オプションを使用してK3sをインストールします：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">curl -sfL https://get.k3s.io | sh -s - --docker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>クラスターが利用可能であることを確認します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ sudo k3s kubectl get pods --all-namespaces</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NAMESPACE     NAME                                     READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   local-path-provisioner-6d59f47c7-lncxn   1/1     Running     0          51s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   metrics-server-7566d596c8-9tnck          1/1     Running     0          51s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   helm-install-traefik-mbkn9               0/1     Completed   1          51s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   coredns-8655855d6-rtbnb                  1/1     Running     0          51s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   svclb-traefik-jbmvl                      2/2     Running     0          43s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   traefik-758cd5fc85-2wz97                 1/1     Running     0          43s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Dockerコンテナが実行中であることを確認します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ sudo docker ps</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CONTAINER ID        IMAGE                     COMMAND                  CREATED              STATUS              PORTS               NAMES</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3e4d34729602        897ce3c5fc8f              &quot;entry&quot;                  About a minute ago   Up About a minute                       k8s_lb-port-443_svclb-traefik-jbmvl_kube-system_d46f10c6-073f-4c7e-8d7a-8e7ac18f9cb0_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bffdc9d7a65f        rancher/klipper-lb        &quot;entry&quot;                  About a minute ago   Up About a minute                       k8s_lb-port-80_svclb-traefik-jbmvl_kube-system_d46f10c6-073f-4c7e-8d7a-8e7ac18f9cb0_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">436b85c5e38d        rancher/library-traefik   &quot;/traefik --configfi…&quot;   About a minute ago   Up About a minute                       k8s_traefik_traefik-758cd5fc85-2wz97_kube-system_07abe831-ffd6-4206-bfa1-7c9ca4fb39e7_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">de8fded06188        rancher/pause:3.1         &quot;/pause&quot;                 About a minute ago   Up About a minute                       k8s_POD_svclb-traefik-jbmvl_kube-system_d46f10c6-073f-4c7e-8d7a-8e7ac18f9cb0_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">7c6a30aeeb2f        rancher/pause:3.1         &quot;/pause&quot;                 About a minute ago   Up About a minute                       k8s_POD_traefik-758cd5fc85-2wz97_kube-system_07abe831-ffd6-4206-bfa1-7c9ca4fb39e7_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ae6c58cab4a7        9d12f9848b99              &quot;local-path-provisio…&quot;   About a minute ago   Up About a minute                       k8s_local-path-provisioner_local-path-provisioner-6d59f47c7-lncxn_kube-system_2dbd22bf-6ad9-4bea-a73d-620c90a6c1c1_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">be1450e1a11e        9dd718864ce6              &quot;/metrics-server&quot;        About a minute ago   Up About a minute                       k8s_metrics-server_metrics-server-7566d596c8-9tnck_kube-system_031e74b5-e9ef-47ef-a88d-fbf3f726cbc6_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4454d14e4d3f        c4d3d16fe508              &quot;/coredns -conf /etc…&quot;   About a minute ago   Up About a minute                       k8s_coredns_coredns-8655855d6-rtbnb_kube-system_d05725df-4fb1-410a-8e82-2b1c8278a6a1_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">c3675b87f96c        rancher/pause:3.1         &quot;/pause&quot;                 About a minute ago   Up About a minute                       k8s_POD_coredns-8655855d6-rtbnb_kube-system_d05725df-4fb1-410a-8e82-2b1c8278a6a1_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4b1fddbe6ca6        rancher/pause:3.1         &quot;/pause&quot;                 About a minute ago   Up About a minute                       k8s_POD_local-path-provisioner-6d59f47c7-lncxn_kube-system_2dbd22bf-6ad9-4bea-a73d-620c90a6c1c1_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">64d3517d4a95        rancher/pause:3.1         &quot;/pause&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="etcdctlの使用">etcdctlの使用<a href="#etcdctlの使用" class="hash-link" aria-label="etcdctlの使用 への直接リンク" title="etcdctlの使用 への直接リンク">​</a></h2>
<p>etcdctlは、etcdサーバーと対話するためのCLIを提供します。K3sにはetcdctlはバンドルされていません。</p>
<p>K3sの埋め込みetcdと対話するためにetcdctlを使用したい場合は、<a href="https://etcd.io/docs/latest/install/" target="_blank" rel="noopener noreferrer">公式ドキュメント</a>を使用してetcdctlをインストールしてくだ さい。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ETCD_VERSION=&quot;v3.5.5&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ETCD_URL=&quot;https://github.com/etcd-io/etcd/releases/download/${ETCD_VERSION}/etcd-${ETCD_VERSION}-linux-amd64.tar.gz&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">curl -sL ${ETCD_URL} | sudo tar -zxv --strip-components=1 -C /usr/local/bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>次に、K3s管理の証明書とキーを認証に使用するようにetcdctlを構成して使用できます：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo etcdctl version \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --cacert=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --cert=/var/lib/rancher/k3s/server/tls/etcd/client.crt \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --key=/var/lib/rancher/k3s/server/tls/etcd/client.key</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="containerdの設定">containerdの設定<a href="#containerdの設定" class="hash-link" aria-label="containerdの設定 への直接リンク" title="containerdの設定 への直接リンク">​</a></h2>
<p>K3sは、containerdのconfig.tomlを <code>/var/lib/rancher/k3s/agent/etc/containerd/config.toml</code> に生成します。</p>
<p>このファイルの高度なカスタマイズを行うには、同じディレクトリに <code>config.toml.tmpl</code> という別のファイルを作成し、それが代わりに使用されます。</p>
<p><code>config.toml.tmpl</code> はGoテンプレートファイルとして扱われ、<code>config.Node</code> 構造体がテンプレートに渡されます。この構造体を使用して設定ファイルをカスタマイズする方法については、<a href="https://github.com/k3s-io/k3s/blob/master/pkg/agent/templates" target="_blank" rel="noopener noreferrer">このフォルダ</a>のLinuxおよびWindowsの例を参照してください。
config.Node golang構造体は<a href="https://github.com/k3s-io/k3s/blob/master/pkg/daemons/config/types.go#L37" target="_blank" rel="noopener noreferrer">こちら</a>で定義されています。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ベーステンプレート">ベーステンプレート<a href="#ベーステンプレート" class="hash-link" aria-label="ベーステンプレート への直接リンク" title="ベーステンプレート への直接リンク">​</a></h3>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>バージョンゲート</div><div class="admonitionContent_BuS1"><p>2023年9月のリリースから利用可能：v1.24.17+k3s1、v1.25.13+k3s1、v1.26.8+k3s1、v1.27.5+k3s1、v1.28.1+k3s1</p></div></div>
<p>K3sのベーステンプレートを拡張して、K3sのソースコードから完全な標準テンプレートをコピー＆ペーストする代わりに使用できます。これは、既存の設定に基づいて構築し、最後にいくつかの行を追加する必要がある場合に便利です。</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#/var/lib/rancher/k3s/agent/etc/containerd/config.toml.tmpl</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{{ template &quot;base&quot; . }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.&quot;custom&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  runtime_type = &quot;io.containerd.runc.v2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.&quot;custom&quot;.options]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  BinaryName = &quot;/usr/bin/custom-container-runtime&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="nvidiaコンテナランタイムのサポート">NVIDIAコンテナランタイムのサポート<a href="#nvidiaコンテナランタイムのサポート" class="hash-link" aria-label="NVIDIAコンテナランタイムのサポート への直接リンク" title="NVIDIAコンテナランタイムのサポート への直接リンク">​</a></h2>
<p>K3sは、起動時にNVIDIAコンテナランタイムが存在する場合、自動的に検出して構成します。</p>
<ol>
<li>
<p>ノードにnvidia-containerパッケージリポジトリをインストールします。手順は以下を参照してください：
<a href="https://nvidia.github.io/libnvidia-container/" target="_blank" rel="noopener noreferrer">https://nvidia.github.io/libnvidia-container/</a></p>
</li>
<li>
<p>nvidiaコンテナランタイムパッケージをインストールします。例えば：
<code>apt install -y nvidia-container-runtime cuda-drivers-fabricmanager-515 nvidia-headless-515-server</code></p>
</li>
<li>
<p>K3sをインストールするか、既にインストールされている場合は再起動します：
<code>curl -ksL get.k3s.io | sh -</code></p>
</li>
<li>
<p>K3sがnvidiaコンテナランタイムを検出したことを確認します：</p>
<p><code>grep nvidia /var/lib/rancher/k3s/agent/etc/containerd/config.toml</code></p>
</li>
</ol>
<p>これにより、見つかったランタイム実行ファイルに応じて、<code>nvidia</code> および/または <code>nvidia-experimental</code> ランタイムが自動的に containerd の設定に追加されます。
クラスターに RuntimeClass 定義を追加し、Pod スペックで <code>runtimeClassName: nvidia</code> を設定して適切なランタイムを明示的に要求する Pod をデプロイする必要があります:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> node.k8s.io/v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> RuntimeClass</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nvidia</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nvidia</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nbody</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">gpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">benchmark</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> OnFailure</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">runtimeClassName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nvidia</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cuda</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nvcr.io/nvidia/k8s/cuda</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">sample</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">nbody</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;nbody&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-gpu&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-benchmark&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">limits</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> NVIDIA_VISIBLE_DEVICES</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> all</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> NVIDIA_DRIVER_CAPABILITIES</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>NVIDIA Container Runtime は <a href="https://github.com/NVIDIA/k8s-device-plugin/" target="_blank" rel="noopener noreferrer">NVIDIA Device Plugin</a> と頻繁に使用され、上記のように pod スペックに <code>runtimeClassName: nvidia</code> を含めるように変更されることが多いことに注意してください。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="エージェントレスサーバーの実行-実験的機能">エージェントレスサーバーの実行 (実験的機能)<a href="#エージェントレスサーバーの実行-実験的機能" class="hash-link" aria-label="エージェントレスサーバーの実行 (実験的機能) への直接リンク" title="エージェントレスサーバーの実行 (実験的機能) への直接リンク">​</a></h2>
<blockquote>
<p><strong>警告:</strong> この機能は実験的です。</p>
</blockquote>
<p><code>--disable-agent</code> フラグを使用して開始すると、サーバーは kubelet、コンテナランタイム、または CNI を実行しません。クラスターに Node リソースを登録せず、<code>kubectl get nodes</code> の出力には表示されません。
kubelet をホストしないため、Pod を実行したり、クラスターのノードを列挙するオペレーター（埋め込みの etcd コントローラーやシステムアップグレードコントローラーを含む）によって管理されたりすることはできません。</p>
<p>エージェントレスサーバーを実行することは、エージェントやワークロードからコントロールプレーンノードを発見されないようにする場合に有利ですが、クラスターオペレーターのサポートがないため管理の負担が増加します。</p>
<p>デフォルトでは、エージェントレスサーバーの apiserver はクラスター内で実行されているアドミッションウェブフックや集約 API サービスへの外向き接続を行うことができません。これを解決するには、<code>--egress-selector-mode</code> サーバーフラグを <code>pod</code> または <code>cluster</code> に設定します。既存のクラスターでこのフラグを変更する場合、オプションが有効になるためにはクラスター内のすべてのノードを再起動する必要があります。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ルートレスサーバーの実行-実験的機能">ルートレスサーバーの実行 (実験的機能)<a href="#ルートレスサーバーの実行-実験的機能" class="hash-link" aria-label="ルートレスサーバーの実行 (実験的機能) への直接リンク" title="ルートレスサーバーの実行 (実験的機能) への直接リンク">​</a></h2>
<blockquote>
<p><strong>警告:</strong> この機能は実験的です。</p>
</blockquote>
<p>ルートレスモードでは、K3s サーバーを特権のないユーザーとして実行できるため、ホストの実際の root を潜在的なコンテナブレークアウト攻撃から保護できます。</p>
<p>ルートレス Kubernetes について詳しくは <a href="https://rootlesscontaine.rs/" target="_blank" rel="noopener noreferrer">https://rootlesscontaine.rs/</a> を参照してください。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ルートレスモードの既知の問題">ルートレスモードの既知の問題<a href="#ルートレスモードの既知の問題" class="hash-link" aria-label="ルートレスモードの既知の問題 への直接リンク" title="ルートレス  モードの既知の問題 への直接リンク">​</a></h3>
<ul>
<li>
<p><strong>ポート</strong></p>
<p>ルートレスで実行すると、新しいネットワーク名前空間が作成されます。これは、K3s インスタンスがホストからかなり分離されたネットワークで実行されることを意味します。
ホストから K3s で実行されているサービスにアクセスする唯一の方法は、K3s ネットワーク名前空間へのポートフォワードを設定することです。
ルートレス K3s には、6443 および 1024 未満のサービスポートをホストにオフセット 10000 で自動的にバインドするコントローラーが含まれています。</p>
<p>例えば、ポート 80 のサービスはホスト上で 10080 になりますが、8080 はオフセットなしで 8080 になります。現在、自動的にバインドされるのは LoadBalancer サービスのみです。</p>
</li>
<li>
<p><strong>Cgroups</strong></p>
<p>Cgroup v1 およびハイブリッド v1/v2 はサポートされていません。純粋な Cgroup v2 のみがサポートされています。ルートレスで実行中に K3s が cgroups の欠如により起動に失敗する場合、ノードがハイブリッドモードになっており、「欠落している」cgroups が v1 コントローラーにまだバインドされている可能性があります。</p>
</li>
<li>
<p><strong>マルチノード/マルチプロセスクラスター</strong></p>
<p>マルチノードのルートレスクラスターや同じノード上での複数のルートレス k3s プロセスは現在サポートされていません。詳細については <a href="https://github.com/k3s-io/k3s/issues/6488#issuecomment-1314998091" target="_blank" rel="noopener noreferrer">#6488</a> を参照してください。</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ルートレスサーバーの開始">ルートレスサーバーの開始<a href="#ルートレスサーバーの開始" class="hash-link" aria-label="ルートレスサーバーの開始 への直接リンク" title="ルートレスサーバーの開始 への直接リンク">​</a></h3>
<ul>
<li>
<p>cgroup v2 デリゲーションを有効にします。詳細は <a href="https://rootlesscontaine.rs/getting-started/common/cgroup2/" target="_blank" rel="noopener noreferrer">https://rootlesscontaine.rs/getting-started/common/cgroup2/</a> を参照してください。
このステップは必須です。適切な cgroups がデリゲートされていないと、ルートレス kubelet は起動に失敗します。</p>
</li>
<li>
<p><a href="https://github.com/k3s-io/k3s/blob/master/k3s-rootless.service" target="_blank" rel="noopener noreferrer"><code>https://github.com/k3s-io/k3s/blob/&lt;VERSION&gt;/k3s-rootless.service</code></a> から <code>k3s-rootless.service</code> をダウンロードします。
<code>k3s-rootless.service</code> と <code>k3s</code> のバージョンが同じであることを確認してください。</p>
</li>
<li>
<p><code>k3s-rootless.service</code> を <code>~/.config/systemd/user/k3s-rootless.service</code> にインストールします。
このファイルをシステム全体のサービス (<code>/etc/systemd/...</code>) としてインストールすることはサポートされていません。
<code>k3s</code> バイナリのパスに応じて、ファイルの <code>ExecStart=/usr/local/bin/k3s ...</code> 行を変更する必要があるかもしれません。</p>
</li>
<li>
<p><code>systemctl --user daemon-reload</code> を実行します。</p>
</li>
<li>
<p><code>systemctl --user enable --now k3s-rootless</code> を実行します。</p>
</li>
<li>
<p><code>KUBECONFIG=~/.kube/k3s.yaml kubectl get pods -A</code> を実行し、Pod が実行されていることを確認します。</p>
</li>
</ul>
<blockquote>
<p><strong>注意:</strong> ターミナルで <code>k3s server --rootless</code> を実行しようとしないでください。タ ーミナルセッションでは cgroup v2 デリゲーションが許可されていません。
どうしてもターミナルで試す必要がある場合は、<code>systemd-run --user -p Delegate=yes --tty k3s server --rootless</code> を使用して systemd スコープでラップしてください。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="高度なルートレス設定">高度なルートレス設定<a href="#高度なルートレス設定" class="hash-link" aria-label="高度なルートレス設定 への直接リンク" title="高度なルートレス設定 への直接リンク">​</a></h3>
<p>ルートレス K3s は、ホストとユーザーネットワーク名前空間間の通信に <a href="https://github.com/rootless-containers/rootlesskit" target="_blank" rel="noopener noreferrer">rootlesskit</a> と <a href="https://github.com/rootless-containers/slirp4netns" target="_blank" rel="noopener noreferrer">slirp4netns</a> を使用します。
rootlesskit と slirp4netns によって使用される一部の設定は環境変数で設定できます。これらを設定する最良の方法は、k3s-rootless systemd ユニットの <code>Environment</code> フィールドに追加することです。</p>
<table><thead><tr><th>変数名</th><th>デフォルト値</th><th>説明</th></tr></thead><tbody><tr><td><code>K3S_ROOTLESS_MTU</code></td><td>1500</td><td>slirp4netns 仮想インターフェースの MTU を設定します。</td></tr><tr><td><code>K3S_ROOTLESS_CIDR</code></td><td>10.41.0.0/16</td><td>slirp4netns 仮想インターフェースで使用される CIDR を設定します。</td></tr><tr><td><code>K3S_ROOTLESS_ENABLE_IPV6</code></td><td>自動検出</td><td>slirp4netns の IPv6 サポートを有効にします。指定されていない場合、K3s がデュアルスタック操作に設定されている場合に自動的に有効になります。</td></tr><tr><td><code>K3S_ROOTLESS_PORT_DRIVER</code></td><td>builtin</td><td>ルートレスポー  トドライバーを選択します。<code>builtin</code> または <code>slirp4netns</code> のいずれかです。builtin は高速ですが、受信パケットの元の送信元アドレスを偽装します。</td></tr><tr><td><code>K3S_ROOTLESS_DISABLE_HOST_LOOPBACK</code></td><td>true</td><td>ゲートウェイインターフェースを介してホストのループバックアドレスへのアクセスを有効にするかどうかを制御します。セキュリティ上の理由から、これを変更しないことをお勧めします。</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ルートレスのトラブルシューティング">ルートレスのトラブルシューティング<a href="#ルートレスのトラブルシューティング" class="hash-link" aria-label="ルートレスのトラブルシューティング への直接リンク" title="ルートレスのトラブルシューティング への直接リンク">​</a></h3>
<ul>
<li><code>systemctl --user status k3s-rootless</code> を実行してデーモンのステータスを確認します。</li>
<li><code>journalctl --user -f -u k3s-rootless</code> を実行してデーモンログを確認します。</li>
<li>詳細は <a href="https://rootlesscontaine.rs/" target="_blank" rel="noopener noreferrer">https://rootlesscontaine.rs/</a> を参照してください。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ノードラベルとテイント">ノードラベルとテイント<a href="#ノードラベルとテイント" class="hash-link" aria-label="ノードラベルとテイント への直接リンク" title="ノードラベルとテイント への直接リンク">​</a></h2>
<p>K3s エージェントは、kubelet にラベルとテイントを追加するオプション <code>--node-label</code> および <code>--node-taint</code> で構成できます。これらのオプションは <a href="/ja/cli/agent#node-labels-and-taints-for-agents">登録時</a> にのみラベルおよび/またはテイントを追加するため、ノードがクラスターに最初に参加する際にのみ設定できます。</p>
<p>現在のすべての Kubernetes バージョンでは、<code>kubernetes.io</code> および <code>k8s.io</code> プレフィックスを持つほとんどのラベルでノードの登録が制限されています。特に <code>kubernetes.io/role</code> ラベルが含まれます。許可されていないラベルでノードを起動しようとすると、K3s は起動に失敗します。Kubernetes の著者によると:</p>
<blockquote>
<p>ノードは自分自身の役割ラベルを主張することは許可されていません。ノードの役割は通常、特権またはコントロールプレーンタイプのノードを識別するために使用され、ノードが自分自身をそのプールにラベル付けすることを許可すると、侵害されたノードが高い特権の資格情報にアクセスするワークロード（コントロールプレーンデーモンセットなど）を簡単に引き付けることができます。</p>
</blockquote>
<p>詳細については <a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-auth/279-limit-node-access/README.md#proposal" target="_blank" rel="noopener noreferrer">SIG-Auth KEP 279</a> を参照してください。</p>
<p>ノードの登録後にノードラベルとテイントを変更したり、予約済みラベルを追加したりする場合は、<code>kubectl</code> を使用する必要があります。テイントの追加方法については公式の Kubernetes ドキュメントを参照してください。<a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/" target="_blank" rel="noopener noreferrer">テイント</a> および <a href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#add-a-label-to-a-node" target="_blank" rel="noopener noreferrer">ノードラベル</a> の詳細を参照してください。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="インストールスクリプトでサービスを開始する">インストールスクリプトでサービスを開始する<a href="#インストールスクリプトでサービスを開始する" class="hash-link" aria-label="インストールスクリプトでサービスを開始する への直接リンク" title="インストールスクリプトでサービスを開始する への直接リンク">​</a></h2>
<p>インストールスクリプトは、OS が systemd または openrc を使用しているかを自動検出し、インストールプロセスの一環としてサービスを有効化および開始します。</p>
<ul>
<li>openrc で実行する場合、ログは <code>/var/log/k3s.log</code> に作成されます。</li>
<li>systemd で実行する場合、ログは <code>/var/log/syslog</code> に作成され、<code>journalctl -u k3s</code>（エージェントの場合は <code>journalctl -u k3s-agent</code>）を使用して表示されます。</li>
</ul>
<p>インストールスクリプトで自動起動およびサービスの有効化を無効にする例:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">curl -sfL https://get.k3s.io | INSTALL_K3S_SKIP_START=true INSTALL_K3S_SKIP_ENABLE=true sh -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="docker-で-k3s-を実行する">Docker で K3s を実行する<a href="#docker-で-k3s-を実行する" class="hash-link" aria-label="Docker で K3s を実行する への直接リンク" title="Docker で K3s を実行する への直接リンク">​</a></h2>
<p>Docker で K3s を実行する方法はいくつかあります:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">K3d</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Docker</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p><a href="https://github.com/k3d-io/k3d" target="_blank" rel="noopener noreferrer">k3d</a> は、Docker でマルチノード K3s クラスターを簡単に実行するために設計されたユーティリティです。</p><p>k3d を使用すると、ローカルでの Kubernetes 開発のために、Docker でシングルノードおよびマルチノードの k3s クラスターを非常に簡単に作成できます。</p><p>インストール方法や k3d の使用方法については、<a href="https://k3d.io/#installation" target="_blank" rel="noopener noreferrer">インストール</a> ドキュメントを参照してください。</p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>Docker を使用するには、K3s サーバーおよびエージェントを実行するための <code>rancher/k3s</code> イメージも利用可能です。
<code>docker run</code> コマンドを使用して:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo docker run \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --privileged \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --name k3s-server-1 \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --hostname k3s-server-1 \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -p 6443:6443 \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -d rancher/k3s:v1.24.10-k3s1 \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>注記</div><div class="admonitionContent_BuS1"><p>有効な K3s バージョンをタグとして指定する必要があります。<code>latest</code> タグは維持されていません。
Docker イメージではタグに <code>+</code> 記号を使用できないため、代わりに <code>-</code> を使用してください。</p></div></div><p>K3s が起動して実行されると、管理用 kubeconfig を Docker コンテナからコピーして使用できます:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo docker cp k3s-server-1:/etc/rancher/k3s/k3s.yaml ~/.kube/config</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="selinux-サポート">SELinux サポート<a href="#selinux-サポート" class="hash-link" aria-label="SELinux サポート への直接リンク" title="SELinux サポート への直接リンク">​</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>バージョンゲート</div><div class="admonitionContent_BuS1"><p>v1.19.4+k3s1 から利用可能</p></div></div>
<p>SELinux がデフォルトで有効になっているシステム（CentOS など）に K3s をインストールする場合、適切な SELinux ポリシーがインストールされていることを確認する必要があります。</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Automatic Installation</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Manual Installation</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p><a href="/ja/installation/configuration#configuration-with-install-script">インストールスクリプト</a>は、エアギャップインストールを行わない限り、互換性のあるシステムであればRancher RPMリポジトリからSELinux RPMを自動的にインストールします。自動インストールをスキップするには、<code>INSTALL_K3S_SKIP_SELINUX_RPM=true</code>を設定します。</p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>必要なポリシーは以下のコマンドでインストールできます:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">yum install -y container-selinux selinux-policy-base</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">yum install -y https://rpm.rancher.io/k3s/latest/common/centos/7/noarch/k3s-selinux-1.4-1.el7.noarch.rpm</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>インストールスクリプトが失敗するのではなく警告をログに記録するように強制するには、以下の環境変数を設定します: <code>INSTALL_K3S_SELINUX_WARN=true</code>。</p></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="selinuxの強制モードを有効にする">SELinuxの強制モードを有効にする<a href="#selinuxの強制モードを有効にする" class="hash-link" aria-label="SELinuxの強制モードを有効にする への直接リンク" title="SELinuxの強制モードを有効にする への直接リンク">​</a></h3>
<p>SELinuxを活用するには、K3sサーバーおよびエージェントを起動する際に<code>--selinux</code>フラグを指定します。</p>
<p>このオプションはK3sの<a href="/ja/installation/configuration#configuration-file">設定ファイル</a>にも指定できます。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">selinux: true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>SELinuxの下でカスタムの<code>--data-dir</code>を使用することはサポートされていません。カスタマイズするには、おそらく独自のカスタムポリシーを書く必要があります。ガイダンスについては、コンテナランタイムのSELinuxポリシーファイルを含む<a href="https://github.com/containers/container-selinux" target="_blank" rel="noopener noreferrer">containers/container-selinux</a>リポジトリおよびK3sのSELinuxポリシーを含む<a href="https://github.com/k3s-io/k3s-selinux" target="_blank" rel="noopener noreferrer">k3s-io/k3s-selinux</a>リポジトリを参照してください。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="estargzのレイジープルを有効にする実験的機能">eStargzのレイジープルを有効にする（実験的機能）<a href="#estargzのレイジープルを有効にする実験的機能" class="hash-link" aria-label="eStargzのレイジープルを有効にする（実験的機能） への直接リンク" title="eStargzのレイジープルを有効にする（実験的機能） への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="レイジープルとestargzとは">レイジープルとeStargzとは？<a href="#レイジープルとestargzとは" class="hash-link" aria-label="レイジープルとeStargzとは？ への直接リンク" title="レイジープルとeStargzとは？ への直接リンク">​</a></h3>
<p>イメージのプルはコンテナライフサイクルの中で時間のかかるステップの一つとして知られています。
<a href="https://www.usenix.org/conference/fast16/technical-sessions/presentation/harter" target="_blank" rel="noopener noreferrer">Harter, et al.</a>によると、</p>
<blockquote>
<p>パッケージのプルはコンテナ起動時間の76%を占めるが、そのデータのうち読み取られるのはわずか6.4%である</p>
</blockquote>
<p>この問題に対処するために、k3sはイメージコンテンツの<em>レイジープル</em>を実験的にサポートしています。
これにより、k3sはイメージ全体がプルされる前にコンテナを起動することができます。
代わりに、必要なコンテンツのチャンク（例：個々のファイル）がオンデマンドで取得されます。
特に大きなイメージの場合、この技術はコンテナの起動遅延を短縮することができます。</p>
<p>レイジープルを有効にするには、ターゲットイメージを<a href="https://github.com/containerd/stargz-snapshotter/blob/main/docs/stargz-estargz.md" target="_blank" rel="noopener noreferrer"><em>eStargz</em></a>としてフォーマットする必要があります。
これはOCIの代替ですが、100% OCI互換のイメージフォーマットで、レイジープルに対応しています。
互換性 があるため、eStargzは標準のコンテナレジストリ（例：ghcr.io）にプッシュでき、eStargz非対応のランタイムでも<em>実行可能</em>です。</p>
<p>eStargzは<a href="https://github.com/google/crfs" target="_blank" rel="noopener noreferrer">Google CRFSプロジェクトによって提案されたstargzフォーマット</a>に基づいて開発されましたが、コンテンツの検証やパフォーマンスの最適化などの実用的な機能が追加されています。
レイジープルとeStargzの詳細については、<a href="https://github.com/containerd/stargz-snapshotter" target="_blank" rel="noopener noreferrer">Stargz Snapshotterプロジェクトリポジトリ</a>を参照してください。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="estargzのレイジープルのためのk3sの設定">eStargzのレイジープルのためのk3sの設定<a href="#estargzのレイジープルのためのk3sの設定" class="hash-link" aria-label="eStargzのレイジープルのためのk3sの設定 への直接リンク" title="eStargzのレイジープルのためのk3sの設定 への直接リンク">​</a></h3>
<p>以下のように、k3sサーバーおよびエージェントに<code>--snapshotter=stargz</code>オプションが必要です。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">k3s server --snapshotter=stargz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>この設定により、eStargz形式のイメージのレイジープルを実行できます。
以下の例のPodマニフェストは、eStargz形式の<code>node:13.13.0</code>イメージ（<code>ghcr.io/stargz-containers/node:13.13.0-esgz</code>）を使用しています。
stargzスナップショッタが有効になっている場合、K3sはこのイメージのレイジープルを実行します。</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nodejs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nodejs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">estargz</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ghcr.io/stargz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">containers/node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">13.13.0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">esgz</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;node&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">e</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> var http = require(&#x27;http&#x27;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      http.createServer(function(req</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> res) </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        res.writeHead(200);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        res.end(&#x27;Hello World</span><span class="token tag" style="color:rgb(255, 85, 114)">!</span><span class="token plain">\n&#x27;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">).listen(80);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="追加のログソース">追加のログソース<a href="#追加のログソース" class="hash-link" aria-label="追加のログソース への直接リンク" title="追加のログソース への直接リンク">​</a></h2>
<p>K3s用の<a href="https://rancher.com/docs/rancher/v2.6/en/logging/helm-chart-options/" target="_blank" rel="noopener noreferrer">Rancherロギング</a>は、Rancherを使用せずにインストールできます。以下の手順を実行してください:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">helm repo add rancher-charts https://charts.rancher.io</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">helm install --create-namespace -n cattle-logging-system rancher-logging-crd rancher-charts/rancher-logging-crd</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">helm install --create-namespace -n cattle-logging-system rancher-logging --set additionalLoggingSources.k3s.enabled=true rancher-charts/rancher-logging</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="追加のネットワークポリシーロギング">追加のネットワークポリシーロギング<a href="#追加のネットワークポリシーロギング" class="hash-link" aria-label="追加のネットワークポリシーロギング への直接リンク" title="追加のネットワークポリシーロギング への直接リンク">​</a></h2>
<p>ネットワークポリシーによってドロップされたパケットをログに記録できます。パケットはiptablesのNFLOGアクションに送信され、パケットの詳細（ネットワークポリシーを含む）が表示されます。</p>
<p>トラフィックが多い場合、ログメッセージの数が非常に多くなる可能性があります。ポリシーごとにログのレートを制御するには、対象のネット  ワークポリシーに以下のアノテーションを追加して、<code>limit</code>および<code>limit-burst</code>のiptablesパラメータを設定します:</p>
<ul>
<li><code>kube-router.io/netpol-nflog-limit=&lt;LIMIT-VALUE&gt;</code></li>
<li><code>kube-router.io/netpol-nflog-limit-burst=&lt;LIMIT-BURST-VALUE&gt;</code></li>
</ul>
<p>デフォルト値は<code>limit=10/minute</code>および<code>limit-burst=10</code>です。これらのフィールドの形式および可能な値については、<a href="https://www.netfilter.org/documentation/HOWTO/packet-filtering-HOWTO-7.html#:~:text=restrict%20the%20rate%20of%20matches" target="_blank" rel="noopener noreferrer">iptablesマニュアル</a>を参照してください。</p>
<p>NFLOGパケットをログエントリに変換するには、ulogd2をインストールし、<code>[log1]</code>を<code>group=100</code>で読み取るように設定します。その後、ulogd2サービスを再起動して新しい設定を反映させます。
ネットワークポリシールールによってパケットがブロックされると、<code>/var/log/ulog/syslogemu.log</code>にログメッセージが表示されます。</p>
<p>NFLOGネットリンクソケットに送信されたパケットは、tcpdumpやtsharkなどのコマンドラインツールを使用して読み取ることもできます:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">tcpdump -ni nflog:100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>tcpdumpはより手軽に利用できますが、パケットをブロックしたネットワークポリシーの名前は表示されません。ネットワークポリシー名を含む完全なNFLOGパケットヘッダーを表示するには、wiresharkのtsharkコマンドを使用してください。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/k3s-io/docs/edit/main/docs/advanced.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated"><b><time datetime="2024-08-27T17:55:31.000Z" itemprop="dateModified">2024年8月27日</time></b>に<!-- -->最終更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/ja/helm"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">Helm</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ja/reference/env-variables"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">環境変数</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#証明書管理" class="table-of-contents__link toc-highlight">証明書管理</a><ul><li><a href="#証明書認証局-ca-証明書" class="table-of-contents__link toc-highlight">証明書認証局 (CA) 証明書</a></li><li><a href="#クライアントおよびサーバー証明書" class="table-of-contents__link toc-highlight">クライアントおよびサーバー証明書</a></li></ul></li><li><a href="#トークン管理" class="table-of-contents__link toc-highlight">トークン管理</a></li><li><a href="#httpプロキシの設定" class="table-of-contents__link toc-highlight">HTTPプロキシの設定</a></li><li><a href="#dockerをコンテナランタイムとして使用する" class="table-of-contents__link toc-highlight">Dockerをコンテナランタイムとして使用する</a></li><li><a href="#etcdctlの使用" class="table-of-contents__link toc-highlight">etcdctlの使用</a></li><li><a href="#containerdの設定" class="table-of-contents__link toc-highlight">containerdの設定</a><ul><li><a href="#ベーステンプレート" class="table-of-contents__link toc-highlight">ベーステンプレート</a></li></ul></li><li><a href="#nvidiaコンテナランタイムのサポート" class="table-of-contents__link toc-highlight">NVIDIAコンテナランタイムのサポート</a></li><li><a href="#エージェントレスサーバーの実行-実験的機能" class="table-of-contents__link toc-highlight">エージェントレスサーバーの実行 (実験的機能)</a></li><li><a href="#ルートレスサーバーの実行-実験的機能" class="table-of-contents__link toc-highlight">ルートレスサーバーの実行 (実験的機能)</a><ul><li><a href="#ルートレスモードの既知の問題" class="table-of-contents__link toc-highlight">ルートレスモードの既知の問題</a></li><li><a href="#ルートレスサーバーの開  始" class="table-of-contents__link toc-highlight">ルートレスサーバーの開始</a></li><li><a href="#高度なルートレス設定" class="table-of-contents__link toc-highlight">高度なルートレス設定</a></li><li><a href="#ルートレスのトラブルシューティング" class="table-of-contents__link toc-highlight">ルートレスのトラブルシューティング</a></li></ul></li><li><a href="#ノードラベルとテイント" class="table-of-contents__link toc-highlight">ノードラベルとテイント</a></li><li><a href="#インストールスクリプトでサービスを開始する" class="table-of-contents__link toc-highlight">インストールスクリプトでサービスを開始する</a></li><li><a href="#docker-で-k3s-を実行する" class="table-of-contents__link toc-highlight">Docker で K3s を実行する</a></li><li><a href="#selinux-サポート" class="table-of-contents__link toc-highlight">SELinux サポート</a><ul><li><a href="#selinuxの強制モードを有効にする" class="table-of-contents__link toc-highlight">SELinuxの強制モードを有効にする</a></li></ul></li><li><a href="#estargzのレイジープルを有効にする実験的機能" class="table-of-contents__link toc-highlight">eStargzのレイジープルを有効にする（実験的機能）</a><ul><li><a href="#レイジープルとestargzとは" class="table-of-contents__link toc-highlight">レイジープルとeStargzとは？</a></li><li><a href="#estargzのレイジープルのためのk3sの設定" class="table-of-contents__link toc-highlight">eStargzのレイジープルのためのk3sの設定</a></li></ul></li><li><a href="#追加のログソース" class="table-of-contents__link toc-highlight">追加のログソース</a></li><li><a href="#追加のネットワークポリシーロギング" class="table-of-contents__link toc-highlight">追加のネットワークポリシーロギング</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 K3s Project Authors. All rights reserved. <br>The Linux Foundation has registered trademarks
      and uses trademarks. For a list of trademarks of The Linux Foundation, 
      please see our <a href="https://www.linuxfoundation.org/trademark-usage"> Trademark Usage</a> page.</div></div></div></footer></div>
</body>
</html>