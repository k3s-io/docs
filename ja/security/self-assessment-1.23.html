<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-security/self-assessment-1.23" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">self-assessment-1.23 | K3s</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.k3s.io/ja/security/self-assessment-1.23"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="self-assessment-1.23 | K3s"><meta data-rh="true" name="description" content="set -eE"><meta data-rh="true" property="og:description" content="set -eE"><link data-rh="true" rel="icon" href="/ja/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.k3s.io/ja/security/self-assessment-1.23"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/security/self-assessment-1.23" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/zh/security/self-assessment-1.23" hreflang="zh"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/ja/security/self-assessment-1.23" hreflang="ja"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/security/self-assessment-1.23" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/ja/blog/rss.xml" title="K3s RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/ja/blog/atom.xml" title="K3s Atom Feed"><link rel="stylesheet" href="/ja/assets/css/styles.a7719de1.css">
<script src="/ja/assets/js/runtime~main.1145f12e.js" defer="defer"></script>
<script src="/ja/assets/js/main.cbbeec91.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/ja/img/k3s-logo-light.svg"><link rel="preload" as="image" href="/ja/img/k3s-logo-dark.svg"><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="ナビゲーション" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="ナビゲーションバーを開く" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ja/"><div class="navbar__logo"><img src="/ja/img/k3s-logo-light.svg" alt="logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/ja/img/k3s-logo-dark.svg" alt="logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="検索" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>日本語</a><ul class="dropdown__menu"><li><a href="/security/self-assessment-1.23" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/zh/security/self-assessment-1.23" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh">简体中文</a></li><li><a href="/ja/security/self-assessment-1.23" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="ja">日本語</a></li></ul></div><a class="navbar__item navbar__link navbar__icon navbar__blog" href="/ja/blog">Blog</a><a href="https://github.com/k3s-io/k3s/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__icon navbar__github">GitHub</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="システムモード" aria-label="ダークモードを切り替える(現在はシステムモード)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>self-assessment-1.23</h1></header><div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token front-matter-block punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token front-matter-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token front-matter-block"></span><span class="token front-matter-block front-matter yaml language-yaml key atrule">title</span><span class="token front-matter-block front-matter yaml language-yaml punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token front-matter-block front-matter yaml language-yaml"> CIS 1.23 自己評価ガイド</span><span class="token front-matter-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token front-matter-block"></span><span class="token front-matter-block punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">##</span><span class="token title important"> 概要</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">このドキュメントは</span><span class="token url" style="color:rgb(221, 221, 221)">[</span><span class="token url content" style="color:rgb(221, 221, 221)">K3sセキュリティ強化ガイド</span><span class="token url" style="color:rgb(221, 221, 221)">](</span><span class="token url" style="color:rgb(221, 221, 221)">hardening-guide.md</span><span class="token url" style="color:rgb(221, 221, 221)">)</span><span class="token plain">の補足資料です。強化ガイドはK3sの本番インストールを強化するための具体的な指針を提供し、このベンチマークガイドはCIS Kubernetesベンチマークの各コントロールに対して強化されたクラスターのセキュリティレベルを評価するのに役立ちます。K3sのオペレーター、セキュリティチーム、監査人、意思決定者が使用することを目的としています。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">このガイドはK3sの</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">v1.22-v1.23</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain">リリースラインおよびCIS Kubernetesベンチマークの</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">v1.23</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain">リリースに特化しています。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">各コントロールに関する詳細な説明やテスト失敗時の修正方法については、CIS Kubernetesベンチマークv1.6の該当セクションを参照してください。ベンチマークは</span><span class="token url" style="color:rgb(221, 221, 221)">[</span><span class="token url content" style="color:rgb(221, 221, 221)">Center for Internet Security (CIS)</span><span class="token url" style="color:rgb(221, 221, 221)">](</span><span class="token url" style="color:rgb(221, 221, 221)">https://www.cisecurity.org/benchmark/kubernetes</span><span class="token url" style="color:rgb(221, 221, 221)">)</span><span class="token plain">で無料アカウントを作成後にダウンロードできます。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">###</span><span class="token title important"> コントロールテストの方法論</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CIS Kubernetesベンチマークの各コントロールは、付随する強化ガイドに従って設定されたK3sクラスターに対して評価されました。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">コントロール監査が元のCISベンチマークと異なる場合、K3sに特化した監査コマンドがテスト用に提供されます。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">各コントロールの結果は以下の通りです：</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token list punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">合格</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> - テスト対象のK3sクラスターがベンチマークに記載された監査に合格しました。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token list punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">該当なし</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> - コントロールはK3sの設計上適用されません。修正セクションでその理由を説明します。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token list punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">警告</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> - コントロールはCISベンチマークで手動とされており、クラスターの使用ケースやその他の要因に依存します。これらのコントロールはK3sがその実装を妨げないことを確認するために評価されていますが、テスト対象のクラスターのさらなる設定や監査は行われていません。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">このガイドは、K3sがSystemdユニットとして実行されていることを前提としています。インストール方法が異なる場合は、「監査」コマンドをシナリオに合わせて調整する必要があります。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token blockquote punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"> 注意: このガイドでは</span><span class="token code-snippet code keyword" style="font-style:italic">`自動化された`</span><span class="token plain">テスト（以前は</span><span class="token code-snippet code keyword" style="font-style:italic">`スコア付き`</span><span class="token plain">と呼ばれていたもの）のみを対象としています。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">##</span><span class="token title important"> 1.1 コントロールプレーンノードの設定ファイル</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">###</span><span class="token title important"> 1.1.1 APIサーバーポッド仕様ファイルの権限が644以上に設定されていることを確認する（自動化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">結果:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> 該当なし</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">修正方法:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例：</span><span class="token code-snippet code keyword" style="font-style:italic">`chmod 644 /etc/kubernetes/manifests/kube-apiserver.yaml`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">###</span><span class="token title important"> 1.1.2 APIサーバーポッド仕様ファイルの所有者がroot:rootに設定されていることを確認する（自動化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">結果:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> 該当なし</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">修正方法:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例：</span><span class="token code-snippet code keyword" style="font-style:italic">`chown root:root /etc/kubernetes/manifests/kube-apiserver.yaml`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">###</span><span class="token title important"> 1.1.3 コントローラーマネージャーポッド仕様ファイルの権限が644以上に設定されていることを確認する（自動化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">結果:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> 該当なし</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">修正方法:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例：</span><span class="token code-snippet code keyword" style="font-style:italic">`chmod 644 /etc/kubernetes/manifests/kube-controller-manager.yaml`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">###</span><span class="token title important"> 1.1.4 コントローラーマネージャーポッド仕様ファイルの所有者がroot:rootに設定されていることを確認する（自動化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">結果:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> 該当なし</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">修正方法:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例：</span><span class="token code-snippet code keyword" style="font-style:italic">`chown root:root /etc/kubernetes/manifests/kube-controller-manager.yaml`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">###</span><span class="token title important"> 1.1.5 スケジューラーポッド仕様ファイルの権限が644以上に設定されていることを確認する（自動化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">結果:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> 該当なし</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">修正方法:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例：</span><span class="token code-snippet code keyword" style="font-style:italic">`chmod 644 /etc/kubernetes/manifests/kube-scheduler.yaml`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">###</span><span class="token title important"> 1.1.6 スケジューラーポッド仕様ファイルの所有者がroot:rootに設定されていることを確認する（自動化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">結果:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> 該当なし</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">修正方法:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例：</span><span class="token code-snippet code keyword" style="font-style:italic">`chown root:root /etc/kubernetes/manifests/kube-scheduler.yaml`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">###</span><span class="token title important"> 1.1.7 etcdポッド仕様ファイルの権限が644以上に設定されていることを確認する（自動化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">結果:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> 該当なし</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">修正方法:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例：</span><span class="token code-snippet code keyword" style="font-style:italic">`chmod 644 /etc/kubernetes/manifests/etcd.yaml`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">###</span><span class="token title important"> 1.1.8 etcdポッド仕様ファイルの所有者がroot:rootに設定されていることを確認する（自動化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">結果:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> 該当なし</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">修正方法:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例：</span><span class="token code-snippet code keyword" style="font-style:italic">`chown root:root /etc/kubernetes/manifests/etcd.yaml`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">###</span><span class="token title important"> 1.1.9 コンテナネットワークインターフェースファイルの権限が644以上に設定されていることを確認する（手動）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">結果:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> 該当なし</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">修正方法:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例：</span><span class="token code-snippet code keyword" style="font-style:italic">`chmod 644 &lt;path/to/cni/files&gt;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">###</span><span class="token title important"> 1.1.10 コンテナネットワークインターフェースファイルの所有者がroot:rootに設定されていることを確認する（手動）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">結果:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> 該当なし</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">修正方法:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例：</span><span class="token code-snippet code keyword" style="font-style:italic">`chown root:root &lt;path/to/cni/files&gt;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">###</span><span class="token title important"> 1.1.11 etcdデータディレクトリの権限が700以上に設定されていることを確認する（自動化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">結果:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> 合格</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">修正方法:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">etcdサーバーノードで、コマンド&#x27;ps -ef | grep etcd&#x27;から引数--data-dirとして渡されるetcdデータディレクトリを取得します。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">以下のコマンドを実行します（上記で見つかったetcdデータディレクトリに基づく）。例：chmod 700 /var/lib/etcd</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">監査スクリプト:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> </span><span class="token code-snippet code keyword" style="font-style:italic">`check_for_k3s_etcd.sh`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">```bash</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">#</span><span class="token title important">!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">#</span><span class="token title important"> このスクリプトは、k3sが実際にetcdを実行していること（sqlite3などの他のデータベースではないこと）を確認してから要件をチェックします</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set -eE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">handle_error() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    echo &quot;false&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">trap &#x27;handle_error&#x27; ERR</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if [[ &quot;$(journalctl -D /var/log/journal -u k3s | grep &#x27;Managed etcd cluster initializing&#x27; | grep -v grep | wc -l)&quot; -gt 0 ]]; then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    case $1 in </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;1.1.11&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(stat -c %a /var/lib/rancher/k3s/server/db/etcd);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;1.2.29&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(journalctl -D /var/log/journal -u k3s | grep &#x27;Running kube-apiserver&#x27; | tail -n1 | grep &#x27;etcd-&#x27;);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.1&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep -A 5 &#x27;client-transport-security&#x27; /var/lib/rancher/k3s/server/db/etcd/config | grep -E &#x27;cert-file|key-file&#x27;);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.2&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep -A 5 &#x27;client-transport-security&#x27; /var/lib/rancher/k3s/server/db/etcd/config | grep &#x27;client-cert-auth&#x27;);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.3&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep &#x27;auto-tls&#x27; /var/lib/rancher/k3s/server/db/etcd/config);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.4&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep -A 5 &#x27;peer-transport-security&#x27; /var/lib/rancher/k3s/server/db/etcd/config | grep -E &#x27;cert-file|key-file&#x27;);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.5&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep -A 5 &#x27;peer-transport-security&#x27; /var/lib/rancher/k3s/server/db/etcd/config | grep &#x27;client-cert-auth&#x27;);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.6&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep &#x27;peer-auto-tls&#x27; /var/lib/rancher/k3s/server/db/etcd/config);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.7&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep &#x27;trusted-ca-file&#x27; /var/lib/rancher/k3s/server/db/etcd/config);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    esac</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">else</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">#</span><span class="token title important"> 別のデータベースが実行されている場合、スキャンに合格するために必要なものを返します</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    case $1 in</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;1.1.11&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;700&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;1.2.29&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--etcd-certfile AND --etcd-keyfile&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.1&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;cert-file AND key-file&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.2&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--client-cert-auth=true&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.3&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;false&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.4&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;peer-cert-file AND peer-key-file&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.5&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--client-cert-auth=true&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.6&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--peer-auto-tls=false&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.7&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--trusted-ca-file&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    esac</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fi</span><br></span></code></pre></div></div>
<p><strong>監査実行:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">./check_for_k3s_etcd.sh </span><span class="token number" style="color:rgb(247, 140, 108)">1.1</span><span class="token plain">.11</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;700&#x27; は &#x27;700&#x27; と等しい</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">700</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1112-etcdデータディレクトリの所有者がetcdに設定されていることを確認する自動化">1.1.12 etcdデータディレクトリの所有者がetcd<!-- -->:etcd<!-- -->に設定されていることを確認する（自動化）<a href="#1112-etcdデータディレクトリの所有者がetcdに設定されていることを確認する自動化" class="hash-link" aria-label="1112-etcdデータディレクトリの所有者がetcdに設定されていることを確認する自動化 への直接リンク" title="1112-etcdデータディレクトリの所有者がetcdに設定されていることを確認する自動化 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 該当なし</p>
<p><strong>修正方法:</strong>
etcdサーバーノードで、コマンド&#x27;ps -ef | grep etcd&#x27;から引数--data-dirとして渡されるetcdデータディレクトリを取得します。
以下のコマンドを実行します（上記で見つかったetcdデータディレクトリに基づく）。
例：chown etcd<!-- -->:etcd<!-- --> /var/lib/etcd</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1113-adminconfファイルの権限が600以上に設定されていることを確認する自動化">1.1.13 admin.confファイルの権限が600以上に設定されていることを確認する（自動化）<a href="#1113-adminconfファイルの権限が600以上に設定されていることを確認する自動化" class="hash-link" aria-label="1.1.13 admin.confファイルの権限が600以上に設定されていることを確認する（自動化） への直接リンク" title="1.1.13 admin.confファイルの権限が600以上に設定されていることを確認する（自動化） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 該当なし</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：chmod 600 /var/lib/rancher/k3s/server/cred/admin.kubeconfig</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1114-adminconfファイルの所有者がrootに設定されていることを確認する自動化">1.1.14 admin.confファイルの所有者がroot<!-- -->:root<!-- -->に設定されていることを確認する（自動化）<a href="#1114-adminconfファイルの所有者がrootに設定されていることを確認する自動化" class="hash-link" aria-label="1114-adminconfファイルの所有者がrootに設定されていることを確認する自動化 への直接リンク" title="1114-adminconfファイルの所有者がrootに設定されていることを確認する自動化 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：chown root<!-- -->:root<!-- --> /etc/kubernetes/admin.conf</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/sh </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;if test -e /var/lib/rancher/k3s/server/cred/admin.kubeconfig; then stat -c %U:%G /var/lib/rancher/k3s/server/cred/admin.kubeconfig; fi&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;root:root&#x27; は &#x27;root:root&#x27; と等しい</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root:root</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1115-schedulerconfファイルの権限が644以上に設定されていることを確認する自動化">1.1.15 scheduler.confファイルの権限が644以上に設定されていることを確認する（自動化）<a href="#1115-schedulerconfファイルの権限が644以上に設定されていることを確認する自動化" class="hash-link" aria-label="1.1.15 scheduler.confファイルの権限が644以上に設定されていることを確認する（自動化） への直接リンク" title="1.1.15 scheduler.confファイルの権限が644以上に設定されていることを確認する（自動化） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：chmod 644 scheduler</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/sh </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;if test -e /var/lib/rancher/k3s/server/cred/scheduler.kubeconfig; then stat -c permissions=%a /var/lib/rancher/k3s/server/cred/scheduler.kubeconfig; fi&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">permissionsは644の権限を持ち、期待される権限は644以上</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">permissions=644</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1116-schedulerconfファイルの所有者がrootに設定されていることを確認する自動化">1.1.16 scheduler.confファイルの所有者がroot<!-- -->:root<!-- -->に設定されていることを確認する（自動化）<a href="#1116-schedulerconfファイルの所有者がrootに設定されていることを確認する自動化" class="hash-link" aria-label="1116-schedulerconfファイルの所有者がrootに設定されていることを確認する自動化 への直接リンク" title="1116-schedulerconfファイルの所有者がrootに設定されていることを確認する自動化 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">例えば、`chown root:root scheduler`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">**監査:**</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">```bash</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/sh -c &#x27;if test -e /var/lib/rancher/k3s/server/cred/scheduler.kubeconfig; then stat -c %U:%G /var/lib/rancher/k3s/server/cred/scheduler.kubeconfig; fi&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;root:root&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root:root</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1117-コントローラーマネージャーconfファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化">1.1.17 コントローラーマネージャー.confファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化）<a href="#1117-コントローラーマネージャーconfファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化" class="hash-link" aria-label="1.1.17 コントローラーマネージャー.confファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化） への直接リンク" title="1.1.17 コントローラーマネージャー.confファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例えば、
chmod 644 controllermanager</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/sh </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;if test -e /var/lib/rancher/k3s/server/cred/controller.kubeconfig; then stat -c permissions=%a /var/lib/rancher/k3s/server/cred/controller.kubeconfig; fi&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">permissions が644のパーミッションを持ち、期待されるパーミッションは644またはそれ以上に制限されている</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">permissions=644</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1118-コントローラーマネージャーconfファイルの所有者がrootに設定されていることを確認する自動化">1.1.18 コントローラーマネージャー.confファイルの所有者がroot<!-- -->:root<!-- -->に設定されていることを確認する（自動化）<a href="#1118-コントローラーマネージャーconfファイルの所有者がrootに設定されていることを確認する自動化" class="hash-link" aria-label="1118-コントローラーマネージャーconfファイルの所有者がrootに設定されていることを確認する自動化 への直接リンク" title="1118-コントローラーマネージャーconfファイルの所有者がrootに設定されていることを確認する自動化 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例えば、
chown root<!-- -->:root<!-- --> controllermanager</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">stat</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> %U:%G /var/lib/rancher/k3s/server/tls</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;root:root&#x27; が &#x27;root:root&#x27; と等しい</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root:root</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1119-kubernetes-pkiディレクトリおよびファイルの所有者がrootに設定されていることを確認する自動化">1.1.19 Kubernetes PKIディレクトリおよびファイルの所有者がroot<!-- -->:root<!-- -->に設定されていることを確認する（自動化）<a href="#1119-kubernetes-pkiディレクトリおよびファイルの所有者がrootに設定されていることを確認する自動化" class="hash-link" aria-label="1119-kubernetes-pkiディレクトリおよびファイルの所有者がrootに設定されていることを確認する自動化 への直接リンク" title="1119-kubernetes-pkiディレクトリおよびファイルの所有者がrootに設定されていることを確認する自動化 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例えば、
chown -R root<!-- -->:root<!-- --> /etc/kubernetes/pki/</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">find</span><span class="token plain"> /var/lib/rancher/k3s/server/tls </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">xargs</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">stat</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> %U:%G</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;root:root&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1120-kubernetes-pki証明書ファイルのパーミッションが644またはそれ以上に制限されていることを確認する手動">1.1.20 Kubernetes PKI証明書ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（手動）<a href="#1120-kubernetes-pki証明書ファイルのパーミッションが644またはそれ以上に制限されていることを確認する手動" class="hash-link" aria-label="1.1.20 Kubernetes PKI証明書ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（手動） への直接リンク" title="1.1.20 Kubernetes PKI証明書ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（手動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例えば、
chmod -R 644 /etc/kubernetes/pki/*.crt</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">stat</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> %n %a /var/lib/rancher/k3s/server/tls/*.crt</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1121-kubernetes-pkiキーのファイルパーミッションが600に設定されていることを確認する手動">1.1.21 Kubernetes PKIキーのファイルパーミッションが600に設定されていることを確認する（手動）<a href="#1121-kubernetes-pkiキーのファイルパーミッションが600に設定されていることを確認する手動" class="hash-link" aria-label="1.1.21 Kubernetes PKIキーのファイルパーミッションが600に設定されていることを確認する（手動） への直接リンク" title="1.1.21 Kubernetes PKIキーのファイルパーミッションが600に設定されていることを確認する（手動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例えば、
chmod -R 600 /etc/kubernetes/pki/*.key</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">stat</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> %n %a /var/lib/rancher/k3s/server/tls/*.key</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="12-apiサーバー">1.2 APIサーバー<a href="#12-apiサーバー" class="hash-link" aria-label="1.2 APIサーバー への直接リンク" title="1.2 APIサーバー への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="121---anonymous-auth引数がfalseに設定されていることを確認する手動">1.2.1 --anonymous-auth引数がfalseに設定されていることを確認する（手動）<a href="#121---anonymous-auth引数がfalseに設定されていることを確認する手動" class="hash-link" aria-label="1.2.1 --anonymous-auth引数がfalseに設定されていることを確認する（手動） への直接リンク" title="1.2.1 --anonymous-auth引数がfalseに設定されていることを確認する（手動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、以下のパラメータを設定します。
--anonymous-auth=false</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;anonymous-auth&#x27;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="122---token-auth-fileパラメータが設定されていないことを確認する自動化">1.2.2 --token-auth-fileパラメータが設定されていないことを確認する（自動化）<a href="#122---token-auth-fileパラメータが設定されていないことを確認する自動化" class="hash-link" aria-label="1.2.2 --token-auth-fileパラメータが設定されていないことを確認する（自動化） への直接リンク" title="1.2.2 --token-auth-fileパラメータが設定されていないことを確認する（自動化） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
ドキュメントに従って認証のための代替メカニズムを構成します。その後、コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、<code>--token-auth-file=&lt;filename&gt;</code> パラメータを削除します。</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/ps </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-ef</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> containerd </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--token-auth-file&#x27; が存在しない</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root 1616 1600 6 13:26 ? 00:01:28 containerd -c /var/lib/rancher/k3s/agent/etc/containerd/config.toml -a /run/k3s/containerd/containerd.sock --state /run/k3s/containerd --root /var/lib/rancher/k3s/agent/containerd root 2318 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id b41ec3297be4625c2406ad8b7b4f8b91cddd60850c420050c4c3273f809b3e7e -address /run/k3s/containerd/containerd.sock root 2341 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id e7999a65ae0a4e9969f32317ec48ae4f7071b62f92e5236696737973be77c2e1 -address /run/k3s/containerd/containerd.sock root 3199 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 90c4e63d6ee29d40a48c2fdaf2738c2472cba1139dde8a550466c452184f8528 -address /run/k3s/containerd/containerd.sock root 3923 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id be5f4b9bd1ed9239362b7000b47f353acb8bc8ca52a9c9145cba0e902ec1c4b9 -address /run/k3s/containerd/containerd.sock root 4559 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 04cd40ea6b6078797f177c902c89412c70e523ad2a687a62829bf1d16ff0e19c -address /run/k3s/containerd/containerd.sock root 4647 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 48f37a480315b6adce2d2a5c5d67a85412dd0ba7a2e82816434e0deb9fa75de9 -address /run/k3s/containerd/containerd.sock root 6610 1 0 13:47 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1cf71c22f568468055e517ab363437c0e54e45274c64024d337cc5bcce66341d -address /run/k3s/containerd/containerd.sock</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="123---denyserviceexternalipsが設定されていないことを確認する自動化">1.2.3 --DenyServiceExternalIPsが設定されていないことを確認する（自動化）<a href="#123---denyserviceexternalipsが設定されていないことを確認する自動化" class="hash-link" aria-label="1.2.3 --DenyServiceExternalIPsが設定されていないことを確認する（自動化） への直接リンク" title="1.2.3 --DenyServiceExternalIPsが設定されていないことを確認する（自動化） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、<code>DenyServiceExternalIPs</code> を有効なアドミッションプラグインから削除します。</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/ps </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-ef</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> containerd </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--enable-admission-plugins&#x27; が存在する または &#x27;--enable-admission-plugins&#x27; が存在しない</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root 1616 1600 6 13:26 ? 00:01:28 containerd -c /var/lib/rancher/k3s/agent/etc/containerd/config.toml -a /run/k3s/containerd/containerd.sock --state /run/k3s/containerd --root /var/lib/rancher/k3s/agent/containerd root 2318 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id b41ec3297be4625c2406ad8b7b4f8b91cddd60850c420050c4c3273f809b3e7e -address /run/k3s/containerd/containerd.sock root 2341 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id e7999a65ae0a4e9969f32317ec48ae4f7071b62f92e5236696737973be77c2e1 -address /run/k3s/containerd/containerd.sock root 3199 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 90c4e63d6ee29d40a48c2fdaf2738c2472cba1139dde8a550466c452184f8528 -address /run/k3s/containerd/containerd.sock root 3923 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id be5f4b9bd1ed9239362b7000b47f353acb8bc8ca52a9c9145cba0e902ec1c4b9 -address /run/k3s/containerd/containerd.sock root 4559 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 04cd40ea6b6078797f177c902c89412c70e523ad2a687a62829bf1d16ff0e19c -address /run/k3s/containerd/containerd.sock root 4647 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 48f37a480315b6adce2d2a5c5d67a85412dd0ba7a2e82816434e0deb9fa75de9 -address /run/k3s/containerd/containerd.sock root 6610 1 0 13:47 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1cf71c22f568468055e517ab363437c0e54e45274c64024d337cc5bcce66341d -address /run/k3s/containerd/containerd.sock</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="124---kubelet-https引数がtrueに設定されていることを確認する自動化">1.2.4 --kubelet-https引数がtrueに設定されていることを確認する（自動化）<a href="#124---kubelet-https引数がtrueに設定されていることを確認する自動化" class="hash-link" aria-label="1.2.4 --kubelet-https引数がtrueに設定されていることを確認する（自動化） への直接リンク" title="1.2.4 --kubelet-https引数がtrueに設定されていることを確認する（自動化） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 該当なし</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、--kubelet-httpsパラメータを削除します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="125---kubelet-client-certificateおよび--kubelet-client-key引数が適切に設定されていることを確認する自動化">1.2.5 --kubelet-client-certificateおよび--kubelet-client-key引数が適切に設定されていることを確認する（自動化）<a href="#125---kubelet-client-certificateおよび--kubelet-client-key引数が適切に設定されていることを確認する自動化" class="hash-link" aria-label="1.2.5 --kubelet-client-certificateおよび--kubelet-client-key引数が適切に設定されていることを確認する（自動化） への直接リンク" title="1.2.5 --kubelet-client-certificateおよび--kubelet-client-key引数が適切に設定されていることを確認する（自動化） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従って、apiserverとkubelets間のTLS接続を設定します。その後、コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、以下のようにkubeletクライアント証明書とキーのパラメータを設定します。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--kubelet-client-certificate=&lt;path/to/client-certificate-file&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--kubelet-client-key=&lt;path/to/client-key-file&gt;</span><br></span></code></pre></div></div>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;kubelet-certificate-authority&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--kubelet-client-certificate&#x27; が存在し、&#x27;--kubelet-client-key&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"></code></pre>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s</span><span class="token url-reference url punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token url-reference url variable" style="color:rgb(191, 199, 213)">1600</span><span class="token url-reference url punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token url-reference url punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token url-reference url" style="color:rgb(221, 221, 221)"> time=</span><span class="token url-reference url string" style="color:rgb(195, 232, 141)">&quot;2022-09-13T13:26:40Z&quot;</span><span class="token plain"> level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="126-ensure-that-the---kubelet-certificate-authority-argument-is-set-as-appropriate-automated">1.2.6 Ensure that the --kubelet-certificate-authority argument is set as appropriate (Automated)<a href="#126-ensure-that-the---kubelet-certificate-authority-argument-is-set-as-appropriate-automated" class="hash-link" aria-label="1.2.6 Ensure that the --kubelet-certificate-authority argument is set as appropriate (Automated) への直接リンク" title="1.2.6 Ensure that the --kubelet-certificate-authority argument is set as appropriate (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
Follow the Kubernetes documentation and setup the TLS connection between
the apiserver and kubelets. Then, edit the API server pod specification file
/etc/kubernetes/manifests/kube-apiserver.yaml on the control plane node and set the
--kubelet-certificate-authority parameter to the path to the cert file for the certificate authority
<code>--kubelet-certificate-authority=&lt;ca-string&gt;</code>.</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;kubelet-certificate-authority&#x27;</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--kubelet-certificate-authority&#x27; is present</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="127-ensure-that-the---authorization-mode-argument-is-not-set-to-alwaysallow-automated">1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow (Automated)<a href="#127-ensure-that-the---authorization-mode-argument-is-not-set-to-alwaysallow-automated" class="hash-link" aria-label="1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow (Automated) への直接リンク" title="1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
Edit the API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml
on the control plane node and set the --authorization-mode parameter to values other than AlwaysAllow.
One such example could be as below.
--authorization-mode=RBAC</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;authorization-mode&#x27;</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--authorization-mode&#x27; does not have &#x27;AlwaysAllow&#x27;</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="128-ensure-that-the---authorization-mode-argument-includes-node-automated">1.2.8 Ensure that the --authorization-mode argument includes Node (Automated)<a href="#128-ensure-that-the---authorization-mode-argument-includes-node-automated" class="hash-link" aria-label="1.2.8 Ensure that the --authorization-mode argument includes Node (Automated) への直接リンク" title="1.2.8 Ensure that the --authorization-mode argument includes Node (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
Edit the API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml
on the control plane node and set the --authorization-mode parameter to a value that includes Node.
--authorization-mode=Node,RBAC</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;authorization-mode&#x27;</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--authorization-mode&#x27; has &#x27;Node&#x27;</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"></code></pre>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s</span><span class="token url-reference url punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token url-reference url variable" style="color:rgb(191, 199, 213)">1600</span><span class="token url-reference url punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token url-reference url punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token url-reference url" style="color:rgb(221, 221, 221)"> time=</span><span class="token url-reference url string" style="color:rgb(195, 232, 141)">&quot;2022-09-13T13:26:40Z&quot;</span><span class="token plain"> level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="126-ensure-that-the---kubelet-certificate-authority-argument-is-set-as-appropriate-automated-1">1.2.6 Ensure that the --kubelet-certificate-authority argument is set as appropriate (Automated)<a href="#126-ensure-that-the---kubelet-certificate-authority-argument-is-set-as-appropriate-automated-1" class="hash-link" aria-label="1.2.6 Ensure that the --kubelet-certificate-authority argument is set as appropriate (Automated) への直接リンク" title="1.2.6 Ensure that the --kubelet-certificate-authority argument is set as appropriate (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
Follow the Kubernetes documentation and setup the TLS connection between
the apiserver and kubelets. Then, edit the API server pod specification file
/etc/kubernetes/manifests/kube-apiserver.yaml on the control plane node and set the
--kubelet-certificate-authority parameter to the path to the cert file for the certificate authority
<code>--kubelet-certificate-authority=&lt;ca-string&gt;</code>.</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;kubelet-certificate-authority&#x27;</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--kubelet-certificate-authority&#x27; is present</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="127-ensure-that-the---authorization-mode-argument-is-not-set-to-alwaysallow-automated-1">1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow (Automated)<a href="#127-ensure-that-the---authorization-mode-argument-is-not-set-to-alwaysallow-automated-1" class="hash-link" aria-label="1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow (Automated) への直接リンク" title="1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
Edit the API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml
on the control plane node and set the --authorization-mode</p>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s</span><span class="token url-reference url punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token url-reference url variable" style="color:rgb(191, 199, 213)">1600</span><span class="token url-reference url punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token url-reference url punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token url-reference url" style="color:rgb(221, 221, 221)"> time=</span><span class="token url-reference url string" style="color:rgb(195, 232, 141)">&quot;2022-09-13T13:26:40Z&quot;</span><span class="token plain"> level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="129-ensure-that-the---authorization-mode-argument-includes-rbac-automated">1.2.9 Ensure that the --authorization-mode argument includes RBAC (Automated)<a href="#129-ensure-that-the---authorization-mode-argument-includes-rbac-automated" class="hash-link" aria-label="1.2.9 Ensure that the --authorization-mode argument includes RBAC (Automated) への直接リンク" title="1.2.9 Ensure that the --authorization-mode argument includes RBAC (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、--authorization-mode パラメータをRBACを含む値に設定します。例えば <code>--authorization-mode=Node,RBAC</code>。</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;authorization-mode&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--authorization-mode&#x27; に &#x27;RBAC&#x27; が含まれている</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1210-ensure-that-the-admission-control-plugin-eventratelimit-is-set-manual">1.2.10 Ensure that the admission control plugin EventRateLimit is set (Manual)<a href="#1210-ensure-that-the-admission-control-plugin-eventratelimit-is-set-manual" class="hash-link" aria-label="1.2.10 Ensure that the admission control plugin EventRateLimit is set (Manual) への直接リンク" title="1.2.10 Ensure that the admission control plugin EventRateLimit is set (Manual) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、設定ファイルに希望する制限を設定します。その後、APIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、以下のパラメータを設定します。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--enable-admission-plugins=...,EventRateLimit,...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--admission-control-config-file=&lt;path/to/configuration/file&gt;</span><br></span></code></pre></div></div>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;enable-admission-plugins&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--enable-admission-plugins&#x27; に &#x27;EventRateLimit&#x27; が含まれている</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1211-ensure-that-the-admission-control-plugin-alwaysadmit-is-not-set-automated">1.2.11 Ensure that the admission control plugin AlwaysAdmit is not set (Automated)<a href="#1211-ensure-that-the-admission-control-plugin-alwaysadmit-is-not-set-automated" class="hash-link" aria-label="1.2.11 Ensure that the admission control plugin AlwaysAdmit is not set (Automated) への直接リンク" title="1.2.11 Ensure that the admission control plugin AlwaysAdmit is not set (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、--enable-admission-plugins パラメータを削除するか、AlwaysAdmitを含まない値に設定します。</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;enable-admission-plugins&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--enable-admission-plugins&#x27; に &#x27;AlwaysAdmit&#x27; が含まれていない または &#x27;--enable-admission-plugins&#x27; が存在しない</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"></code></pre>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">```markdown</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1212-ensure-that-the-admission-control-plugin-alwayspullimages-is-set-manual">1.2.12 Ensure that the admission control plugin AlwaysPullImages is set (Manual)<a href="#1212-ensure-that-the-admission-control-plugin-alwayspullimages-is-set-manual" class="hash-link" aria-label="1.2.12 Ensure that the admission control plugin AlwaysPullImages is set (Manual) への直接リンク" title="1.2.12 Ensure that the admission control plugin AlwaysPullImages is set (Manual) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> warn</p>
<p><strong>Remediation:</strong>
APIサーバーポッドの仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml をコントロールプレーンノードで編集し、--enable-admission-plugins パラメータに AlwaysPullImages を含めるように設定します。
--enable-admission-plugins=...,AlwaysPullImages,...</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/ps </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-ef</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> containerd </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--enable-admission-plugins&#x27; is present</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root 1616 1600 6 13:26 ? 00:01:28 containerd -c /var/lib/rancher/k3s/agent/etc/containerd/config.toml -a /run/k3s/containerd/containerd.sock --state /run/k3s/containerd --root /var/lib/rancher/k3s/agent/containerd root 2318 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id b41ec3297be4625c2406ad8b7b4f8b91cddd60850c420050c4c3273f809b3e7e -address /run/k3s/containerd/containerd.sock root 2341 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id e7999a65ae0a4e9969f32317ec48ae4f7071b62f92e5236696737973be77c2e1 -address /run/k3s/containerd/containerd.sock root 3199 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 90c4e63d6ee29d40a48c2fdaf2738c2472cba1139dde8a550466c452184f8528 -address /run/k3s/containerd/containerd.sock root 3923 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id be5f4b9bd1ed9239362b7000b47f353acb8bc8ca52a9c9145cba0e902ec1c4b9 -address /run/k3s/containerd/containerd.sock root 4559 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 04cd40ea6b6078797f177c902c89412c70e523ad2a687a62829bf1d16ff0e19c -address /run/k3s/containerd/containerd.sock root 4647 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 48f37a480315b6adce2d2a5c5d67a85412dd0ba7a2e82816434e0deb9fa75de9 -address /run/k3s/containerd/containerd.sock root 6610 1 0 13:47 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1cf71c22f568468055e517ab363437c0e54e45274c64024d337cc5bcce66341d -address /run/k3s/containerd/containerd.sock</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1213-ensure-that-the-admission-control-plugin-securitycontextdeny-is-set-if-podsecuritypolicy-is-not-used-manual">1.2.13 Ensure that the admission control plugin SecurityContextDeny is set if PodSecurityPolicy is not used (Manual)<a href="#1213-ensure-that-the-admission-control-plugin-securitycontextdeny-is-set-if-podsecuritypolicy-is-not-used-manual" class="hash-link" aria-label="1.2.13 Ensure that the admission control plugin SecurityContextDeny is set if PodSecurityPolicy is not used (Manual) への直接リンク" title="1.2.13 Ensure that the admission control plugin SecurityContextDeny is set if PodSecurityPolicy is not used (Manual) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> warn</p>
<p><strong>Remediation:</strong>
APIサーバーポッドの仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml をコントロールプレーンノードで編集し、--enable-admission-plugins パラメータに SecurityContextDeny を含めるように設定します。ただし、PodSecurityPolicy が既に設定されている場合は除きます。
--enable-admission-plugins=...,SecurityContextDeny,...</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;enable-admission-plugins&#x27;</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--enable-admission-plugins&#x27; has &#x27;SecurityContextDeny&#x27; OR &#x27;--enable-admission-plugins&#x27; has &#x27;PodSecurityPolicy&#x27;</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1214-ensure-that-the-admission-control-plugin-serviceaccount-is-set-automated">1.2.14 Ensure that the admission control plugin ServiceAccount is set (Automated)<a href="#1214-ensure-that-the-admission-control-plugin-serviceaccount-is-set-automated" class="hash-link" aria-label="1.2.14 Ensure that the admission control plugin ServiceAccount is set (Automated) への直接リンク" title="1.2.14 Ensure that the admission control plugin ServiceAccount is set (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
ドキュメントに従い、環境に応じて ServiceAccount オブジェクトを作成します。その後、APIサーバーポッドの仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml をコントロールプレーンノードで編集し、--disable-admission-plugins パラメータが ServiceAccount を含まない値に設定されていることを確認します。</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--disable-admission-plugins&#x27; is present OR &#x27;--disable-admission-plugins&#x27; is not present</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"></code></pre>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">```markdown</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1215-namespacelifecycle-アドミッションコントロールプラグインが設定されていることを確認する-自動化">1.2.15 NamespaceLifecycle アドミッションコントロールプラグインが設定されていることを確認する (自動化)<a href="#1215-namespacelifecycle-アドミッションコントロールプラグインが設定されていることを確認する-自動化" class="hash-link" aria-label="1.2.15 NamespaceLifecycle アドミッションコントロールプラグインが設定されていることを確認する (自動化) への直接リンク" title="1.2.15 NamespaceLifecycle アドミッションコントロールプラグインが設定されていることを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードの API サーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、--disable-admission-plugins パラメータを設定して NamespaceLifecycle が含まれていないことを確認します。</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--disable-admission-plugins&#x27; が存在するか &#x27;--disable-admission-plugins&#x27; が存在しない</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1216-noderestriction-アドミッションコントロールプラグインが設定されていることを確認する-自動化">1.2.16 NodeRestriction アドミッションコントロールプラグインが設定されていることを確認する (自動化)<a href="#1216-noderestriction-アドミッションコントロールプラグインが設定されていることを確認する-自動化" class="hash-link" aria-label="1.2.16 NodeRestriction アドミッションコントロールプラグインが設定されていることを確認する (自動化) への直接リンク" title="1.2.16 NodeRestriction アドミッションコントロールプラグインが設定されていることを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
Kubernetes のドキュメントに従い、kubelet に NodeRestriction プラグインを設定します。その後、コントロールプレーンノードの API サーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、--enable-admission-plugins パラメータに NodeRestriction を含む値を設定します。
--enable-admission-plugins=...,NodeRestriction,...</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;enable-admission-plugins&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--enable-admission-plugins&#x27; に &#x27;NodeRestriction&#x27; が含まれている</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1217---secure-port-引数が-0-に設定されていないことを確認する-自動化">1.2.17 --secure-port 引数が 0 に設定されていないことを確認する (自動化)<a href="#1217---secure-port-引数が-0-に設定されていないことを確認する-自動化" class="hash-link" aria-label="1.2.17 --secure-port 引数が 0 に設定されていないことを確認する (自動化) への直接リンク" title="1.2.17 --secure-port 引数が 0 に設定されていないことを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードの API サーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、--secure-port パラメータを削除するか、0 以外の異なるポートに設定します。</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;secure-port&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--secure-port&#x27; が 0 より大きいか &#x27;--secure-port&#x27; が存在しない</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"></code></pre>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">```markdown</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1218---profiling-引数が-false-に設定されていることを確認する-自動化">1.2.18 --profiling 引数が false に設定されていることを確認する (自動化)<a href="#1218---profiling-引数が-false-に設定されていることを確認する-自動化" class="hash-link" aria-label="1.2.18 --profiling 引数が false に設定されていることを確認する (自動化) への直接リンク" title="1.2.18 --profiling 引数が false に設定されていることを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、以下のパラメータを設定します。
--profiling=false</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;profiling&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--profiling&#x27; が &#x27;false&#x27; に等しい</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1219---audit-log-path-引数が設定されていることを確認する-自動化">1.2.19 --audit-log-path 引数が設定されていることを確認する (自動化)<a href="#1219---audit-log-path-引数が設定されていることを確認する-自動化" class="hash-link" aria-label="1.2.19 --audit-log-path 引数が設定されていることを確認する (自動化) への直接リンク" title="1.2.19 --audit-log-path 引数が設定されていることを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 該当なし</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、--audit-log-path パラメータを適切なパスとファイルに設定します。例えば、
--audit-log-path=/var/log/apiserver/audit.log</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1220---audit-log-maxage-引数が-30-または適切な値に設定されていることを確認する-自動化">1.2.20 --audit-log-maxage 引数が 30 または適切な値に設定されていることを確認する (自動化)<a href="#1220---audit-log-maxage-引数が-30-または適切な値に設定されていることを確認する-自動化" class="hash-link" aria-label="1.2.20 --audit-log-maxage 引数が 30 または適切な値に設定されていることを確認する (自動化) への直接リンク" title="1.2.20 --audit-log-maxage 引数が 30 または適切な値に設定されていることを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 該当なし</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、--audit-log-maxage パラメータを 30 または適切な日数に設定します。例えば、
--audit-log-maxage=30</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1221---audit-log-maxbackup-引数が-10-または適切な値に設定されていることを確認する-自動化">1.2.21 --audit-log-maxbackup 引数が 10 または適切な値に設定されていることを確認する (自動化)<a href="#1221---audit-log-maxbackup-引数が-10-または適切な値に設定されていることを確認する-自動化" class="hash-link" aria-label="1.2.21 --audit-log-maxbackup 引数が 10 または適切な値に設定されていることを確認する (自動化) への直接リンク" title="1.2.21 --audit-log-maxbackup 引数が 10 または適切な値に設定されていることを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 該当なし</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、--audit-log-maxbackup パラメータを 10 または適切な値に設定します。例えば、
--audit-log-maxbackup=10</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1222---audit-log-maxsize-引数が-100-または適切な値に設定されていることを確認する-自動化">1.2.22 --audit-log-maxsize 引数が 100 または適切な値に設定されていることを確認する (自動化)<a href="#1222---audit-log-maxsize-引数が-100-または適切な値に設定されていることを確認する-自動化" class="hash-link" aria-label="1.2.22 --audit-log-maxsize 引数が 100 または適切な値に設定されていることを確認する (自動化) への直接リンク" title="1.2.22 --audit-log-maxsize 引数が 100 または適切な値に設定されていることを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 該当なし</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、--audit-log-maxsize パラメータを適切なサイズ（MB単位）に設定します。例えば、100 MB に設定する場合、
--audit-log-maxsize=100</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1224---service-account-lookup-引数が-true-に設定されていることを確認する-自動化">1.2.24 --service-account-lookup 引数が true に設定されていることを確認する (自動化)<a href="#1224---service-account-lookup-引数が-true-に設定されていることを確認する-自動化" class="hash-link" aria-label="1.2.24 --service-account-lookup 引数が true に設定されていることを確認する (自動化) への直接リンク" title="1.2.24 --service-account-lookup 引数が true に設定されていることを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、以下のパラメータを設定します。
--service-account-lookup=true
または、このファイルから --service-account-lookup パラメータを削除してデフォルトを有効にします。</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--service-account-lookup&#x27; が存在しない、または &#x27;--service-account-lookup&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1225---request-timeout-引数が適切に設定されていることを確認する-自動化">1.2.25 --request-timeout 引数が適切に設定されていることを確認する (自動化)<a href="#1225---request-timeout-引数が適切に設定されていることを確認する-自動化" class="hash-link" aria-label="1.2.25 --request-timeout 引数が適切に設定されていることを確認する (自動化) への直接リンク" title="1.2.25 --request-timeout 引数が適切に設定されていることを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 該当なし</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、--service-account-key-file パラメータをサービスアカウントの公開鍵ファイルに設定します。例えば、
<code>--service-account-key-file=&lt;filename&gt;</code>。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1226---etcd-certfile-および---etcd-keyfile-引数が適切に設定されていることを確認する-自動化">1.2.26 --etcd-certfile および --etcd-keyfile 引数が適切に設定されていることを確認する (自動化)<a href="#1226---etcd-certfile-および---etcd-keyfile-引数が適切に設定されていることを確認する-自動化" class="hash-link" aria-label="1.2.26 --etcd-certfile および --etcd-keyfile 引数が適切に設定されていることを確認する (自動化) への直接リンク" title="1.2.26 --etcd-certfile および --etcd-keyfile 引数が適切に設定されていることを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
Kubernetes のドキュメントに従って、apiserver と etcd 間の TLS 接続を設定します。その後、コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、etcd 証明書および鍵ファイルのパラメータを設定します。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--etcd-certfile=&lt;path/to/client-certificate-file&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--etcd-keyfile=&lt;path/to/client-key-file&gt;</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">**監査スクリプト:** `check_for_k3s_etcd.sh`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">```bash</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># このスクリプトは、k3sが実際にetcdを実行していること（sqlite3などの他のデータベースではないこと）を確認するために使用されます。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># 要件を確認する前に</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set -eE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">handle_error() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    echo &quot;false&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">trap &#x27;handle_error&#x27; ERR</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if [[ &quot;$(journalctl -D /var/log/journal -u k3s | grep &#x27;Managed etcd cluster initializing&#x27; | grep -v grep | wc -l)&quot; -gt 0 ]]; then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    case $1 in </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;1.1.11&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(stat -c %a /var/lib/rancher/k3s/server/db/etcd);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;1.2.29&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(journalctl -D /var/log/journal -u k3s | grep &#x27;Running kube-apiserver&#x27; | tail -n1 | grep &#x27;etcd-&#x27;);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.1&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep -A 5 &#x27;client-transport-security&#x27; /var/lib/rancher/k3s/server/db/etcd/config | grep -E &#x27;cert-file|key-file&#x27;);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.2&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep -A 5 &#x27;client-transport-security&#x27; /var/lib/rancher/k3s/server/db/etcd/config | grep &#x27;client-cert-auth&#x27;);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.3&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep &#x27;auto-tls&#x27; /var/lib/rancher/k3s/server/db/etcd/config);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.4&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep -A 5 &#x27;peer-transport-security&#x27; /var/lib/rancher/k3s/server/db/etcd/config | grep -E &#x27;cert-file|key-file&#x27;);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.5&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep -A 5 &#x27;peer-transport-security&#x27; /var/lib/rancher/k3s/server/db/etcd/config | grep &#x27;client-cert-auth&#x27;);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.6&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep &#x27;peer-auto-tls&#x27; /var/lib/rancher/k3s/server/db/etcd/config);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.7&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo $(grep &#x27;trusted-ca-file&#x27; /var/lib/rancher/k3s/server/db/etcd/config);;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    esac</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">else</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># 別のデータベースが実行されている場合、スキャンを通過するために必要なものを返します</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    case $1 in</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;1.1.11&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;700&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;1.2.29&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--etcd-certfile AND --etcd-keyfile&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.1&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;cert-file AND key-file&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.2&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--client-cert-auth=true&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.3&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;false&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.4&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;peer-cert-file AND peer-key-file&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.5&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--client-cert-auth=true&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.6&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--peer-auto-tls=false&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.7&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--trusted-ca-file&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    esac</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><strong>監査実行:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">./check_for_k3s_etcd.sh </span><span class="token number" style="color:rgb(247, 140, 108)">1.2</span><span class="token plain">.29</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--etcd-certfile&#x27; が存在し、&#x27;--etcd-keyfile&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--etcd-certfile AND --etcd-keyfile</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1227---tls-cert-file-および---tls-private-key-file-引数が適切に設定されていることを確認する-自動化">1.2.27 <code>--tls-cert-file</code> および <code>--tls-private-key-file</code> 引数が適切に設定されていることを確認する (自動化)<a href="#1227---tls-cert-file-および---tls-private-key-file-引数が適切に設定されていることを確認する-自動化" class="hash-link" aria-label="1227---tls-cert-file-および---tls-private-key-file-引数が適切に設定されていることを確認する-自動化 への直接リンク" title="1227---tls-cert-file-および---tls-private-key-file-引数が適切に設定されていることを確認する-自動化 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、apiserverでTLS接続を設定します。
次に、コントロールプレーンノードのAPIサーバーポッド仕様ファイル <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> を編集し、TLS証明書および秘密鍵ファイルのパラメータを設定します。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--tls-cert-file=&lt;path/to/tls-certificate-file&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--tls-private-key-file=&lt;path/to/tls-key-file&gt;</span><br></span></code></pre></div></div>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-A1</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n2</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--tls-cert-file&#x27; が存在し、&#x27;--tls-private-key-file&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot; Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-scheduler --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-scheduler --kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --profiling=false --secure-port=10259&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1228---client-ca-file-引数が適切に設定されていることを確認する-自動化">1.2.28 <code>--client-ca-file</code> 引数が適切に設定されていることを確認する (自動化)<a href="#1228---client-ca-file-引数が適切に設定されていることを確認する-自動化" class="hash-link" aria-label="1228---client-ca-file-引数が適切に設定されていることを確認する-自動化 への直接リンク" title="1228---client-ca-file-引数が適切に設定されていることを確認する-自動化 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、apiserverでTLS接続を設定します。
次に、コントロールプレーンノードのAPIサーバーポッド仕様ファイル <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> を編集し、クライアント証明書認証局ファイルを設定します。
<code>--client-ca-file=&lt;path/to/client-ca-file&gt;</code></p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;client-ca-file&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--client-ca-file&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1229---etcd-cafile-引数が適切に設定されていることを確認する-自動化">1.2.29 <code>--etcd-cafile</code> 引数が適切に設定されていることを確認する (自動化)<a href="#1229---etcd-cafile-引数が適切に設定されていることを確認する-自動化" class="hash-link" aria-label="1229---etcd-cafile-引数が適切に設定されていることを確認する-自動化 への直接リンク" title="1229---etcd-cafile-引数が適切に設定されていることを確認する-自動化 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、apiserverとetcd間のTLS接続を設定します。
次に、コントロールプレーンノードのAPIサーバーポッド仕様ファイル <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> を編集し、etcd証明書認証局ファイルのパラメータを設定します。
<code>--etcd-cafile=&lt;path/to/ca-file&gt;</code></p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;etcd-cafile&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--etcd-cafile&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"></code></pre>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s</span><span class="token url-reference url punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token url-reference url variable" style="color:rgb(191, 199, 213)">1600</span><span class="token url-reference url punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token url-reference url punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token url-reference url" style="color:rgb(221, 221, 221)"> time=</span><span class="token url-reference url string" style="color:rgb(195, 232, 141)">&quot;2022-09-13T13:26:40Z&quot;</span><span class="token plain"> level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1230-ensure-that-the---encryption-provider-config-argument-is-set-as-appropriate-manual">1.2.30 Ensure that the --encryption-provider-config argument is set as appropriate (Manual)<a href="#1230-ensure-that-the---encryption-provider-config-argument-is-set-as-appropriate-manual" class="hash-link" aria-label="1.2.30 Ensure that the --encryption-provider-config argument is set as appropriate (Manual) への直接リンク" title="1.2.30 Ensure that the --encryption-provider-config argument is set as appropriate (Manual) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> warn</p>
<p><strong>Remediation:</strong>
Follow the Kubernetes documentation and configure a EncryptionConfig file.
Then, edit the API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml
on the control plane node and set the --encryption-provider-config parameter to the path of that file.
For example, <code>--encryption-provider-config=&lt;/path/to/EncryptionConfig/File&gt;</code></p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;encryption-provider-config&#x27;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1231-ensure-that-encryption-providers-are-appropriately-configured-manual">1.2.31 Ensure that encryption providers are appropriately configured (Manual)<a href="#1231-ensure-that-encryption-providers-are-appropriately-configured-manual" class="hash-link" aria-label="1.2.31 Ensure that encryption providers are appropriately configured (Manual) への直接リンク" title="1.2.31 Ensure that encryption providers are appropriately configured (Manual) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> warn</p>
<p><strong>Remediation:</strong>
Follow the Kubernetes documentation and configure a EncryptionConfig file.
In this file, choose aescbc, kms or secretbox as the encryption provider.</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> aescbc /path/to/encryption-config.json</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1232-ensure-that-the-api-server-only-makes-use-of-strong-cryptographic-ciphers-manual">1.2.32 Ensure that the API Server only makes use of Strong Cryptographic Ciphers (Manual)<a href="#1232-ensure-that-the-api-server-only-makes-use-of-strong-cryptographic-ciphers-manual" class="hash-link" aria-label="1.2.32 Ensure that the API Server only makes use of Strong Cryptographic Ciphers (Manual) への直接リンク" title="1.2.32 Ensure that the API Server only makes use of Strong Cryptographic Ciphers (Manual) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> warn</p>
<p><strong>Remediation:</strong>
Edit the API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml
on the control plane node and set the below parameter.
--tls-cipher-suites=TLS_AES_128_GCM_SHA256,TLS_AES_256_GCM_SHA384,TLS_CHACHA20_POLY1305_SHA256,
TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,
TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,
TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,
TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,
TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,
TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256,TLS_RSA_WITH_3DES_EDE_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA,
TLS_RSA_WITH_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_CBC_SHA,TLS_RSA_WITH_AES_256_GCM_SHA384</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;tls-cipher-suites&#x27;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="13-controller-manager">1.3 Controller Manager<a href="#13-controller-manager" class="hash-link" aria-label="1.3 Controller Manager への直接リンク" title="1.3 Controller Manager への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="131-ensure-that-the---terminated-pod-gc-threshold-argument-is-set-as-appropriate-manual">1.3.1 Ensure that the --terminated-pod-gc-threshold argument is set as appropriate (Manual)<a href="#131-ensure-that-the---terminated-pod-gc-threshold-argument-is-set-as-appropriate-manual" class="hash-link" aria-label="1.3.1 Ensure that the --terminated-pod-gc-threshold argument is set as appropriate (Manual) への直接リンク" title="1.3.1 Ensure that the --terminated-pod-gc-threshold argument is set as appropriate (Manual) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> warn</p>
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node and set the --terminated-pod-gc-threshold to an appropriate threshold,
for example, --terminated-pod-gc-threshold=10</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-controller-manager&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;terminated-pod-gc-threshold&#x27;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="132-ensure-that-the---profiling-argument-is-set-to-false-automated">1.3.2 Ensure that the --profiling argument is set to false (Automated)<a href="#132-ensure-that-the---profiling-argument-is-set-to-false-automated" class="hash-link" aria-label="1.3.2 Ensure that the --profiling argument is set to false (Automated) への直接リンク" title="1.3.2 Ensure that the --profiling argument is set to false (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node and set the below parameter.
--profiling=false</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-controller-manager&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;profiling&#x27;</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--profiling&#x27; is equal to &#x27;false&#x27;</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-controller-manager --cluster-cidr=10.42.0.0/16 --cluster-signing-kube-apiserver-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kube-apiserver-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kubelet-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-serving-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-kubelet-serving-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --cluster-signing-legacy-unknown-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-legacy-unknown-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --configure-cloud-routes=false --controllers=*,-service,-route,-cloud-node-lifecycle --feature-gates=JobTrackingWithFinalizers=true --kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --profiling=false --root-ca-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --secure-port=10257 --service-account-private-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --use-service-account-credentials=true&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="133-ensure-that-the---use-service-account-credentials-argument-is-set-to-true-automated">1.3.3 Ensure that the --use-service-account-credentials argument is set to true (Automated)<a href="#133-ensure-that-the---use-service-account-credentials-argument-is-set-to-true-automated" class="hash-link" aria-label="1.3.3 Ensure that the --use-service-account-credentials argument is set to true (Automated) への直接リンク" title="1.3.3 Ensure that the --use-service-account-credentials argument is set to true (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node to set the below parameter.
--use-service-account-credentials=true</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-controller-manager&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;use-service-account-credentials&#x27;</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--use-service-account-credentials&#x27; is not equal to &#x27;false&#x27;</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-controller-manager --cluster-cidr=10.42.0.0/16 --cluster-signing-kube-apiserver-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kube-apiserver-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kubelet-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-serving-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-kubelet-serving-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --cluster-signing-legacy-unknown-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-legacy-unknown-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --configure-cloud-routes=false --controllers=*,-service,-route,-cloud-node-lifecycle --feature-gates=JobTrackingWithFinalizers=true --kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --profiling=false --root-ca-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --secure-port=10257 --service-account-private-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --use-service-account-credentials=true&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="134-ensure-that-the---service-account-private-key-file-argument-is-set-as-appropriate-automated">1.3.4 Ensure that the --service-account-private-key-file argument is set as appropriate (Automated)<a href="#134-ensure-that-the---service-account-private-key-file-argument-is-set-as-appropriate-automated" class="hash-link" aria-label="1.3.4 Ensure that the --service-account-private-key-file argument is set as appropriate (Automated) への直接リンク" title="1.3.4 Ensure that the --service-account-private-key-file argument is set as appropriate (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node and set the --service-account-private-key-file parameter
to the private key file for service accounts. For example,
<code>--service-account-private-key-file=&lt;filename&gt;</code>.</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-controller-manager&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;service-account-private-key-file&#x27;</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--service-account-private-key-file&#x27; is present</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"></code></pre>
<div class="language-markdown codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-markdown codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token title important punctuation" style="color:rgb(199, 146, 234)">###</span><span class="token title important"> 1.2.30 適切に設定された --encryption-provider-config 引数を確認する (手動)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">結果:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"> 警告</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">修正方法:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Kubernetesのドキュメントに従い、EncryptionConfigファイルを設定します。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">次に、コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--encryption-provider-config パラメータをそのファイルのパスに設定します。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例: </span><span class="token code-snippet code keyword" style="font-style:italic">`--encryption-provider-config=&lt;/path/to/EncryptionConfig/File&gt;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token bold content">監査:</span><span class="token bold punctuation" style="color:rgb(199, 146, 234)">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">```bash</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl -D /var/log/journal -u k3s | grep &#x27;Running kube-apiserver&#x27; | tail -n1 | grep &#x27;encryption-provider-config&#x27;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1231-適切に設定された暗号化プロバイダーを確認する-手動">1.2.31 適切に設定された暗号化プロバイダーを確認する (手動)<a href="#1231-適切に設定された暗号化プロバイダーを確認する-手動" class="hash-link" aria-label="1.2.31 適切に設定された暗号化プロバイダーを確認する (手動) への直接リンク" title="1.2.31 適切に設定された暗号化プロバイダーを確認する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、EncryptionConfigファイルを設定します。
このファイルで、暗号化プロバイダーとしてaescbc、kms、またはsecretboxを選択します。</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> aescbc /path/to/encryption-config.json</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1232-apiサーバーが強力な暗号化スイートのみを使用していることを確認する-手動">1.2.32 APIサーバーが強力な暗号化スイートのみを使用していることを確認する (手動)<a href="#1232-apiサーバーが強力な暗号化スイートのみを使用していることを確認する-手動" class="hash-link" aria-label="1.2.32 APIサーバーが強力な暗号化スイートのみを使用していることを確認する (手動) への直接リンク" title="1.2.32 APIサーバーが強力な暗号化スイートのみを使用していることを確認する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、
以下のパラメータを設定します。
--tls-cipher-suites=TLS_AES_128_GCM_SHA256,TLS_AES_256_GCM_SHA384,TLS_CHACHA20_POLY1305_SHA256,
TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,
TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,
TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,
TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,
TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,
TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256,TLS_RSA_WITH_3DES_EDE_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA,
TLS_RSA_WITH_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_CBC_SHA,TLS_RSA_WITH_AES_256_GCM_SHA384</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;tls-cipher-suites&#x27;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="13-コントローラーマネージャー">1.3 コントローラーマネージャー<a href="#13-コントローラーマネージャー" class="hash-link" aria-label="1.3 コントローラーマネージャー への直接リンク" title="1.3 コントローラーマネージャー への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="131-適切に設定された---terminated-pod-gc-threshold-引数を確認する-手動">1.3.1 適切に設定された --terminated-pod-gc-threshold 引数を確認する (手動)<a href="#131-適切に設定された---terminated-pod-gc-threshold-引数を確認する-手動" class="hash-link" aria-label="1.3.1 適切に設定された --terminated-pod-gc-threshold 引数を確認する (手動) への直接リンク" title="1.3.1 適切に設定された --terminated-pod-gc-threshold 引数を確認する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードのコントローラーマネージャーポッド仕様ファイル /etc/kubernetes/manifests/kube-controller-manager.yaml を編集し、
--terminated-pod-gc-threshold を適切な閾値に設定します。
例: --terminated-pod-gc-threshold=10</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-controller-manager&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;terminated-pod-gc-threshold&#x27;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="132---profiling-引数が-false-に設定されていることを確認する-自動">1.3.2 --profiling 引数が false に設定されていることを確認する (自動)<a href="#132---profiling-引数が-false-に設定されていることを確認する-自動" class="hash-link" aria-label="1.3.2 --profiling 引数が false に設定されていることを確認する (自動) への直接リンク" title="1.3.2 --profiling 引数が false に設定されていることを確認する (自動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
コントロールプレーンノードのコントローラーマネージャーポッド仕様ファイル /etc/kubernetes/manifests/kube-controller-manager.yaml を編集し、
以下のパラメータを設定します。
--profiling=false</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-controller-manager&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;profiling&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--profiling&#x27; が &#x27;false&#x27; に等しい</span><br></span></code></pre></div></div>
<p><strong>返された値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-controller-manager --cluster-cidr=10.42.0.0/16</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">```markdown</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-controller-manager --cluster-cidr=10.42.0.0/16 --cluster-signing-kube-apiserver-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kube-apiserver-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kubelet-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-serving-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-kubelet-serving-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --cluster-signing-legacy-unknown-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-legacy-unknown-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --configure-cloud-routes=false --controllers=*,-service,-route,-cloud-node-lifecycle --feature-gates=JobTrackingWithFinalizers=true --kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --profiling=false --root-ca-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --secure-port=10257 --service-account-private-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --use-service-account-credentials=true&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="135-ensure-that-the---root-ca-file-argument-is-set-as-appropriate-automated">1.3.5 Ensure that the --root-ca-file argument is set as appropriate (Automated)<a href="#135-ensure-that-the---root-ca-file-argument-is-set-as-appropriate-automated" class="hash-link" aria-label="1.3.5 Ensure that the --root-ca-file argument is set as appropriate (Automated) への直接リンク" title="1.3.5 Ensure that the --root-ca-file argument is set as appropriate (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node and set the --root-ca-file parameter to the certificate bundle file.
<code>--root-ca-file=&lt;path/to/file&gt;</code></p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-controller-manager&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;root-ca-file&#x27;</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--root-ca-file&#x27; is present</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-controller-manager --cluster-cidr=10.42.0.0/16 --cluster-signing-kube-apiserver-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kube-apiserver-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kubelet-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-serving-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-kubelet-serving-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --cluster-signing-legacy-unknown-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-legacy-unknown-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --configure-cloud-routes=false --controllers=*,-service,-route,-cloud-node-lifecycle --feature-gates=JobTrackingWithFinalizers=true --kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --profiling=false --root-ca-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --secure-port=10257 --service-account-private-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --use-service-account-credentials=true&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="136-ensure-that-the-rotatekubeletservercertificate-argument-is-set-to-true-automated">1.3.6 Ensure that the RotateKubeletServerCertificate argument is set to true (Automated)<a href="#136-ensure-that-the-rotatekubeletservercertificate-argument-is-set-to-true-automated" class="hash-link" aria-label="1.3.6 Ensure that the RotateKubeletServerCertificate argument is set to true (Automated) への直接リンク" title="1.3.6 Ensure that the RotateKubeletServerCertificate argument is set to true (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> Not Applicable</p>
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node and set the --feature-gates parameter to include RotateKubeletServerCertificate=true.
--feature-gates=RotateKubeletServerCertificate=true</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="137-ensure-that-the---bind-address-argument-is-set-to-127001-automated">1.3.7 Ensure that the --bind-address argument is set to 127.0.0.1 (Automated)<a href="#137-ensure-that-the---bind-address-argument-is-set-to-127001-automated" class="hash-link" aria-label="1.3.7 Ensure that the --bind-address argument is set to 127.0.0.1 (Automated) への直接リンク" title="1.3.7 Ensure that the --bind-address argument is set to 127.0.0.1 (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node and ensure the correct value for the --bind-address parameter</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/ps </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-ef</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> containerd </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--bind-address&#x27; is present OR &#x27;--bind-address&#x27; is not present</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root 1616 1600 6 13:26 ? 00:01:28 containerd -c /var/lib/rancher/k3s/agent/etc/containerd/config.toml -a /run/k3s/containerd/containerd.sock --state /run/k3s/containerd --root /var/lib/rancher/k3s/agent/containerd root 2318 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id b41ec3297be4625c2406ad8b7b4f8b91cddd60850c420050c4c3273f809b3e7e -address /run/k3s/containerd/containerd.sock root 2341 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id e7999a65ae0a4e9969f32317ec48ae4f7071b62f92e5236696737973be77c2e1 -address /run/k3s/containerd/containerd.sock root 3199 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 90c4e63d6ee29d40a48c2fdaf2738c2472cba1139dde8a550466c452184f8528 -address /run/k3s/containerd/containerd.sock root 3923 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id be5f4b9bd1ed9239362b7000b47f353acb8bc8ca52a9c9145cba0e902ec1c4b9 -address /run/k3s/containerd/containerd.sock root 4559 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 04cd40ea6b6078797f177c902c89412c70e523ad2a687a62829bf1d16ff0e19c -address /run/k3s/containerd/containerd.sock root 4647 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 48f37a480315b6adce2d2a5c5d67a85412dd0ba7a2e82816434e0deb9fa75de9 -address /run/k3s/containerd/containerd.sock root 6610 1 0 13:47 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1cf71c22f568468055e517ab363437c0e54e45274c64024d337cc5bcce66341d -address /run/k3s/containerd/containerd.sock</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="14-scheduler">1.4 Scheduler<a href="#14-scheduler" class="hash-link" aria-label="1.4 Scheduler への直接リンク" title="1.4 Scheduler への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="141-ensure-that-the---profiling-argument-is-set-to-false-automated">1.4.1 Ensure that the --profiling argument is set to false (Automated)<a href="#141-ensure-that-the---profiling-argument-is-set-to-false-automated" class="hash-link" aria-label="1.4.1 Ensure that the --profiling argument is set to false (Automated) への直接リンク" title="1.4.1 Ensure that the --profiling argument is set to false (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
Edit the Scheduler pod specification file /etc/kubernetes/manifests/kube-scheduler.yaml file
on the control plane node and set the below parameter.
--profiling=false</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-scheduler&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--profiling&#x27; is equal to &#x27;false&#x27;</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-scheduler --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-scheduler --kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --profiling=false --secure-port=10259&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="142-ensure-that-the---bind-address-argument-is-set-to-127001-automated">1.4.2 Ensure that the --bind-address argument is set to 127.0.0.1 (Automated)<a href="#142-ensure-that-the---bind-address-argument-is-set-to-127001-automated" class="hash-link" aria-label="1.4.2 Ensure that the --bind-address argument is set to 127.0.0.1 (Automated) への直接リンク" title="1.4.2 Ensure that the --bind-address argument is set to 127.0.0.1 (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
Edit the Scheduler pod specification file /etc/kubernetes/manifests/kube-scheduler.yaml
on the control plane node and ensure the correct value for the --bind-address parameter</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-scheduler&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;bind-address&#x27;</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--bind-address&#x27; is equal to &#x27;127.0.0.1&#x27; OR &#x27;--bind-address&#x27; is not present</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-scheduler --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-scheduler --kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --profiling=false --secure-port=10259&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-etcd-node-configuration">2 Etcd Node Configuration<a href="#2-etcd-node-configuration" class="hash-link" aria-label="2 Etcd Node Configuration への直接リンク" title="2 Etcd Node Configuration への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="21-ensure-that-the---cert-file-and---key-file-arguments-are-set-as-appropriate-automated">2.1 Ensure that the --cert-file and --key-file arguments are set as appropriate (Automated)<a href="#21-ensure-that-the---cert-file-and---key-file-arguments-are-set-as-appropriate-automated" class="hash-link" aria-label="2.1 Ensure that the --cert-file and --key-file arguments are set as appropriate (Automated) への直接リンク" title="2.1 Ensure that the --cert-file and --key-file arguments are set as appropriate (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
Follow the etcd service documentation and configure TLS encryption.
Then, edit the etcd pod specification file /etc/kubernetes/manifests/etcd.yaml
on the master node and set the below parameters.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--cert-file=&lt;/path/to/ca-file&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--key-file=&lt;/path/to/key-file&gt;</span><br></span></code></pre></div></div>
<p><strong>Audit Script:</strong> <code>check_for_k3s_etcd.sh</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># This script is used to ensure that k3s is actually running etcd (and not other databases like sqlite3)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># before it checks the requirement</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">set</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-eE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function-name function" style="color:rgb(130, 170, 255)">handle_error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">trap</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;handle_error&#x27;</span><span class="token plain"> ERR</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">$(</span><span class="token string variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token string variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token string variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable string" style="color:rgb(195, 232, 141)">&#x27;Managed etcd cluster initializing&#x27;</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">wc</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-l</span><span class="token string variable" style="color:rgb(191, 199, 213)">)</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-gt</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.11&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">stat</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token variable" style="color:rgb(191, 199, 213)"> %a /var/lib/rancher/k3s/server/db/etcd</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2.29&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">tail</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;etcd-&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">```bash</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;cert-file AND key-file&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.2&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--client-cert-auth=true&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.3&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;false&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.4&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;peer-cert-file AND peer-key-file&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.5&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--client-cert-auth=true&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.6&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--peer-auto-tls=false&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;2.7&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            echo &quot;--trusted-ca-file&quot;;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    esac</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><strong>監査実行:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">./check_for_k3s_etcd.sh </span><span class="token number" style="color:rgb(247, 140, 108)">2.1</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;cert-file&#x27; が存在し、かつ &#x27;key-file&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cert-file AND key-file cert-file: /var/lib/rancher/k3s/server/tls/etcd/server-client.crt key-file: /var/lib/rancher/k3s/server/tls/etcd/server-client.key cert-file AND key-file</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="22---client-cert-auth-引数が-true-に設定されていることを確認する-自動化">2.2 --client-cert-auth 引数が true に設定されていることを確認する (自動化)<a href="#22---client-cert-auth-引数が-true-に設定されていることを確認する-自動化" class="hash-link" aria-label="2.2 --client-cert-auth 引数が true に設定されていることを確認する (自動化) への直接リンク" title="2.2 --client-cert-auth 引数が true に設定されていることを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
マスターノードの etcd ポッド仕様ファイル /etc/kubernetes/manifests/etcd.yaml を編集し、以下のパラメータを設定します。
--client-cert-auth=&quot;true&quot;</p>
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># このスクリプトは、k3s が実際に etcd を実行していること（sqlite3 などの他のデータベースではないこと）を確認するために使用されます</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 要件を確認する前に</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">set</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-eE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function-name function" style="color:rgb(130, 170, 255)">handle_error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">trap</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;handle_error&#x27;</span><span class="token plain"> ERR</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">$(</span><span class="token string variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token string variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token string variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable string" style="color:rgb(195, 232, 141)">&#x27;Managed etcd cluster initializing&#x27;</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">wc</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-l</span><span class="token string variable" style="color:rgb(191, 199, 213)">)</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-gt</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.11&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">stat</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token variable" style="color:rgb(191, 199, 213)"> %a /var/lib/rancher/k3s/server/db/etcd</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2.29&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">tail</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;etcd-&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-E</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;cert-file|key-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-cert-auth&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;auto-tls&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-E</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;cert-file|key-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.5&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-cert-auth&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.6&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-auto-tls&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.7&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;trusted-ca-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 別のデータベースが実行されている場合、スキャンを通過するために必要なものを返します</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.11&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;700&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2.29&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--etcd-certfile AND --etcd-keyfile&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cert-file AND key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;peer-cert-file AND peer-key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.5&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.6&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--peer-auto-tls=false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.7&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--trusted-ca-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><strong>監査実行:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">./check_for_k3s_etcd.sh </span><span class="token number" style="color:rgb(247, 140, 108)">2.2</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--client-cert-auth&#x27; が存在する、または &#x27;client-cert-auth&#x27; が &#x27;true&#x27; に等しい</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--client-cert-auth=true client-cert-auth: true --client-cert-auth=true</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="23---auto-tls-引数が-true-に設定されていないことを確認する-自動化">2.3 --auto-tls 引数が true に設定されていないことを確認する (自動化)<a href="#23---auto-tls-引数が-true-に設定されていないことを確認する-自動化" class="hash-link" aria-label="2.3 --auto-tls 引数が true に設定されていないことを確認する (自動化) への直接リンク" title="2.3 --auto-tls 引数が true に設定されていないことを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
マスターノードの etcd ポッド仕様ファイル /etc/kubernetes/manifests/etcd.yaml を編集し、--auto-tls パラメータを削除するか、false に設定します。
--auto-tls=false</p>
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># このスクリプトは、k3s が実際に etcd を実行していること（sqlite3 などの他のデータベースではないこと）を確認するために使用されます</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 要件を確認する前に</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">set</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-eE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function-name function" style="color:rgb(130, 170, 255)">handle_error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">trap</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;handle_error&#x27;</span><span class="token plain"> ERR</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">$(</span><span class="token string variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token string variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token string variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable string" style="color:rgb(195, 232, 141)">&#x27;Managed etcd cluster initializing&#x27;</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">wc</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-l</span><span class="token string variable" style="color:rgb(191, 199, 213)">)</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-gt</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.11&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">stat</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token variable" style="color:rgb(191, 199, 213)"> %a /var/lib/rancher/k3s/server/db/etcd</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2.29&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">tail</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;etcd-&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-E</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;cert-file|key-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-cert-auth&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;auto-tls&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-E</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;cert-file|key-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.5&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-cert-auth&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.6&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-auto-tls&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.7&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;trusted-ca-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 別のデータベースが実行されている場合、スキャンを通過するために必要なものを返します</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.11&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;700&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2.29&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--etcd-certfile AND --etcd-keyfile&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cert-file AND key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;peer-cert-file AND peer-key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.5&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.6&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--peer-auto-tls=false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.7&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--trusted-ca-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><strong>監査実行:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">./check_for_k3s_etcd.sh </span><span class="token number" style="color:rgb(247, 140, 108)">2.3</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;ETCD_AUTO_TLS&#x27; が存在しない、または &#x27;ETCD_AUTO_TLS&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">error: process ID list syntax error Usage: ps [options] Try &#x27;ps --help &lt;simple|list|output|threads|misc|all&gt;&#x27; or &#x27;ps --help &lt;s|l|o|t|m|a&gt;&#x27; for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory error: process ID list syntax error Usage: ps [options] Try &#x27;ps --help &lt;simple|list|output|threads|misc|all&gt;&#x27; or &#x27;ps --help &lt;s|l|o|t|m|a&gt;&#x27; for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory error: process ID list syntax error Usage: ps [options] Try &#x27;ps --help &lt;simple|list|output|threads|misc|all&gt;&#x27; or &#x27;ps --help &lt;s|l|o|t|m|a&gt;&#x27; for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="24---peer-cert-file-および---peer-key-file-引数が適切に設定されていることを確認する-自動化">2.4 --peer-cert-file および --peer-key-file 引数が適切に設定されていることを確認する (自動化)<a href="#24---peer-cert-file-および---peer-key-file-引数が適切に設定されていることを確認する-自動化" class="hash-link" aria-label="2.4 --peer-cert-file および --peer-key-file 引数が適切に設定されていることを確認する (自動化) への直接リンク" title="2.4 --peer-cert-file および --peer-key-file 引数が適切に設定されていることを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
etcd サービスのドキュメントに従い、etcd クラスターに適したピア TLS 暗号化を構成します。
次に、マスターノードの etcd ポッド仕様ファイル /etc/kubernetes/manifests/etcd.yaml を編集し、以下のパラメータを設定します。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--peer-client-file=&lt;/path/to/peer-cert-file&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--peer-key-file=&lt;/path/to/peer-key-file&gt;</span><br></span></code></pre></div></div>
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># このスクリプトは、k3s が実際に etcd を実行していること（sqlite3 などの他のデータベースではないこと）を確認するために使用されます</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 要件を確認する前に</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">set</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-eE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function-name function" style="color:rgb(130, 170, 255)">handle_error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">trap</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;handle_error&#x27;</span><span class="token plain"> ERR</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">$(</span><span class="token string variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token string variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token string variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable string" style="color:rgb(195, 232, 141)">&#x27;Managed etcd cluster initializing&#x27;</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">wc</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-l</span><span class="token string variable" style="color:rgb(191, 199, 213)">)</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-gt</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.11&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">stat</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token variable" style="color:rgb(191, 199, 213)"> %a /var/lib/rancher/k3s/server/db/etcd</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2.29&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">tail</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;etcd-&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-E</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;cert-file|key-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-cert-auth&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;auto-tls&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-E</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;cert-file|key-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.5&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-cert-auth&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.6&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-auto-tls&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.7&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;trusted-ca-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 別のデータベースが実行されている場合、スキャンを通過するために必要なものを返します</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.11&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;700&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2.29&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--etcd-certfile AND --etcd-keyfile&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cert-file AND key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;peer-cert-file AND peer-key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.5&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.6&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--peer-auto-tls=false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.7&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--trusted-ca-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><strong>監査実行:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">./check_for_k3s_etcd.sh </span><span class="token number" style="color:rgb(247, 140, 108)">2.3</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;ETCD_AUTO_TLS&#x27; が存在しない、または &#x27;ETCD_AUTO_TLS&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">error: process ID list syntax error Usage: ps [options] Try &#x27;ps --help &lt;simple|list|output|threads|misc|all&gt;&#x27; or &#x27;ps --help &lt;s|l|o|t|m|a&gt;&#x27; for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory error: process ID list syntax error Usage: ps [options] Try &#x27;ps --help &lt;simple|list|output|threads|misc|all&gt;&#x27; or &#x27;ps --help &lt;s|l|o|t|m|a&gt;&#x27; for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory error: process ID list syntax error Usage: ps [options] Try &#x27;ps --help &lt;simple|list|output|threads|misc|all&gt;&#x27; or &#x27;ps --help &lt;s|l|o|t|m|a&gt;&#x27; for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cert-file AND key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;peer-cert-file AND peer-key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.5&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.6&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--peer-auto-tls=false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.7&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--trusted-ca-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><strong>監査実行:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">./check_for_k3s_etcd.sh </span><span class="token number" style="color:rgb(247, 140, 108)">2.4</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;cert-file&#x27; が存在し、かつ &#x27;key-file&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">peer-cert-file AND peer-key-file cert-file: /var/lib/rancher/k3s/server/tls/etcd/peer-server-client.crt key-file: /var/lib/rancher/k3s/server/tls/etcd/peer-server-client.key peer-cert-file AND peer-key-file</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="25---peer-client-cert-auth-引数が-true-に設定されていることを確認する-自動化">2.5 --peer-client-cert-auth 引数が true に設定されていることを確認する (自動化)<a href="#25---peer-client-cert-auth-引数が-true-に設定されていることを確認する-自動化" class="hash-link" aria-label="2.5 --peer-client-cert-auth 引数が true に設定されていることを確認する (自動化) への直接リンク" title="2.5 --peer-client-cert-auth 引数が true に設定されていることを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
マスターノードの etcd ポッド仕様ファイル /etc/kubernetes/manifests/etcd.yaml を編集し、以下のパラメータを設定します。
--peer-client-cert-auth=true</p>
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># このスクリプトは、k3s が実際に etcd を実行していること（sqlite3 などの他のデータベースではないこと）を確認するために使用されます</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 要件を確認する前に</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">set</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-eE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function-name function" style="color:rgb(130, 170, 255)">handle_error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">trap</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;handle_error&#x27;</span><span class="token plain"> ERR</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">$(</span><span class="token string variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token string variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token string variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable string" style="color:rgb(195, 232, 141)">&#x27;Managed etcd cluster initializing&#x27;</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">wc</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-l</span><span class="token string variable" style="color:rgb(191, 199, 213)">)</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-gt</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.11&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">stat</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token variable" style="color:rgb(191, 199, 213)"> %a /var/lib/rancher/k3s/server/db/etcd</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2.29&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">tail</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;etcd-&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-E</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;cert-file|key-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-cert-auth&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;auto-tls&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-E</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;cert-file|key-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.5&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-cert-auth&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.6&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-auto-tls&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.7&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;trusted-ca-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 別のデータベースが実行されている場合、スキャンをパスするために必要なものを返します</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.11&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;700&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2.29&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--etcd-certfile AND --etcd-keyfile&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cert-file AND key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;peer-cert-file AND peer-key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.5&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.6&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--peer-auto-tls=false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.7&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--trusted-ca-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><strong>監査実行:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">./check_for_k3s_etcd.sh </span><span class="token number" style="color:rgb(247, 140, 108)">2.5</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--client-cert-auth&#x27; が存在する、または &#x27;client-cert-auth&#x27; が &#x27;true&#x27; と等しい</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--client-cert-auth=true client-cert-auth: true --client-cert-auth=true</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="26---peer-auto-tls-引数が-true-に設定されていないことを確認する-自動化">2.6 --peer-auto-tls 引数が true に設定されていないことを確認する (自動化)<a href="#26---peer-auto-tls-引数が-true-に設定されていないことを確認する-自動化" class="hash-link" aria-label="2.6 --peer-auto-tls 引数が true に設定されていないことを確認する (自動化) への直接リンク" title="2.6 --peer-auto-tls 引数が true に設定されていないことを確認する (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
マスターノードの etcd ポッド仕様ファイル /etc/kubernetes/manifests/etcd.yaml を編集し、--peer-auto-tls パラメータを削除するか、false に設定します。
--peer-auto-tls=false</p>
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># このスクリプトは、k3s が実際に etcd を実行していること（sqlite3 などの他のデータベースではないこと）を確認するために使用されます</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 要件を確認する前に</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">set</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-eE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function-name function" style="color:rgb(130, 170, 255)">handle_error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">trap</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;handle_error&#x27;</span><span class="token plain"> ERR</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">$(</span><span class="token string variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token string variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token string variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable string" style="color:rgb(195, 232, 141)">&#x27;Managed etcd cluster initializing&#x27;</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">wc</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-l</span><span class="token string variable" style="color:rgb(191, 199, 213)">)</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-gt</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.11&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">stat</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token variable" style="color:rgb(191, 199, 213)"> %a /var/lib/rancher/k3s/server/db/etcd</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2.29&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">tail</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;etcd-&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-E</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;cert-file|key-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-cert-auth&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;auto-tls&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-E</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;cert-file|key-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.5&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-cert-auth&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.6&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-auto-tls&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.7&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;trusted-ca-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 別のデータベースが実行されている場合、スキャンをパスするために必要なものを返します</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.11&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;700&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2.29&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--etcd-certfile AND --etcd-keyfile&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cert-file AND key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;peer-cert-file AND peer-key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.5&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.6&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--peer-auto-tls=false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.7&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--trusted-ca-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><strong>監査実行:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">./check_for_k3s_etcd.sh </span><span class="token number" style="color:rgb(247, 140, 108)">2.6</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--peer-auto-tls&#x27; が存在しない、または &#x27;--peer-auto-tls&#x27; が &#x27;false&#x27; と等しい</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--peer-auto-tls=false error: process ID list syntax error Usage: ps [options] Try &#x27;ps --help &lt;simple|list|output|threads|misc|all&gt;&#x27; or &#x27;ps --help &lt;s|l|o|t|m|a&gt;&#x27; for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory --peer-auto-tls=false</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="27-etcd-に対して一意の証明書認証局が使用されていることを確認する-手動">2.7 etcd に対して一意の証明書認証局が使用されていることを確認する (手動)<a href="#27-etcd-に対して一意の証明書認証局が使用されていることを確認する-手動" class="hash-link" aria-label="2.7 etcd に対して一意の証明書認証局が使用されていることを確認する (手動) への直接リンク" title="2.7 etcd に対して一意の証明書認証局が使用されていることを確認する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
[手動テスト]
etcd のドキュメントに従い、etcd サービス用の専用証明書認証局セットアップを作成します。
その後、マスターノードの etcd ポッド仕様ファイル /etc/kubernetes/manifests/etcd.yaml を編集し、以下のパラメータを設定します。
<code>--trusted-ca-file=&lt;/path/to/ca-file&gt;</code></p>
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># このスクリプトは、k3s が実際に etcd を実行していること（sqlite3 などの他のデータベースではないこと）を確認するために使用されます</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 要件を確認する前に</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">set</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-eE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function-name function" style="color:rgb(130, 170, 255)">handle_error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">trap</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;handle_error&#x27;</span><span class="token plain"> ERR</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">$(</span><span class="token string variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token string variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token string variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable string" style="color:rgb(195, 232, 141)">&#x27;Managed etcd cluster initializing&#x27;</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable function" style="color:rgb(130, 170, 255)">wc</span><span class="token string variable" style="color:rgb(191, 199, 213)"> </span><span class="token string variable parameter variable" style="color:rgb(191, 199, 213)">-l</span><span class="token string variable" style="color:rgb(191, 199, 213)">)</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-gt</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.11&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">stat</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token variable" style="color:rgb(191, 199, 213)"> %a /var/lib/rancher/k3s/server/db/etcd</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2.29&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable" style="color:rgb(191, 199, 213)">journalctl </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/log/journal </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token variable" style="color:rgb(191, 199, 213)"> k3s </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">tail</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;etcd-&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-E</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;cert-file|key-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-cert-auth&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;auto-tls&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-E</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;cert-file|key-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.5&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable parameter variable" style="color:rgb(191, 199, 213)">-A</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable number" style="color:rgb(247, 140, 108)">5</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-transport-security&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config </span><span class="token variable operator" style="color:rgb(137, 221, 255)">|</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;client-cert-auth&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.6&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;peer-auto-tls&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.7&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$(</span><span class="token variable function" style="color:rgb(130, 170, 255)">grep</span><span class="token variable" style="color:rgb(191, 199, 213)"> </span><span class="token variable string" style="color:rgb(195, 232, 141)">&#x27;trusted-ca-file&#x27;</span><span class="token variable" style="color:rgb(191, 199, 213)"> /var/lib/rancher/k3s/server/db/etcd/config</span><span class="token variable" style="color:rgb(191, 199, 213)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 別のデータベースが実行されている場合、スキャンをパスするために必要なものを返します</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.1.11&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;700&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1.2.29&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--etcd-certfile AND --etcd-keyfile&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cert-file AND key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.4&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;peer-cert-file AND peer-key-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.5&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--client-cert-auth=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.6&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--peer-auto-tls=false&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2.7&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;--trusted-ca-file&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><strong>監査実行:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">./check_for_k3s_etcd.sh </span><span class="token number" style="color:rgb(247, 140, 108)">2.7</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;trusted-ca-file&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--trusted-ca-file trusted-ca-file: /var/lib/rancher/k3s/server/tls/etcd/server-ca.crt trusted-ca-file: /var/lib/rancher/k3s/server/tls/etcd/peer-ca.crt --trusted-ca-file</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="31-認証と認可">3.1 認証と認可<a href="#31-認証と認可" class="hash-link" aria-label="3.1 認証と認可 への直接リンク" title="3.1 認証と認可 への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="311-クライアント証明書認証はユーザーに対して使用されるべきではない-手動">3.1.1 クライアント証明書認証はユーザーに対して使用されるべきではない (手動)<a href="#311-クライアント証明書認証はユーザーに対して使用されるべきではない-手動" class="hash-link" aria-label="3.1.1 クライアント証明書認証はユーザーに対して使用されるべきではない (手動) への直接リンク" title="3.1.1 クライアント証明書認証はユーザーに対して使用されるべきではない (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
クライアント証明書の代わりに、OIDC の使用など Kubernetes が提供する代替メカニズムを実装するべきです。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="32-ロギング">3.2 ロギング<a href="#32-ロギング" class="hash-link" aria-label="3.2 ロギング への直接リンク" title="3.2 ロギング への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="321-最小限の監査ポリシーが作成されていることを確認する-手動">3.2.1 最小限の監査ポリシーが作成されていることを確認する (手動)<a href="#321-最小限の監査ポリシーが作成されていることを確認する-手動" class="hash-link" aria-label="3.2.1 最小限の監査ポリシーが作成されていることを確認する (手動) への直接リンク" title="3.2.1 最小限の監査ポリシーが作成されていることを確認する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
クラスター用の監査ポリシーファイルを作成します。</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kube-apiserver&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;audit-policy-file&#x27;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="322-監査ポリシーが主要なセキュリティ問題をカバーしていることを確認する-手動">3.2.2 監査ポリシーが主要なセキュリティ問題をカバーしていることを確認する (手動)<a href="#322-監査ポリシーが主要なセキュリティ問題をカバーしていることを確認する-手動" class="hash-link" aria-label="3.2.2 監査ポリシーが主要なセキュリティ問題をカバーしていることを確認する (手動) への直接リンク" title="3.2.2 監査ポリシーが主要なセキュリティ問題をカバーしていることを確認する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
クラスターに提供される監査ポリシーを確認し、少なくとも以下の領域をカバーしていることを確認します。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">- クラスターによって管理されるSecretsへのアクセス。Secrets、ConfigMaps、およびTokenReviewsへのリクエストのメタデータのみをログに記録するように注意し、機密データのログ記録のリスクを避ける。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- PodおよびDeploymentオブジェクトの変更。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- `pods/exec`、`pods/portforward`、`pods/proxy`、および`services/proxy`の使用。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ほとんどのリクエストに対して、最低限メタデータレベルでのログ記録が推奨される（最も基本的なログ記録レベル）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">## 4.1 ワーカーノードの構成ファイル</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">### 4.1.1 kubeletサービスファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">**結果:** 該当なし</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">**修正方法:**</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">各ワーカーノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例: chmod 644 /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">### 4.1.2 kubeletサービスファイルの所有者がroot:rootに設定されていることを確認する（自動化）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">**結果:** 該当なし</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">**修正方法:**</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">各ワーカーノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">chown root:root /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">### 4.1.3 プロキシkubeconfigファイルが存在する場合、パーミッションが644またはそれ以上に制限されていることを確認する（手動）</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">**結果:** 合格</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">**修正方法:**</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">各ワーカーノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">例:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">chmod 644 /var/lib/rancher/k3s/agent/kubeproxy.kubeconfig</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">**監査:**</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">```bash</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">stat -c %a /var/lib/rancher/k3s/agent/kubeproxy.kubeconfig</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;permissions&#x27;が存在する または &#x27;/var/lib/rancher/k3s/agent/kubeproxy.kubeconfig&#x27;が存在しない</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">644 644</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="414-プロキシkubeconfigファイルが存在する場合所有者がrootに設定されていることを確認する手動">4.1.4 プロキシkubeconfigファイルが存在する場合、所有者がroot<!-- -->:root<!-- -->に設定されていることを確認する（手動）<a href="#414-プロキシkubeconfigファイルが存在する場合所有者がrootに設定されていることを確認する手動" class="hash-link" aria-label="414-プロキシkubeconfigファイルが存在する場合所有者がrootに設定されていることを確認する手動 への直接リンク" title="414-プロキシkubeconfigファイルが存在する場合所有者がrootに設定されていることを確認する手動 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
各ワーカーノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例: chown root<!-- -->:root<!-- --> /var/lib/rancher/k3s/agent/kubeproxy.kubeconfig</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/sh </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;if test -e /var/lib/rancher/k3s/agent/kubeproxy.kubeconfig; then stat -c %U:%G /var/lib/rancher/k3s/agent/kubeproxy.kubeconfig; fi&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;root:root&#x27;が存在する または &#x27;/var/lib/rancher/k3s/agent/kubeproxy.kubeconfig&#x27;が存在しない</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root:root root:root</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="415---kubeconfig-kubeletconfファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化">4.1.5 --kubeconfig kubelet.confファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化）<a href="#415---kubeconfig-kubeletconfファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化" class="hash-link" aria-label="4.1.5 --kubeconfig kubelet.confファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化） への直接リンク" title="4.1.5 --kubeconfig kubelet.confファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
各ワーカーノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例:
chmod 644 /var/lib/rancher/k3s/server/cred/admin.kubeconfig</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">stat</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> %a /var/lib/rancher/k3s/agent/kubelet.kubeconfig</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;644&#x27;が&#x27;644&#x27;と等しい</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">644 644</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="416---kubeconfig-kubeletconfファイルの所有者がrootに設定されていることを確認する自動化">4.1.6 --kubeconfig kubelet.confファイルの所有者がroot<!-- -->:root<!-- -->に設定されていることを確認する（自動化）<a href="#416---kubeconfig-kubeletconfファイルの所有者がrootに設定されていることを確認する自動化" class="hash-link" aria-label="416---kubeconfig-kubeletconfファイルの所有者がrootに設定されていることを確認する自動化 への直接リンク" title="416---kubeconfig-kubeletconfファイルの所有者がrootに設定されていることを確認する自動化 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
各ワーカーノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例:
chown root<!-- -->:root<!-- --> /var/lib/rancher/k3s/server/cred/admin.kubeconfig</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">stat</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> %U:%G /var/lib/rancher/k3s/agent/kubelet.kubeconfig</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;root:root&#x27;が&#x27;root:root&#x27;と等しい</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root:root root:root</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="417-証明書認証局ファイルのパーミッションが644またはそれ以上に制限されていることを確認する手動">4.1.7 証明書認証局ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（手動）<a href="#417-証明書認証局ファイルのパーミッションが644またはそれ以上に制限されていることを確認する手動" class="hash-link" aria-label="4.1.7 証明書認証局ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（手動） への直接リンク" title="4.1.7 証明書認証局ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（手動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
--client-ca-fileのファイルパーミッションを変更するために以下のコマンドを実行します: <code>chmod 644 &lt;filename&gt;</code></p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">stat</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> %a /var/lib/rancher/k3s/server/tls/server-ca.crt</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;644&#x27;が存在する または &#x27;640&#x27;が存在する または &#x27;600&#x27;が&#x27;600&#x27;と等しい または &#x27;444&#x27;が存在する または &#x27;440&#x27;が存在する または &#x27;400&#x27;が存在する または &#x27;000&#x27;が存在する</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">644 600</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="418-クライアント証明書認証局ファイルの所有者がrootに設定されていることを確認する手動">4.1.8 クライアント証明書認証局ファイルの所有者がroot<!-- -->:root<!-- -->に設定されていることを確認する（手動）<a href="#418-クライアント証明書認証局ファイルの所有者がrootに設定されていることを確認する手動" class="hash-link" aria-label="418-クライアント証明書認証局ファイルの所有者がrootに設定されていることを確認する手動 への直接リンク" title="418-クライアント証明書認証局ファイルの所有者がrootに設定されていることを確認する手動 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
--client-ca-fileの所有者を変更するために以下のコマンドを実行します:
<code>chown root:root &lt;filename&gt;</code>.</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">stat</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> %U:%G /var/lib/rancher/k3s/server/tls/client-ca.crt</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;root:root&#x27;が&#x27;root:root&#x27;と等しい</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">root:root root:root</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="419-kubelet---config構成ファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化">4.1.9 kubelet --config構成ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化）<a href="#419-kubelet---config構成ファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化" class="hash-link" aria-label="4.1.9 kubelet --config構成ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化） への直接リンク" title="4.1.9 kubelet --config構成ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 該当なし</p>
<p><strong>修正方法:</strong>
監査ステップで特定された構成ファイルの場所を使用して以下のコマンドを実行します
chmod 644 /var/lib/kubelet/config.yaml</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4110-kubelet---config構成ファイルの所有者がrootに設定されていることを確認する自動化">4.1.10 kubelet --config構成ファイルの所有者がroot<!-- -->:root<!-- -->に設定されていることを確認する（自動化）<a href="#4110-kubelet---config構成ファイルの所有者がrootに設定されていることを確認する自動化" class="hash-link" aria-label="4110-kubelet---config構成ファイルの所有者がrootに設定されていることを確認する自動化 への直接リンク" title="4110-kubelet---config構成ファイルの所有者がrootに設定されていることを確認する自動化 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 該当なし</p>
<p><strong>修正方法:</strong>
監査ステップで特定された構成ファイルの場所を使用して以下のコマンドを実行します
chown root<!-- -->:root<!-- --> /var/lib/kubelet/config.yaml</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="42-kubelet">4.2 Kubelet<a href="#42-kubelet" class="hash-link" aria-label="4.2 Kubelet への直接リンク" title="4.2 Kubelet への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="421---anonymous-auth引数がfalseに設定されていることを確認する自動化">4.2.1 --anonymous-auth引数がfalseに設定されていることを確認する（自動化）<a href="#421---anonymous-auth引数がfalseに設定されていることを確認する自動化" class="hash-link" aria-label="4.2.1 --anonymous-auth引数がfalseに設定されていることを確認する（自動化） への直接リンク" title="4.2.1 --anonymous-auth引数がfalseに設定されていることを確認する（自動化） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
Kubelet構成ファイルを使用している場合、ファイルを編集して<code>authentication: anonymous: enabled</code>を<code>false</code>に設定します。
実行可能な引数を使用している場合、各ワーカーノードのkubeletサービスファイル
/etc/systemd/system/kubelet.service.d/10-kubeadm.confを編集し、以下のパラメータをKUBELET_SYSTEM_PODS_ARGS変数に設定します。
<code>--anonymous-auth=false</code>
システムに基づいて、kubeletサービスを再起動します。例:
systemctl daemon-reload
systemctl restart kubelet.service</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/sh </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;if test $(journalctl -D /var/log/journal -u k3s | grep &quot;Running kube-apiserver&quot; | wc -l) -gt 0; then journalctl -D /var/log/journal -u k3s | grep &quot;Running kube-apiserver&quot; | tail -n1 | grep &quot;anonymous-auth&quot; | grep -v grep; else echo &quot;--anonymous-auth=false&quot;; fi&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--anonymous-auth&#x27;が&#x27;false&#x27;と等しい</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--anonymous-auth=false Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="422---authorization-mode引数がalwaysallowに設定されていないことを確認する自動化">4.2.2 --authorization-mode引数がAlwaysAllowに設定されていないことを確認する（自動化）<a href="#422---authorization-mode引数がalwaysallowに設定されていないことを確認する自動化" class="hash-link" aria-label="4.2.2 --authorization-mode引数がAlwaysAllowに設定されていないことを確認する（自動化） への直接リンク" title="4.2.2 --authorization-mode引数がAlwaysAllowに設定されていないことを確認する（自動化） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
Kubelet構成ファイルを使用している場合、ファイルを編集して<code>authorization.mode</code>をWebhookに設定します。実行可能な引数を使用している場合、各ワーカーノードのkubeletサービスファイル
/etc/systemd/system/kubelet.service.d/10-kubeadm.confを編集し、以下のパラメータをKUBELET_AUTHZ_ARGS変数に設定します。
--authorization-mode=Webhook
システムに基づいて、kubeletサービスを再起動します。例:
systemctl daemon-reload
systemctl restart kubelet.service</p>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/sh </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;if test $(journalctl -D /var/log/journal -u k3s | grep &quot;Running kube-apiserver&quot; | wc -l) -gt 0; then journalctl -D /var/log/journal -u k3s | grep &quot;Running kube-apiserver&quot; | tail -n1 | grep &quot;authorization-mode&quot; | grep -v grep; else echo &quot;--authorization-mode=Webhook&quot;; fi&#x27;</span><br></span></code></pre></div></div>
<p><strong>期待される結果</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--authorization-mode&#x27;に&#x27;AlwaysAllow&#x27;が含まれていない</span><br></span></code></pre></div></div>
<p><strong>返される値</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">```markdown</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--authorization-mode=Webhook Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="423-ensure-that-the---client-ca-file-argument-is-set-as-appropriate-automated">4.2.3 Ensure that the --client-ca-file argument is set as appropriate (Automated)<a href="#423-ensure-that-the---client-ca-file-argument-is-set-as-appropriate-automated" class="hash-link" aria-label="4.2.3 Ensure that the --client-ca-file argument is set as appropriate (Automated) への直接リンク" title="4.2.3 Ensure that the --client-ca-file argument is set as appropriate (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
If using a Kubelet config file, edit the file to set <code>authentication.x509.clientCAFile</code> to
the location of the client CA file.
If using command line arguments, edit the kubelet service file
/etc/systemd/system/kubelet.service.d/10-kubeadm.conf on each worker node and
set the below parameter in KUBELET_AUTHZ_ARGS variable.
<code>--client-ca-file=&lt;path/to/client-ca-file&gt;</code>
Based on your system, restart the kubelet service. For example,
systemctl daemon-reload
systemctl restart kubelet.service</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/sh </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-c</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;if test $(journalctl -D /var/log/journal -u k3s | grep &quot;Running kube-apiserver&quot; | wc -l) -gt 0; then journalctl -D /var/log/journal -u k3s | grep &quot;Running kube-apiserver&quot; | tail -n1 | grep &quot;client-ca-file&quot; | grep -v grep; else echo &quot;--client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt&quot;; fi&#x27;</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--client-ca-file&#x27; is present</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:40Z&quot; level=info msg=&quot;Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="424-ensure-that-the---read-only-port-argument-is-set-to-0-manual">4.2.4 Ensure that the --read-only-port argument is set to 0 (Manual)<a href="#424-ensure-that-the---read-only-port-argument-is-set-to-0-manual" class="hash-link" aria-label="4.2.4 Ensure that the --read-only-port argument is set to 0 (Manual) への直接リンク" title="4.2.4 Ensure that the --read-only-port argument is set to 0 (Manual) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> pass</p>
<p><strong>Remediation:</strong>
If using a Kubelet config file, edit the file to set <code>readOnlyPort</code> to 0.
If using command line arguments, edit the kubelet service file
/etc/systemd/system/kubelet.service.d/10-kubeadm.conf on each worker node and
set the below parameter in KUBELET_SYSTEM_PODS_ARGS variable.
--read-only-port=0
Based on your system, restart the kubelet service. For example,
systemctl daemon-reload
systemctl restart kubelet.service</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kubelet&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;read-only-port&#x27;</span><br></span></code></pre></div></div>
<p><strong>Expected Result</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--read-only-port&#x27; is equal to &#x27;0&#x27; OR &#x27;--read-only-port&#x27; is not present</span><br></span></code></pre></div></div>
<p><strong>Returned Value</strong>:</p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:50 k3s-123-cis-pool2-98604672-hr9p5 k3s[1592]: time=&quot;2022-09-13T13:26:50Z&quot; level=info msg=&quot;Running kubelet --address=0.0.0.0 --anonymous-auth=false --authentication-token-webhook=true --authorization-mode=Webhook --cgroup-driver=systemd --client-ca-file=/var/lib/rancher/k3s/agent/client-ca.crt --cloud-provider=external --cluster-dns=10.43.0.10 --cluster-domain=cluster.local --container-runtime-endpoint=unix:///run/k3s/containerd/containerd.sock --containerd=/run/k3s/containerd/containerd.sock --eviction-hard=imagefs.available&lt;5%,nodefs.available&lt;5% --eviction-minimum-reclaim=imagefs.available=10%,nodefs.available=10% --fail-swap-on=false --healthz-bind-address=127.0.0.1 --hostname-override=k3s-123-cis-pool2-98604672-hr9p5 --kubeconfig=/var/lib/rancher/k3s/agent/kubelet.kubeconfig --node-labels=rke.cattle.io/machine=00c4e7a0-5497-4367-a70c-0b836757eae8 --pod-infra-container-image=rancher/mirrored-pause:3.6 --pod-manifest-path=/var/lib/rancher/k3s/agent/pod-manifests --read-only-port=0 --resolv-conf=/run/systemd/resolve/resolv.conf --serialize-image-pulls=false --tls-cert-file=/var/lib/rancher/k3s/agent/serving-kubelet.crt --tls-private-key-file=/var/lib/rancher/k3s/agent/serving-kubelet.key&quot; Sep 13 13:26:44 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:44Z&quot; level=info msg=&quot;Running kubelet --address=0.0.0.0 --anonymous-auth=false --authentication-token-webhook=true --authorization-mode=Webhook --cgroup-driver=systemd --client-ca-file=/var/lib/rancher/k3s/agent/client-ca.crt --cloud-provider=external --cluster-dns=10.43.0.10 --cluster-domain=cluster.local --container-runtime-endpoint=unix:///run/k3s/containerd/containerd.sock --containerd=/run/k3s/containerd/containerd.sock --eviction-hard=imagefs.available&lt;5%,nodefs.available&lt;5% --eviction-minimum-reclaim=imagefs.available=10%,nodefs.available=10% --fail-swap-on=false --healthz-bind-address=127.0.0.1 --hostname-override=k3s-123-cis-pool3-b403f678-bzdg5 --kubeconfig=/var/lib/rancher/k3s/agent/kubelet.kubeconfig --node-labels=rke.cattle.io/machine=109d596c-89f5-4c10-8c7f-6b82a38edd8f --pod-infra-container-image=rancher/mirrored-pause:3.6 --pod-manifest-path=/var/lib/rancher/k3s/agent/pod-manifests --read-only-port=0 --resolv-conf=/run/systemd/resolve/resolv.conf --serialize-image-pulls=false --tls-cert-file=/var/lib/rancher/k3s/agent/serving-kubelet.crt --tls-private-key-file=/var/lib/rancher/k3s/agent/serving-kubelet.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="425-ensure-that-the---streaming-connection-idle-timeout-argument-is-not-set-to-0-manual">4.2.5 Ensure that the --streaming-connection-idle-timeout argument is not set to 0 (Manual)<a href="#425-ensure-that-the---streaming-connection-idle-timeout-argument-is-not-set-to-0-manual" class="hash-link" aria-label="4.2.5 Ensure that the --streaming-connection-idle-timeout argument is not set to 0 (Manual) への直接リンク" title="4.2.5 Ensure that the --streaming-connection-idle-timeout argument is not set to 0 (Manual) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> warn</p>
<p><strong>Remediation:</strong>
If using a Kubelet config file, edit the file to set <code>streamingConnectionIdleTimeout</code> to a
value other than 0.
If using command line arguments, edit the kubelet service file
/etc/systemd/system/kubelet.service.d/10-kubeadm.conf on each worker node and
set the below parameter in KUBELET_SYSTEM_PODS_ARGS variable.
--streaming-connection-idle-timeout=5m
Based on your system, restart the kubelet service. For example,
systemctl daemon-reload
systemctl restart kubelet.service</p>
<p><strong>Audit:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kubelet&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;streaming-connection-idle-timeout&#x27;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="426-ensure-that-the---protect-kernel-defaults-argument-is-set-to-true-automated">4.2.6 Ensure that the --protect-kernel-defaults argument is set to true (Automated)<a href="#426-ensure-that-the---protect-kernel-defaults-argument-is-set-to-true-automated" class="hash-link" aria-label="4.2.6 Ensure that the --protect-kernel-defaults argument is set to true (Automated) への直接リンク" title="4.2.6 Ensure that the --protect-kernel-defaults argument is set to true (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> Not Applicable</p>
<p><strong>Remediation:</strong>
If using a Kubelet config file, edit the file to set <code>protectKernelDefaults</code> to <code>true</code>.
If using command line arguments, edit the kubelet service file
/etc/systemd/system/kubelet.service.d/10-kubeadm.conf on each worker node and
set the below parameter in KUBELET_SYSTEM_PODS_ARGS variable.
--protect-kernel-defaults=true
Based on your system, restart the kubelet service. For example:
systemctl daemon-reload
systemctl restart kubelet.service</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="427-ensure-that-the---make-iptables-util-chains-argument-is-set-to-true-automated">4.2.7 Ensure that the --make-iptables-util-chains argument is set to true (Automated)<a href="#427-ensure-that-the---make-iptables-util-chains-argument-is-set-to-true-automated" class="hash-link" aria-label="4.2.7 Ensure that the --make-iptables-util-chains argument is set to true (Automated) への直接リンク" title="4.2.7 Ensure that the --make-iptables-util-chains argument is set to true (Automated) への直接リンク" translate="no">​</a></h3>
<p><strong>Result:</strong> Not Applicable</p>
<p><strong>Remediation:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">もし Kubelet の設定ファイルを使用している場合は、ファイルを編集して `makeIPTablesUtilChains` を `true` に設定します。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">コマンドライン引数を使用している場合は、各ワーカーノードの kubelet サービスファイル</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`/etc/systemd/system/kubelet.service.d/10-kubeadm.conf` を編集し、</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">`KUBELET_SYSTEM_PODS_ARGS` 変数から `--make-iptables-util-chains` 引数を削除します。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">システムに基づいて、kubelet サービスを再起動します。例えば：</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">```bash</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl restart kubelet.service</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="428---hostname-override-引数が設定されていないことを確認する手動">4.2.8 <code>--hostname-override</code> 引数が設定されていないことを確認する（手動）<a href="#428---hostname-override-引数が設定されていないことを確認する手動" class="hash-link" aria-label="428---hostname-override-引数が設定されていないことを確認する手動 への直接リンク" title="428---hostname-override-引数が設定されていないことを確認する手動 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 該当なし</p>
<p><strong>修正方法:</strong>
各ワーカーノードの kubelet サービスファイル <code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> を編集し、
<code>KUBELET_SYSTEM_PODS_ARGS</code> 変数から <code>--hostname-override</code> 引数を削除します。
システムに基づいて、kubelet サービスを再起動します。例えば：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl restart kubelet.service</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="429---event-qps-引数が-0-または適切なイベントキャプチャを確保するレベルに設定されていることを確認する手動">4.2.9 <code>--event-qps</code> 引数が 0 または適切なイベントキャプチャを確保するレベルに設定されていることを確認する（手動）<a href="#429---event-qps-引数が-0-または適切なイベントキャプチャを確保するレベルに設定されていることを確認する手動" class="hash-link" aria-label="429---event-qps-引数が-0-または適切なイベントキャプチャを確保するレベルに設定されていることを確認する手動 への直接リンク" title="429---event-qps-引数が-0-または適切なイベントキャプチャを確保するレベルに設定されていることを確認する手動 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
Kubelet の設定ファイルを使用している場合は、ファイルを編集して <code>eventRecordQPS</code> を適切なレベルに設定します。
コマンドライン引数を使用している場合は、各ワーカーノードの kubelet サービスファイル
<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> を編集し、
以下のパラメータを <code>KUBELET_SYSTEM_PODS_ARGS</code> 変数に設定します。
システムに基づいて、kubelet サービスを再起動します。例えば：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl restart kubelet.service</span><br></span></code></pre></div></div>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/ps </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-fC</span><span class="token plain"> containerd</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4210---tls-cert-file-および---tls-private-key-file-引数が適切に設定されていることを確認する手動">4.2.10 <code>--tls-cert-file</code> および <code>--tls-private-key-file</code> 引数が適切に設定されていることを確認する（手動）<a href="#4210---tls-cert-file-および---tls-private-key-file-引数が適切に設定されていることを確認する手動" class="hash-link" aria-label="4210---tls-cert-file-および---tls-private-key-file-引数が適切に設定されていることを確認する手動 への直接リンク" title="4210---tls-cert-file-および---tls-private-key-file-引数が適切に設定されていることを確認する手動 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 合格</p>
<p><strong>修正方法:</strong>
Kubelet の設定ファイルを使用している場合は、ファイルを編集して <code>tlsCertFile</code> をこの Kubelet を識別するために使用する証明書ファイルの場所に設定し、
<code>tlsPrivateKeyFile</code> を対応する秘密鍵ファイルの場所に設定します。
コマンドライン引数を使用している場合は、各ワーカーノードの kubelet サービスファイル
<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> を編集し、
以下のパラメータを <code>KUBELET_CERTIFICATE_ARGS</code> 変数に設定します。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--tls-cert-file=&lt;path/to/tls-certificate-file&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--tls-private-key-file=&lt;path/to/tls-key-file&gt;</span><br></span></code></pre></div></div>
<p>システムに基づいて、kubelet サービスを再起動します。例えば：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl restart kubelet.service</span><br></span></code></pre></div></div>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">journalctl </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-D</span><span class="token plain"> /var/log/journal </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-u</span><span class="token plain"> k3s </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Running kubelet&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">tail</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-n1</span><br></span></code></pre></div></div>
<p><strong>期待される結果:</strong></p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;--tls-cert-file&#x27; が存在し、&#x27;--tls-private-key-file&#x27; が存在する</span><br></span></code></pre></div></div>
<p><strong>返された値:</strong></p>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sep 13 13:26:50 k3s-123-cis-pool2-98604672-hr9p5 k3s[1592]: time=&quot;2022-09-13T13:26:50Z&quot; level=info msg=&quot;Running kubelet --address=0.0.0.0 --anonymous-auth=false --authentication-token-webhook=true --authorization-mode=Webhook --cgroup-driver=systemd --client-ca-file=/var/lib/rancher/k3s/agent/client-ca.crt --cloud-provider=external --cluster-dns=10.43.0.10 --cluster-domain=cluster.local --container-runtime-endpoint=unix:///run/k3s/containerd/containerd.sock --containerd=/run/k3s/containerd/containerd.sock --eviction-hard=imagefs.available&lt;5%,nodefs.available&lt;5% --eviction-minimum-reclaim=imagefs.available=10%,nodefs.available=10% --fail-swap-on=false --healthz-bind-address=127.0.0.1 --hostname-override=k3s-123-cis-pool2-98604672-hr9p5 --kubeconfig=/var/lib/rancher/k3s/agent/kubelet.kubeconfig --node-labels=rke.cattle.io/machine=00c4e7a0-5497-4367-a70c-0b836757eae8 --pod-infra-container-image=rancher/mirrored-pause:3.6 --pod-manifest-path=/var/lib/rancher/k3s/agent/pod-manifests --read-only-port=0 --resolv-conf=/run/systemd/resolve/resolv.conf --serialize-image-pulls=false --tls-cert-file=/var/lib/rancher/k3s/agent/serving-kubelet.crt --tls-private-key-file=/var/lib/rancher/k3s/agent/serving-kubelet.key&quot; Sep 13 13:26:44 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time=&quot;2022-09-13T13:26:44Z&quot; level=info msg=&quot;Running kubelet --address=0.0.0.0 --anonymous-auth=false --authentication-token-webhook=true --authorization-mode=Webhook --cgroup-driver=systemd --client-ca-file=/var/lib/rancher/k3s/agent/client-ca.crt --cloud-provider=external --cluster-dns=10.43.0.10 --cluster-domain=cluster.local --container-runtime-endpoint=unix:///run/k3s/containerd/containerd.sock --containerd=/run/k3s/containerd/containerd.sock --eviction-hard=imagefs.available&lt;5%,nodefs.available&lt;5% --eviction-minimum-reclaim=imagefs.available=10%,nodefs.available=10% --fail-swap-on=false --healthz-bind-address=127.0.0.1 --hostname-override=k3s-123-cis-pool3-b403f678-bzdg5 --kubeconfig=/var/lib/rancher/k3s/agent/kubelet.kubeconfig --node-labels=rke.cattle.io/machine=109d596c-89f5-4c10-8c7f-6b82a38edd8f --pod-infra-container-image=rancher/mirrored-pause:3.6 --pod-manifest-path=/var/lib/rancher/k3s/agent/pod-manifests --read-only-port=0 --resolv-conf=/run/systemd/resolve/resolv.conf --serialize-image-pulls=false --tls-cert-file=/var/lib/rancher/k3s/agent/serving-kubelet.crt --tls-private-key-file=/var/lib/rancher/k3s/agent/serving-kubelet.key&quot;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4211---rotate-certificates-引数が-false-に設定されていないことを確認する自動">4.2.11 <code>--rotate-certificates</code> 引数が <code>false</code> に設定されていないことを確認する（自動）<a href="#4211---rotate-certificates-引数が-false-に設定されていないことを確認する自動" class="hash-link" aria-label="4211---rotate-certificates-引数が-false-に設定されていないことを確認する自動 への直接リンク" title="4211---rotate-certificates-引数が-false-に設定されていないことを確認する自動 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 該当なし</p>
<p><strong>修正方法:</strong>
Kubelet の設定ファイルを使用している場合は、ファイルを編集して <code>rotateCertificates</code> を <code>true</code> に設定するか、
デフォルト値を使用するために削除します。
コマンドライン引数を使用している場合は、各ワーカーノードの kubelet サービスファイル
<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> を編集し、
<code>KUBELET_CERTIFICATE_ARGS</code> 変数から <code>--rotate-certificates=false</code> 引数を削除します。
システムに基づいて、kubelet サービスを再起動します。例えば：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl restart kubelet.service</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4212-rotatekubeletservercertificate-引数が-true-に設定されていることを確認する手動">4.2.12 <code>RotateKubeletServerCertificate</code> 引数が <code>true</code> に設定されていることを確認する（手動）<a href="#4212-rotatekubeletservercertificate-引数が-true-に設定されていることを確認する手動" class="hash-link" aria-label="4212-rotatekubeletservercertificate-引数が-true-に設定されていることを確認する手動 への直接リンク" title="4212-rotatekubeletservercertificate-引数が-true-に設定されていることを確認する手動 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 該当なし</p>
<p><strong>修正方法:</strong>
各ワーカーノードの kubelet サービスファイル <code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> を編集し、
以下のパラメータを <code>KUBELET_CERTIFICATE_ARGS</code> 変数に設定します。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--feature-gates=RotateKubeletServerCertificate=true</span><br></span></code></pre></div></div>
<p>システムに基づいて、kubelet サービスを再起動します。例えば：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl restart kubelet.service</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4213-kubelet-が強力な暗号化スイートのみを使用していることを確認する手動">4.2.13 Kubelet が強力な暗号化スイートのみを使用していることを確認する（手動）<a href="#4213-kubelet-が強力な暗号化スイートのみを使用していることを確認する手動" class="hash-link" aria-label="4.2.13 Kubelet が強力な暗号化スイートのみを使用していることを確認する（手動） への直接リンク" title="4.2.13 Kubelet が強力な暗号化スイートのみを使用していることを確認する（手動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
Kubelet の設定ファイルを使用している場合は、ファイルを編集して <code>TLSCipherSuites</code> を
<code>TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256</code>
またはこれらの値のサブセットに設定します。
実行可能な引数を使用している場合は、各ワーカーノードの kubelet サービスファイル
<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> を編集し、
以下のように <code>--tls-cipher-suites</code> パラメータを設定します。またはこれらの値のサブセットに設定します。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256</span><br></span></code></pre></div></div>
<p>システムに基づいて、kubelet サービスを再起動します。例えば：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl restart kubelet.service</span><br></span></code></pre></div></div>
<p><strong>監査:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/bin/ps </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-fC</span><span class="token plain"> containerd</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="51-rbac-とサービスアカウント">5.1 RBAC とサービスアカウント<a href="#51-rbac-とサービスアカウント" class="hash-link" aria-label="5.1 RBAC とサービスアカウント への直接リンク" title="5.1 RBAC とサービスアカウント への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="511-cluster-admin-ロールが必要な場合にのみ使用されていることを確認する手動">5.1.1 <code>cluster-admin</code> ロールが必要な場合にのみ使用されていることを確認する（手動）<a href="#511-cluster-admin-ロールが必要な場合にのみ使用されていることを確認する手動" class="hash-link" aria-label="511-cluster-admin-ロールが必要な場合にのみ使用されていることを確認する手動 への直接リンク" title="511-cluster-admin-ロールが必要な場合にのみ使用されていることを確認する手動 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
<code>cluster-admin</code> ロールへのすべての <code>clusterrolebinding</code> を特定します。それらが使用されているかどうか、
このロールが必要かどうか、またはより少ない権限のロールを使用できるかどうかを確認します。
可能な場合は、まずユーザーを低権限のロールにバインドし、その後 <code>cluster-admin</code> ロールへの <code>clusterrolebinding</code> を削除します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl delete clusterrolebinding </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="512-シークレットへのアクセスを最小限に抑える手動">5.1.2 シークレットへのアクセスを最小限に抑える（手動）<a href="#512-シークレットへのアクセスを最小限に抑える手動" class="hash-link" aria-label="5.1.2 シークレットへのアクセスを最小限に抑える（手動） への直接リンク" title="5.1.2 シークレットへのアクセスを最小限に抑える（手動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
可能な場合は、クラスター内のシークレットオブジェクトへの <code>get</code>、<code>list</code>、および <code>watch</code> アクセスを削除します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="513-ロールおよびクラスターロールでワイルドカードの使用を最小限に抑える手動">5.1.3 ロールおよびクラスターロールでワイルドカードの使用を最小限に抑える（手動）<a href="#513-ロールおよびクラスターロールでワイルドカードの使用を最小限に抑える手動" class="hash-link" aria-label="5.1.3 ロールおよびクラスターロールでワイルドカードの使用を最小限に抑える（手動） への直接リンク" title="5.1.3 ロールおよびクラスターロールでワイルドカードの使用を最小限に抑える（手動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
可能な場合は、クラスターロールおよびロールでのワイルドカードの使用を特定のオブジェクトまたはアクションに置き換えます。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="514-ポッドの作成アクセスを最小限に抑える手動">5.1.4 ポッドの作成アクセスを最小限に抑える（手動）<a href="#514-ポッドの作成アクセスを最小限に抑える手動" class="hash-link" aria-label="5.1.4 ポッドの作成アクセスを最小限に抑える（手動） への直接リンク" title="5.1.4 ポッドの作成アクセスを最小限に抑える（手動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
可能な場合は、クラスター内のポッドオブジェクトへの作成アクセスを削除します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="515-デフォルトのサービスアカウントが積極的に使用されていないことを確認する手動">5.1.5 デフォルトのサービスアカウントが積極的に使用されていないことを確認する（手動）<a href="#515-デフォルトのサービスアカウントが積極的に使用されていないことを確認する手動" class="hash-link" aria-label="5.1.5 デフォルトのサービスアカウントが積極的に使用されていないことを確認する（手動） への直接リンク" title="5.1.5 デフォルトのサービスアカウントが積極的に使用されていないことを確認する（手動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
Kubernetes ワークロードが Kubernetes API サーバーへの特定のアクセスを必要とする場合は、明示的なサービスアカウントを作成します。
各デフォルトのサービスアカウントの設定を変更して、この値を含めます：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">automountServiceAccountToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="516-サービスアカウントトークンが必要な場合にのみマウントされることを確認する手動">5.1.6 サービスアカウントトークンが必要な場合にのみマウントされることを確認する（手動）<a href="#516-サービスアカウントトークンが必要な場合にのみマウントされることを確認する手動" class="hash-link" aria-label="5.1.6 サービスアカウントトークンが必要な場合にのみマウントされることを確認する（手動） への直接リンク" title="5.1.6 サービスアカウントトークンが必要な場合にのみマウントされることを確認する（手動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
サービスアカウントトークンをマウントする必要がないポッドおよびサービスアカウントの定義を変更して無効にします。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="517-systemmasters-グループの使用を避ける手動">5.1.7 <code>system:masters</code> グループの使用を避ける（手動）<a href="#517-systemmasters-グループの使用を避ける手動" class="hash-link" aria-label="517-systemmasters-グループの使用を避ける手動 への直接リンク" title="517-systemmasters-グループの使用を避ける手動 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
クラスター内のすべてのユーザーから <code>system:masters</code> グループを削除します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="518-kubernetes-クラスター内での-bindimpersonateおよび-escalate-権限の使用を制限する手動">5.1.8 Kubernetes クラスター内での <code>Bind</code>、<code>Impersonate</code>、および <code>Escalate</code> 権限の使用を制限する（手動）<a href="#518-kubernetes-クラスター内での-bindimpersonateおよび-escalate-権限の使用を制限する手動" class="hash-link" aria-label="518-kubernetes-クラスター内での-bindimpersonateおよび-escalate-権限の使用を制限する手動 への直接リンク" title="518-kubernetes-クラスター内での-bindimpersonateおよび-escalate-権限の使用を制限する手動 への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
可能な場合は、<code>impersonate</code>、<code>bind</code>、および <code>escalate</code> 権限をサブジェクトから削除します。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="52-ポッドセキュリティ基準">5.2 ポッドセキュリティ基準<a href="#52-ポッドセキュリティ基準" class="hash-link" aria-label="5.2 ポッドセキュリティ基準 への直接リンク" title="5.2 ポッドセキュリティ基準 への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="521-クラスターに少なくとも1つのアクティブなポリシー制御メカニズムが存在することを確認する手動">5.2.1 クラスターに少なくとも1つのアクティブなポリシー制御メカニズムが存在することを確認する（手動）<a href="#521-クラスターに少なくとも1つのアクティブなポリシー制御メカニズムが存在することを確認する手動" class="hash-link" aria-label="5.2.1 クラスターに少なくとも1つのアクティブなポリシー制御メカニズムが存在することを確認する（手動） への直接リンク" title="5.2.1 クラスターに少なくとも1つのアクティブなポリシー制御メカニズムが存在することを確認する（手動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
ユーザーワークロードを含むすべてのネームスペースに対して、Pod Security Admission または外部ポリシー制御システムが存在することを確認します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="522-特権コンテナの許可を最小限に抑える自動">5.2.2 特権コンテナの許可を最小限に抑える（自動）<a href="#522-特権コンテナの許可を最小限に抑える自動" class="hash-link" aria-label="5.2.2 特権コンテナの許可を最小限に抑える（自動） への直接リンク" title="5.2.2 特権コンテナの許可を最小限に抑える（自動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
ユーザーワークロードを含むクラスター内の各ネームスペースにポリシーを追加して、
特権コンテナの許可を制限します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="523-ホストプロセスidネームスペースを共有しようとするコンテナの許可を最小限に抑える自動">5.2.3 ホストプロセスIDネームスペースを共有しようとするコンテナの許可を最小限に抑える（自動）<a href="#523-ホストプロセスidネームスペースを共有しようとするコンテナの許可を最小限に抑える自動" class="hash-link" aria-label="5.2.3 ホストプロセスIDネームスペースを共有しようとするコンテナの許可を最小限に抑える（自動） への直接リンク" title="5.2.3 ホストプロセスIDネームスペースを共有しようとするコンテナの許可を最小限に抑える（自動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
ユーザーワークロードを含むクラスター内の各ネームスペースにポリシーを追加して、
<code>hostPID</code> コンテナの許可を制限します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="524-ホストipcネームスペースを共有しようとするコンテナの許可を最小限に抑える自動">5.2.4 ホストIPCネームスペースを共有しようとするコンテナの許可を最小限に抑える（自動）<a href="#524-ホストipcネームスペースを共有しようとするコンテナの許可を最小限に抑える自動" class="hash-link" aria-label="5.2.4 ホストIPCネームスペースを共有しようとするコンテナの許可を最小限に抑える（自動） への直接リンク" title="5.2.4 ホストIPCネームスペースを共有しようとするコンテナの許可を最小限に抑える（自動） への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
ユーザーワークロードを含むクラスター内の各ネームスペースにポリシーを追加して、
<code>hostIPC</code> コンテナの許可を制限します。
<strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>hostIPC</code>コンテナのアドミッションを制限します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="525-ホストネットワークネームスペースを共有しようとするコンテナのアドミッションを最小限に抑える-自動化">5.2.5 ホストネットワークネームスペースを共有しようとするコンテナのアドミッションを最小限に抑える (自動化)<a href="#525-ホストネットワークネームスペースを共有しようとするコンテナのアドミッションを最小限に抑える-自動化" class="hash-link" aria-label="5.2.5 ホストネットワークネームスペースを共有しようとするコンテナのアドミッションを最小限に抑える (自動化) への直接リンク" title="5.2.5 ホストネットワークネームスペースを共有しようとするコンテナのアドミッションを最小限に抑える (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>hostNetwork</code>コンテナのアドミッションを制限します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="526-allowprivilegeescalationを持つコンテナのアドミッションを最小限に抑える-自動化">5.2.6 allowPrivilegeEscalationを持つコンテナのアドミッションを最小限に抑える (自動化)<a href="#526-allowprivilegeescalationを持つコンテナのアドミッションを最小限に抑える-自動化" class="hash-link" aria-label="5.2.6 allowPrivilegeEscalationを持つコンテナのアドミッションを最小限に抑える (自動化) への直接リンク" title="5.2.6 allowPrivilegeEscalationを持つコンテナのアドミッションを最小限に抑える (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>.spec.allowPrivilegeEscalation</code>が<code>true</code>に設定されているコンテナのアドミッションを制限します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="527-ルートコンテナのアドミッションを最小限に抑える-自動化">5.2.7 ルートコンテナのアドミッションを最小限に抑える (自動化)<a href="#527-ルートコンテナのアドミッションを最小限に抑える-自動化" class="hash-link" aria-label="5.2.7 ルートコンテナのアドミッションを最小限に抑える (自動化) への直接リンク" title="5.2.7 ルートコンテナのアドミッションを最小限に抑える (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
クラスター内の各ネームスペースにポリシーを作成し、<code>MustRunAsNonRoot</code>またはUIDの範囲に0を含まない<code>MustRunAs</code>が設定されていることを確認します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="528-net_raw機能を持つコンテナのアドミッションを最小限に抑える-自動化">5.2.8 NET_RAW機能を持つコンテナのアドミッションを最小限に抑える (自動化)<a href="#528-net_raw機能を持つコンテナのアドミッションを最小限に抑える-自動化" class="hash-link" aria-label="5.2.8 NET_RAW機能を持つコンテナのアドミッションを最小限に抑える (自動化) への直接リンク" title="5.2.8 NET_RAW機能を持つコンテナのアドミッションを最小限に抑える (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>NET_RAW</code>機能を持つコンテナのアドミッションを制限します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="529-追加された機能を持つコンテナのアドミッションを最小限に抑える-自動化">5.2.9 追加された機能を持つコンテナのアドミッションを最小限に抑える (自動化)<a href="#529-追加された機能を持つコンテナのアドミッションを最小限に抑える-自動化" class="hash-link" aria-label="5.2.9 追加された機能を持つコンテナのアドミッションを最小限に抑える (自動化) への直接リンク" title="5.2.9 追加された機能を持つコンテナのアドミッションを最小限に抑える (自動化) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
<code>allowedCapabilities</code>が空の配列に設定されていない限り、クラスターのポリシーに存在しないことを確認します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="5210-機能が割り当てられたコンテナのアドミッションを最小限に抑える-手動">5.2.10 機能が割り当てられたコンテナのアドミッションを最小限に抑える (手動)<a href="#5210-機能が割り当てられたコンテナのアドミッションを最小限に抑える-手動" class="hash-link" aria-label="5.2.10 機能が割り当てられたコンテナのアドミッションを最小限に抑える (手動) への直接リンク" title="5.2.10 機能が割り当てられたコンテナのアドミッションを最小限に抑える (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
クラスター上で実行されているアプリケーションの機能の使用を確認します。ネームスペースにLinux機能を必要としないアプリケーションが含まれている場合、すべての機能を削除しないコンテナのアドミッションを禁止するPSPを追加することを検討します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="5211-windows-hostprocessコンテナのアドミッションを最小限に抑える-手動">5.2.11 Windows HostProcessコンテナのアドミッションを最小限に抑える (手動)<a href="#5211-windows-hostprocessコンテナのアドミッションを最小限に抑える-手動" class="hash-link" aria-label="5.2.11 Windows HostProcessコンテナのアドミッションを最小限に抑える (手動) への直接リンク" title="5.2.11 Windows HostProcessコンテナのアドミッションを最小限に抑える (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>.securityContext.windowsOptions.hostProcess</code>が<code>true</code>に設定されているコンテナのアドミッションを制限します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="5212-hostpathボリュームのアドミッションを最小限に抑える-手動">5.2.12 HostPathボリュームのアドミッションを最小限に抑える (手動)<a href="#5212-hostpathボリュームのアドミッションを最小限に抑える-手動" class="hash-link" aria-label="5.2.12 HostPathボリュームのアドミッションを最小限に抑える (手動) への直接リンク" title="5.2.12 HostPathボリュームのアドミッションを最小限に抑える (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>hostPath</code>ボリュームを持つコンテナのアドミッションを制限します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="5213-hostportsを使用するコンテナのアドミッションを最小限に抑える-手動">5.2.13 HostPortsを使用するコンテナのアドミッションを最小限に抑える (手動)<a href="#5213-hostportsを使用するコンテナのアドミッションを最小限に抑える-手動" class="hash-link" aria-label="5.2.13 HostPortsを使用するコンテナのアドミッションを最小限に抑える (手動) への直接リンク" title="5.2.13 HostPortsを使用するコンテナのアドミッションを最小限に抑える (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>hostPort</code>セクションを使用するコンテナのアドミッションを制限します。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="53-ネットワークポリシーとcni">5.3 ネットワークポリシーとCNI<a href="#53-ネットワークポリシーとcni" class="hash-link" aria-label="5.3 ネットワークポリシーとCNI への直接リンク" title="5.3 ネットワークポリシーとCNI への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="531-使用中のcniがネットワークポリシーをサポートしていることを確認する-手動">5.3.1 使用中のCNIがネットワークポリシーをサポートしていることを確認する (手動)<a href="#531-使用中のcniがネットワークポリシーをサポートしていることを確認する-手動" class="hash-link" aria-label="5.3.1 使用中のCNIがネットワークポリシーをサポートしていることを確認する (手動) への直接リンク" title="5.3.1 使用中のCNIがネットワークポリシーをサポートしていることを確認する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
使用中のCNIプラグインがネットワークポリシーをサポートしていない場合、別のプラグインを使用するか、Kubernetesクラスター内のトラフィックを制限するための代替メカニズムを検討します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="532-すべてのネームスペースにネットワークポリシーが定義されていることを確認する-手動">5.3.2 すべてのネームスペースにネットワークポリシーが定義されていることを確認する (手動)<a href="#532-すべてのネームスペースにネットワークポリシーが定義されていることを確認する-手動" class="hash-link" aria-label="5.3.2 すべてのネームスペースにネットワークポリシーが定義されていることを確認する (手動) への直接リンク" title="5.3.2 すべてのネームスペースにネットワークポリシーが定義されていることを確認する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
ドキュメントに従い、必要に応じてNetworkPolicyオブジェクトを作成します。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="54-シークレット管理">5.4 シークレット管理<a href="#54-シークレット管理" class="hash-link" aria-label="5.4 シークレット管理 への直接リンク" title="5.4 シークレット管理 への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="541-環境変数としてのシークレットよりもファイルとしてのシークレットを使用することを推奨する-手動">5.4.1 環境変数としてのシークレットよりもファイルとしてのシークレットを使用することを推奨する (手動)<a href="#541-環境変数としてのシークレットよりもファイルとしてのシークレットを使用することを推奨する-手動" class="hash-link" aria-label="5.4.1 環境変数としてのシークレットよりもファイルとしてのシークレットを使用することを推奨する (手動) への直接リンク" title="5.4.1 環境変数としてのシークレットよりもファイルとしてのシークレットを使用することを推奨する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
可能であれば、アプリケーションコードを変更して、環境変数ではなくマウントされたシークレットファイルからシークレットを読み取るようにします。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="542-外部シークレットストレージを検討する-手動">5.4.2 外部シークレットストレージを検討する (手動)<a href="#542-外部シークレットストレージを検討する-手動" class="hash-link" aria-label="5.4.2 外部シークレットストレージを検討する (手動) への直接リンク" title="5.4.2 外部シークレットストレージを検討する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
クラウドプロバイダーやサードパーティのシークレット管理ソリューションが提供するシークレット管理オプションを参照します。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="55-拡張可能なアドミッションコントロール">5.5 拡張可能なアドミッションコントロール<a href="#55-拡張可能なアドミッションコントロール" class="hash-link" aria-label="5.5 拡張可能なアドミッションコントロール への直接リンク" title="5.5 拡張可能なアドミッションコントロール への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="551-imagepolicywebhookアドミッションコントローラーを使用してイメージの出所を設定する-手動">5.5.1 ImagePolicyWebhookアドミッションコントローラーを使用してイメージの出所を設定する (手動)<a href="#551-imagepolicywebhookアドミッションコントローラーを使用してイメージの出所を設定する-手動" class="hash-link" aria-label="5.5.1 ImagePolicyWebhookアドミッションコントローラーを使用してイメージの出所を設定する (手動) への直接リンク" title="5.5.1 ImagePolicyWebhookアドミッションコントローラーを使用してイメージの出所を設定する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、イメージの出所を設定します。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="57-一般的なポリシー">5.7 一般的なポリシー<a href="#57-一般的なポリシー" class="hash-link" aria-label="5.7 一般的なポリシー への直接リンク" title="5.7 一般的なポリシー への直接リンク" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="571-ネームスペースを使用してリソース間に管理境界を作成する-手動">5.7.1 ネームスペースを使用してリソース間に管理境界を作成する (手動)<a href="#571-ネームスペースを使用してリソース間に管理境界を作成する-手動" class="hash-link" aria-label="5.7.1 ネームスペースを使用してリソース間に管理境界を作成する (手動) への直接リンク" title="5.7.1 ネームスペースを使用してリソース間に管理境界を作成する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
ドキュメントに従い、デプロイメント内のオブジェクトに必要なネームスペースを作成します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="572-pod定義でseccompプロファイルがdockerdefaultに設定されていることを確認する-手動">5.7.2 Pod定義でseccompプロファイルがdocker/defaultに設定されていることを確認する (手動)<a href="#572-pod定義でseccompプロファイルがdockerdefaultに設定されていることを確認する-手動" class="hash-link" aria-label="5.7.2 Pod定義でseccompプロファイルがdocker/defaultに設定されていることを確認する (手動) への直接リンク" title="5.7.2 Pod定義でseccompプロファイルがdocker/defaultに設定されていることを確認する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
<code>securityContext</code>を使用して、Pod定義でdocker/default seccompプロファイルを有効にします。以下はその例です：
securityContext:
seccompProfile:
type: RuntimeDefault</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="573-podおよびコンテナにsecuritycontextを適用する-手動">5.7.3 PodおよびコンテナにSecurityContextを適用する (手動)<a href="#573-podおよびコンテナにsecuritycontextを適用する-手動" class="hash-link" aria-label="5.7.3 PodおよびコンテナにSecurityContextを適用する (手動) への直接リンク" title="5.7.3 PodおよびコンテナにSecurityContextを適用する (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、PodにSecurityContextを適用します。推奨されるSecurityContextのリストについては、CIS Security Benchmark for Docker Containersを参照してください。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="574-デフォルトのネームスペースは使用しない-手動">5.7.4 デフォルトのネームスペースは使用しない (手動)<a href="#574-デフォルトのネームスペースは使用しない-手動" class="hash-link" aria-label="5.7.4 デフォルトのネームスペースは使用しない (手動) への直接リンク" title="5.7.4 デフォルトのネームスペースは使用しない (手動) への直接リンク" translate="no">​</a></h3>
<p><strong>結果:</strong> 警告</p>
<p><strong>修正方法:</strong>
Kubernetesリソースの適切な分離を可能にするためにネームスペースが作成されていることを確認し、すべての新しいリソースが特定のネームスペースに作成されるようにします。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/k3s-io/docs/edit/main/docs/security/self-assessment-1.23.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated"><b><time datetime="2025-10-24T17:17:36.000Z" itemprop="dateModified">2025年10月24日</time></b>に<!-- -->最終更新</span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="ドキュメントページ"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1112-etcdデータディレクトリの所有者がetcdに設定されていることを確認する自動化" class="table-of-contents__link toc-highlight">1.1.12 etcdデータディレクトリの所有者がetcdに設定されていることを確認する（自動化）</a></li><li><a href="#1113-adminconfファイルの権限が600以上に設定されていることを確認する自動化" class="table-of-contents__link toc-highlight">1.1.13 admin.confファイルの権限が600以上に設定されていることを確認する（自動化）</a></li><li><a href="#1114-adminconfファイルの所有者がrootに設定されていることを確認する自動化" class="table-of-contents__link toc-highlight">1.1.14 admin.confファイルの所有者がrootに設定されていることを確認する（自動化）</a></li><li><a href="#1115-schedulerconfファイルの権限が644以上に設定されていることを確認する自動化" class="table-of-contents__link toc-highlight">1.1.15 scheduler.confファイルの権限が644以上に設定されていることを確認する（自動化）</a></li><li><a href="#1116-schedulerconfファイルの所有者がrootに設定されていることを確認する自動化" class="table-of-contents__link toc-highlight">1.1.16 scheduler.confファイルの所有者がrootに設定されていることを確認する（自動化）</a></li><li><a href="#1117-コントローラーマネージャーconfファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化" class="table-of-contents__link toc-highlight">1.1.17 コントローラーマネージャー.confファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化）</a></li><li><a href="#1118-コントローラーマネージャーconfファイルの所有者がrootに設定されていることを確認する自動化" class="table-of-contents__link toc-highlight">1.1.18 コントローラーマネージャー.confファイルの所有者がrootに設定されていることを確認する（自動化）</a></li><li><a href="#1119-kubernetes-pkiディレクトリおよびファイルの所有者がrootに設定されていることを確認する自動化" class="table-of-contents__link toc-highlight">1.1.19 Kubernetes PKIディレクトリおよびファイルの所有者がrootに設定されていることを確認する（自動化）</a></li><li><a href="#1120-kubernetes-pki証明書ファイルのパーミッションが644またはそれ以上に制限されていることを確認する手動" class="table-of-contents__link toc-highlight">1.1.20 Kubernetes PKI証明書ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（手動）</a></li><li><a href="#1121-kubernetes-pkiキーのファイルパーミッションが600に設定されていることを確認する手動" class="table-of-contents__link toc-highlight">1.1.21 Kubernetes PKIキーのファイルパーミッションが600に設定されていることを確認する（手動）</a></li><li><a href="#12-apiサーバー" class="table-of-contents__link toc-highlight">1.2 APIサーバー</a><ul><li><a href="#121---anonymous-auth引数がfalseに設定されていることを確認する手動" class="table-of-contents__link toc-highlight">1.2.1 --anonymous-auth引数がfalseに設定されていることを確認する（手動）</a></li><li><a href="#122---token-auth-fileパラメータが設定されていないことを確認する自動化" class="table-of-contents__link toc-highlight">1.2.2 --token-auth-fileパラメータが設定されていないことを確認する（自動化）</a></li><li><a href="#123---denyserviceexternalipsが設定されていないことを確認する自動化" class="table-of-contents__link toc-highlight">1.2.3 --DenyServiceExternalIPsが設定されていないことを確認する（自動化）</a></li><li><a href="#124---kubelet-https引数がtrueに設定されていることを確認する自動化" class="table-of-contents__link toc-highlight">1.2.4 --kubelet-https引数がtrueに設定されていることを確認する（自動化）</a></li><li><a href="#125---kubelet-client-certificateおよび--kubelet-client-key引数が適切に設定されていることを確認する自動化" class="table-of-contents__link toc-highlight">1.2.5 --kubelet-client-certificateおよび--kubelet-client-key引数が適切に設定されていることを確認する（自動化）</a></li><li><a href="#126-ensure-that-the---kubelet-certificate-authority-argument-is-set-as-appropriate-automated" class="table-of-contents__link toc-highlight">1.2.6 Ensure that the --kubelet-certificate-authority argument is set as appropriate (Automated)</a></li><li><a href="#127-ensure-that-the---authorization-mode-argument-is-not-set-to-alwaysallow-automated" class="table-of-contents__link toc-highlight">1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow (Automated)</a></li><li><a href="#128-ensure-that-the---authorization-mode-argument-includes-node-automated" class="table-of-contents__link toc-highlight">1.2.8 Ensure that the --authorization-mode argument includes Node (Automated)</a></li><li><a href="#126-ensure-that-the---kubelet-certificate-authority-argument-is-set-as-appropriate-automated-1" class="table-of-contents__link toc-highlight">1.2.6 Ensure that the --kubelet-certificate-authority argument is set as appropriate (Automated)</a></li><li><a href="#127-ensure-that-the---authorization-mode-argument-is-not-set-to-alwaysallow-automated-1" class="table-of-contents__link toc-highlight">1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow (Automated)</a></li><li><a href="#129-ensure-that-the---authorization-mode-argument-includes-rbac-automated" class="table-of-contents__link toc-highlight">1.2.9 Ensure that the --authorization-mode argument includes RBAC (Automated)</a></li><li><a href="#1210-ensure-that-the-admission-control-plugin-eventratelimit-is-set-manual" class="table-of-contents__link toc-highlight">1.2.10 Ensure that the admission control plugin EventRateLimit is set (Manual)</a></li><li><a href="#1211-ensure-that-the-admission-control-plugin-alwaysadmit-is-not-set-automated" class="table-of-contents__link toc-highlight">1.2.11 Ensure that the admission control plugin AlwaysAdmit is not set (Automated)</a></li><li><a href="#1212-ensure-that-the-admission-control-plugin-alwayspullimages-is-set-manual" class="table-of-contents__link toc-highlight">1.2.12 Ensure that the admission control plugin AlwaysPullImages is set (Manual)</a></li><li><a href="#1213-ensure-that-the-admission-control-plugin-securitycontextdeny-is-set-if-podsecuritypolicy-is-not-used-manual" class="table-of-contents__link toc-highlight">1.2.13 Ensure that the admission control plugin SecurityContextDeny is set if PodSecurityPolicy is not used (Manual)</a></li><li><a href="#1214-ensure-that-the-admission-control-plugin-serviceaccount-is-set-automated" class="table-of-contents__link toc-highlight">1.2.14 Ensure that the admission control plugin ServiceAccount is set (Automated)</a></li><li><a href="#1215-namespacelifecycle-アドミッションコントロールプラグインが設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.15 NamespaceLifecycle アドミッションコントロールプラグインが設定されていることを確認する (自動化)</a></li><li><a href="#1216-noderestriction-アドミッションコントロールプラグインが設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.16 NodeRestriction アドミッションコントロールプラグインが設定されていることを確認する (自動化)</a></li><li><a href="#1217---secure-port-引数が-0-に設定されていないことを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.17 --secure-port 引数が 0 に設定されていないことを確認する (自動化)</a></li><li><a href="#1218---profiling-引数が-false-に設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.18 --profiling 引数が false に設定されていることを確認する (自動化)</a></li><li><a href="#1219---audit-log-path-引数が設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.19 --audit-log-path 引数が設定されていることを確認する (自動化)</a></li><li><a href="#1220---audit-log-maxage-引数が-30-または適切な値に設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.20 --audit-log-maxage 引数が 30 または適切な値に設定されていることを確認する (自動化)</a></li><li><a href="#1221---audit-log-maxbackup-引数が-10-または適切な値に設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.21 --audit-log-maxbackup 引数が 10 または適切な値に設定されていることを確認する (自動化)</a></li><li><a href="#1222---audit-log-maxsize-引数が-100-または適切な値に設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.22 --audit-log-maxsize 引数が 100 または適切な値に設定されていることを確認する (自動化)</a></li><li><a href="#1224---service-account-lookup-引数が-true-に設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.24 --service-account-lookup 引数が true に設定されていることを確認する (自動化)</a></li><li><a href="#1225---request-timeout-引数が適切に設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.25 --request-timeout 引数が適切に設定されていることを確認する (自動化)</a></li><li><a href="#1226---etcd-certfile-および---etcd-keyfile-引数が適切に設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.26 --etcd-certfile および --etcd-keyfile 引数が適切に設定されていることを確認する (自動化)</a></li><li><a href="#1227---tls-cert-file-および---tls-private-key-file-引数が適切に設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.27 <code>--tls-cert-file</code> および <code>--tls-private-key-file</code> 引数が適切に設定されていることを確認する (自動化)</a></li><li><a href="#1228---client-ca-file-引数が適切に設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.28 <code>--client-ca-file</code> 引数が適切に設定されていることを確認する (自動化)</a></li><li><a href="#1229---etcd-cafile-引数が適切に設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">1.2.29 <code>--etcd-cafile</code> 引数が適切に設定されていることを確認する (自動化)</a></li><li><a href="#1230-ensure-that-the---encryption-provider-config-argument-is-set-as-appropriate-manual" class="table-of-contents__link toc-highlight">1.2.30 Ensure that the --encryption-provider-config argument is set as appropriate (Manual)</a></li><li><a href="#1231-ensure-that-encryption-providers-are-appropriately-configured-manual" class="table-of-contents__link toc-highlight">1.2.31 Ensure that encryption providers are appropriately configured (Manual)</a></li><li><a href="#1232-ensure-that-the-api-server-only-makes-use-of-strong-cryptographic-ciphers-manual" class="table-of-contents__link toc-highlight">1.2.32 Ensure that the API Server only makes use of Strong Cryptographic Ciphers (Manual)</a></li></ul></li><li><a href="#13-controller-manager" class="table-of-contents__link toc-highlight">1.3 Controller Manager</a><ul><li><a href="#131-ensure-that-the---terminated-pod-gc-threshold-argument-is-set-as-appropriate-manual" class="table-of-contents__link toc-highlight">1.3.1 Ensure that the --terminated-pod-gc-threshold argument is set as appropriate (Manual)</a></li><li><a href="#132-ensure-that-the---profiling-argument-is-set-to-false-automated" class="table-of-contents__link toc-highlight">1.3.2 Ensure that the --profiling argument is set to false (Automated)</a></li><li><a href="#133-ensure-that-the---use-service-account-credentials-argument-is-set-to-true-automated" class="table-of-contents__link toc-highlight">1.3.3 Ensure that the --use-service-account-credentials argument is set to true (Automated)</a></li><li><a href="#134-ensure-that-the---service-account-private-key-file-argument-is-set-as-appropriate-automated" class="table-of-contents__link toc-highlight">1.3.4 Ensure that the --service-account-private-key-file argument is set as appropriate (Automated)</a></li><li><a href="#1231-適切に設定された暗号化プロバイダーを確認する-手動" class="table-of-contents__link toc-highlight">1.2.31 適切に設定された暗号化プロバイダーを確認する (手動)</a></li><li><a href="#1232-apiサーバーが強力な暗号化スイートのみを使用していることを確認する-手動" class="table-of-contents__link toc-highlight">1.2.32 APIサーバーが強力な暗号化スイートのみを使用していることを確認する (手動)</a></li></ul></li><li><a href="#13-コントローラーマネージャー" class="table-of-contents__link toc-highlight">1.3 コントローラーマネージャー</a><ul><li><a href="#131-適切に設定された---terminated-pod-gc-threshold-引数を確認する-手動" class="table-of-contents__link toc-highlight">1.3.1 適切に設定された --terminated-pod-gc-threshold 引数を確認する (手動)</a></li><li><a href="#132---profiling-引数が-false-に設定されていることを確認する-自動" class="table-of-contents__link toc-highlight">1.3.2 --profiling 引数が false に設定されていることを確認する (自動)</a></li><li><a href="#135-ensure-that-the---root-ca-file-argument-is-set-as-appropriate-automated" class="table-of-contents__link toc-highlight">1.3.5 Ensure that the --root-ca-file argument is set as appropriate (Automated)</a></li><li><a href="#136-ensure-that-the-rotatekubeletservercertificate-argument-is-set-to-true-automated" class="table-of-contents__link toc-highlight">1.3.6 Ensure that the RotateKubeletServerCertificate argument is set to true (Automated)</a></li><li><a href="#137-ensure-that-the---bind-address-argument-is-set-to-127001-automated" class="table-of-contents__link toc-highlight">1.3.7 Ensure that the --bind-address argument is set to 127.0.0.1 (Automated)</a></li></ul></li><li><a href="#14-scheduler" class="table-of-contents__link toc-highlight">1.4 Scheduler</a><ul><li><a href="#141-ensure-that-the---profiling-argument-is-set-to-false-automated" class="table-of-contents__link toc-highlight">1.4.1 Ensure that the --profiling argument is set to false (Automated)</a></li><li><a href="#142-ensure-that-the---bind-address-argument-is-set-to-127001-automated" class="table-of-contents__link toc-highlight">1.4.2 Ensure that the --bind-address argument is set to 127.0.0.1 (Automated)</a></li></ul></li><li><a href="#2-etcd-node-configuration" class="table-of-contents__link toc-highlight">2 Etcd Node Configuration</a><ul><li><a href="#21-ensure-that-the---cert-file-and---key-file-arguments-are-set-as-appropriate-automated" class="table-of-contents__link toc-highlight">2.1 Ensure that the --cert-file and --key-file arguments are set as appropriate (Automated)</a></li><li><a href="#22---client-cert-auth-引数が-true-に設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">2.2 --client-cert-auth 引数が true に設定されていることを確認する (自動化)</a></li><li><a href="#23---auto-tls-引数が-true-に設定されていないことを確認する-自動化" class="table-of-contents__link toc-highlight">2.3 --auto-tls 引数が true に設定されていないことを確認する (自動化)</a></li><li><a href="#24---peer-cert-file-および---peer-key-file-引数が適切に設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">2.4 --peer-cert-file および --peer-key-file 引数が適切に設定されていることを確認する (自動化)</a></li><li><a href="#25---peer-client-cert-auth-引数が-true-に設定されていることを確認する-自動化" class="table-of-contents__link toc-highlight">2.5 --peer-client-cert-auth 引数が true に設定されていることを確認する (自動化)</a></li><li><a href="#26---peer-auto-tls-引数が-true-に設定されていないことを確認する-自動化" class="table-of-contents__link toc-highlight">2.6 --peer-auto-tls 引数が true に設定されていないことを確認する (自動化)</a></li><li><a href="#27-etcd-に対して一意の証明書認証局が使用されていることを確認する-手動" class="table-of-contents__link toc-highlight">2.7 etcd に対して一意の証明書認証局が使用されていることを確認する (手動)</a></li></ul></li><li><a href="#31-認証と認可" class="table-of-contents__link toc-highlight">3.1 認証と認可</a><ul><li><a href="#311-クライアント証明書認証はユーザーに対して使用されるべきではない-手動" class="table-of-contents__link toc-highlight">3.1.1 クライアント証明書認証はユーザーに対して使用されるべきではない (手動)</a></li></ul></li><li><a href="#32-ロギング" class="table-of-contents__link toc-highlight">3.2 ロギング</a><ul><li><a href="#321-最小限の監査ポリシーが作成されていることを確認する-手動" class="table-of-contents__link toc-highlight">3.2.1 最小限の監査ポリシーが作成されていることを確認する (手動)</a></li><li><a href="#322-監査ポリシーが主要なセキュリティ問題をカバーしていることを確認する-手動" class="table-of-contents__link toc-highlight">3.2.2 監査ポリシーが主要なセキュリティ問題をカバーしていることを確認する (手動)</a></li><li><a href="#414-プロキシkubeconfigファイルが存在する場合所有者がrootに設定されていることを確認する手動" class="table-of-contents__link toc-highlight">4.1.4 プロキシkubeconfigファイルが存在する場合、所有者がrootに設定されていることを確認する（手動）</a></li><li><a href="#415---kubeconfig-kubeletconfファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化" class="table-of-contents__link toc-highlight">4.1.5 --kubeconfig kubelet.confファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化）</a></li><li><a href="#416---kubeconfig-kubeletconfファイルの所有者がrootに設定されていることを確認する自動化" class="table-of-contents__link toc-highlight">4.1.6 --kubeconfig kubelet.confファイルの所有者がrootに設定されていることを確認する（自動化）</a></li><li><a href="#417-証明書認証局ファイルのパーミッションが644またはそれ以上に制限されていることを確認する手動" class="table-of-contents__link toc-highlight">4.1.7 証明書認証局ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（手動）</a></li><li><a href="#418-クライアント証明書認証局ファイルの所有者がrootに設定されていることを確認する手動" class="table-of-contents__link toc-highlight">4.1.8 クライアント証明書認証局ファイルの所有者がrootに設定されていることを確認する（手動）</a></li><li><a href="#419-kubelet---config構成ファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化" class="table-of-contents__link toc-highlight">4.1.9 kubelet --config構成ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化）</a></li><li><a href="#4110-kubelet---config構成ファイルの所有者がrootに設定されていることを確認する自動化" class="table-of-contents__link toc-highlight">4.1.10 kubelet --config構成ファイルの所有者がrootに設定されていることを確認する（自動化）</a></li></ul></li><li><a href="#42-kubelet" class="table-of-contents__link toc-highlight">4.2 Kubelet</a><ul><li><a href="#421---anonymous-auth引数がfalseに設定されていることを確認する自動化" class="table-of-contents__link toc-highlight">4.2.1 --anonymous-auth引数がfalseに設定されていることを確認する（自動化）</a></li><li><a href="#422---authorization-mode引数がalwaysallowに設定されていないことを確認する自動化" class="table-of-contents__link toc-highlight">4.2.2 --authorization-mode引数がAlwaysAllowに設定されていないことを確認する（自動化）</a></li><li><a href="#423-ensure-that-the---client-ca-file-argument-is-set-as-appropriate-automated" class="table-of-contents__link toc-highlight">4.2.3 Ensure that the --client-ca-file argument is set as appropriate (Automated)</a></li><li><a href="#424-ensure-that-the---read-only-port-argument-is-set-to-0-manual" class="table-of-contents__link toc-highlight">4.2.4 Ensure that the --read-only-port argument is set to 0 (Manual)</a></li><li><a href="#425-ensure-that-the---streaming-connection-idle-timeout-argument-is-not-set-to-0-manual" class="table-of-contents__link toc-highlight">4.2.5 Ensure that the --streaming-connection-idle-timeout argument is not set to 0 (Manual)</a></li><li><a href="#426-ensure-that-the---protect-kernel-defaults-argument-is-set-to-true-automated" class="table-of-contents__link toc-highlight">4.2.6 Ensure that the --protect-kernel-defaults argument is set to true (Automated)</a></li><li><a href="#427-ensure-that-the---make-iptables-util-chains-argument-is-set-to-true-automated" class="table-of-contents__link toc-highlight">4.2.7 Ensure that the --make-iptables-util-chains argument is set to true (Automated)</a></li><li><a href="#428---hostname-override-引数が設定されていないことを確認する手動" class="table-of-contents__link toc-highlight">4.2.8 <code>--hostname-override</code> 引数が設定されていないことを確認する（手動）</a></li><li><a href="#429---event-qps-引数が-0-または適切なイベントキャプチャを確保するレベルに設定されていることを確認する手動" class="table-of-contents__link toc-highlight">4.2.9 <code>--event-qps</code> 引数が 0 または適切なイベントキャプチャを確保するレベルに設定されていることを確認する（手動）</a></li><li><a href="#4210---tls-cert-file-および---tls-private-key-file-引数が適切に設定されていることを確認する手動" class="table-of-contents__link toc-highlight">4.2.10 <code>--tls-cert-file</code> および <code>--tls-private-key-file</code> 引数が適切に設定されていることを確認する（手動）</a></li><li><a href="#4211---rotate-certificates-引数が-false-に設定されていないことを確認する自動" class="table-of-contents__link toc-highlight">4.2.11 <code>--rotate-certificates</code> 引数が <code>false</code> に設定されていないことを確認する（自動）</a></li><li><a href="#4212-rotatekubeletservercertificate-引数が-true-に設定されていることを確認する手動" class="table-of-contents__link toc-highlight">4.2.12 <code>RotateKubeletServerCertificate</code> 引数が <code>true</code> に設定されていることを確認する（手動）</a></li><li><a href="#4213-kubelet-が強力な暗号化スイートのみを使用していることを確認する手動" class="table-of-contents__link toc-highlight">4.2.13 Kubelet が強力な暗号化スイートのみを使用していることを確認する（手動）</a></li></ul></li><li><a href="#51-rbac-とサービスアカウント" class="table-of-contents__link toc-highlight">5.1 RBAC とサービスアカウント</a><ul><li><a href="#511-cluster-admin-ロールが必要な場合にのみ使用されていることを確認する手動" class="table-of-contents__link toc-highlight">5.1.1 <code>cluster-admin</code> ロールが必要な場合にのみ使用されていることを確認する（手動）</a></li><li><a href="#512-シークレットへのアクセスを最小限に抑える手動" class="table-of-contents__link toc-highlight">5.1.2 シークレットへのアクセスを最小限に抑える（手動）</a></li><li><a href="#513-ロールおよびクラスターロールでワイルドカードの使用を最小限に抑える手動" class="table-of-contents__link toc-highlight">5.1.3 ロールおよびクラスターロールでワイルドカードの使用を最小限に抑える（手動）</a></li><li><a href="#514-ポッドの作成アクセスを最小限に抑える手動" class="table-of-contents__link toc-highlight">5.1.4 ポッドの作成アクセスを最小限に抑える（手動）</a></li><li><a href="#515-デフォルトのサービスアカウントが積極的に使用されていないことを確認する手動" class="table-of-contents__link toc-highlight">5.1.5 デフォルトのサービスアカウントが積極的に使用されていないことを確認する（手動）</a></li><li><a href="#516-サービスアカウントトークンが必要な場合にのみマウントされることを確認する手動" class="table-of-contents__link toc-highlight">5.1.6 サービスアカウントトークンが必要な場合にのみマウントされることを確認する（手動）</a></li><li><a href="#517-systemmasters-グループの使用を避ける手動" class="table-of-contents__link toc-highlight">5.1.7 <code>system:masters</code> グループの使用を避ける（手動）</a></li><li><a href="#518-kubernetes-クラスター内での-bindimpersonateおよび-escalate-権限の使用を制限する手動" class="table-of-contents__link toc-highlight">5.1.8 Kubernetes クラスター内での <code>Bind</code>、<code>Impersonate</code>、および <code>Escalate</code> 権限の使用を制限する（手動）</a></li></ul></li><li><a href="#52-ポッドセキュリティ基準" class="table-of-contents__link toc-highlight">5.2 ポッドセキュリティ基準</a><ul><li><a href="#521-クラスターに少なくとも1つのアクティブなポリシー制御メカニズムが存在することを確認する手動" class="table-of-contents__link toc-highlight">5.2.1 クラスターに少なくとも1つのアクティブなポリシー制御メカニズムが存在することを確認する（手動）</a></li><li><a href="#522-特権コンテナの許可を最小限に抑える自動" class="table-of-contents__link toc-highlight">5.2.2 特権コンテナの許可を最小限に抑える（自動）</a></li><li><a href="#523-ホストプロセスidネームスペースを共有しようとするコンテナの許可を最小限に抑える自動" class="table-of-contents__link toc-highlight">5.2.3 ホストプロセスIDネームスペースを共有しようとするコンテナの許可を最小限に抑える（自動）</a></li><li><a href="#524-ホストipcネームスペースを共有しようとするコンテナの許可を最小限に抑える自動" class="table-of-contents__link toc-highlight">5.2.4 ホストIPCネームスペースを共有しようとするコンテナの許可を最小限に抑える（自動）</a></li><li><a href="#525-ホストネットワークネームスペースを共有しようとするコンテナのアドミッションを最小限に抑える-自動化" class="table-of-contents__link toc-highlight">5.2.5 ホストネットワークネームスペースを共有しようとするコンテナのアドミッションを最小限に抑える (自動化)</a></li><li><a href="#526-allowprivilegeescalationを持つコンテナのアドミッションを最小限に抑える-自動化" class="table-of-contents__link toc-highlight">5.2.6 allowPrivilegeEscalationを持つコンテナのアドミッションを最小限に抑える (自動化)</a></li><li><a href="#527-ルートコンテナのアドミッションを最小限に抑える-自動化" class="table-of-contents__link toc-highlight">5.2.7 ルートコンテナのアドミッションを最小限に抑える (自動化)</a></li><li><a href="#528-net_raw機能を持つコンテナのアドミッションを最小限に抑える-自動化" class="table-of-contents__link toc-highlight">5.2.8 NET_RAW機能を持つコンテナのアドミッションを最小限に抑える (自動化)</a></li><li><a href="#529-追加された機能を持つコンテナのアドミッションを最小限に抑える-自動化" class="table-of-contents__link toc-highlight">5.2.9 追加された機能を持つコンテナのアドミッションを最小限に抑える (自動化)</a></li><li><a href="#5210-機能が割り当てられたコンテナのアドミッションを最小限に抑える-手動" class="table-of-contents__link toc-highlight">5.2.10 機能が割り当てられたコンテナのアドミッションを最小限に抑える (手動)</a></li><li><a href="#5211-windows-hostprocessコンテナのアドミッションを最小限に抑える-手動" class="table-of-contents__link toc-highlight">5.2.11 Windows HostProcessコンテナのアドミッションを最小限に抑える (手動)</a></li><li><a href="#5212-hostpathボリュームのアドミッションを最小限に抑える-手動" class="table-of-contents__link toc-highlight">5.2.12 HostPathボリュームのアドミッションを最小限に抑える (手動)</a></li><li><a href="#5213-hostportsを使用するコンテナのアドミッションを最小限に抑える-手動" class="table-of-contents__link toc-highlight">5.2.13 HostPortsを使用するコンテナのアドミッションを最小限に抑える (手動)</a></li></ul></li><li><a href="#53-ネットワークポリシーとcni" class="table-of-contents__link toc-highlight">5.3 ネットワークポリシーとCNI</a><ul><li><a href="#531-使用中のcniがネットワークポリシーをサポートしていることを確認する-手動" class="table-of-contents__link toc-highlight">5.3.1 使用中のCNIがネットワークポリシーをサポートしていることを確認する (手動)</a></li><li><a href="#532-すべてのネームスペースにネットワークポリシーが定義されていることを確認する-手動" class="table-of-contents__link toc-highlight">5.3.2 すべてのネームスペースにネットワークポリシーが定義されていることを確認する (手動)</a></li></ul></li><li><a href="#54-シークレット管理" class="table-of-contents__link toc-highlight">5.4 シークレット管理</a><ul><li><a href="#541-環境変数としてのシークレットよりもファイルとしてのシークレットを使用することを推奨する-手動" class="table-of-contents__link toc-highlight">5.4.1 環境変数としてのシークレットよりもファイルとしてのシークレットを使用することを推奨する (手動)</a></li><li><a href="#542-外部シークレットストレージを検討する-手動" class="table-of-contents__link toc-highlight">5.4.2 外部シークレットストレージを検討する (手動)</a></li></ul></li><li><a href="#55-拡張可能なアドミッションコントロール" class="table-of-contents__link toc-highlight">5.5 拡張可能なアドミッションコントロール</a><ul><li><a href="#551-imagepolicywebhookアドミッションコントローラーを使用してイメージの出所を設定する-手動" class="table-of-contents__link toc-highlight">5.5.1 ImagePolicyWebhookアドミッションコントローラーを使用してイメージの出所を設定する (手動)</a></li></ul></li><li><a href="#57-一般的なポリシー" class="table-of-contents__link toc-highlight">5.7 一般的なポリシー</a><ul><li><a href="#571-ネームスペースを使用してリソース間に管理境界を作成する-手動" class="table-of-contents__link toc-highlight">5.7.1 ネームスペースを使用してリソース間に管理境界を作成する (手動)</a></li><li><a href="#572-pod定義でseccompプロファイルがdockerdefaultに設定されていることを確認する-手動" class="table-of-contents__link toc-highlight">5.7.2 Pod定義でseccompプロファイルがdocker/defaultに設定されていることを確認する (手動)</a></li><li><a href="#573-podおよびコンテナにsecuritycontextを適用する-手動" class="table-of-contents__link toc-highlight">5.7.3 PodおよびコンテナにSecurityContextを適用する (手動)</a></li><li><a href="#574-デフォルトのネームスペースは使用しない-手動" class="table-of-contents__link toc-highlight">5.7.4 デフォルトのネームスペースは使用しない (手動)</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 K3s Project Authors. All rights reserved. <br>The Linux Foundation has registered trademarks
      and uses trademarks. For a list of trademarks of The Linux Foundation, 
      please see our <a href="https://www.linuxfoundation.org/trademark-usage"> Trademark Usage</a> page.</div></div></div></footer></div>
</body>
</html>