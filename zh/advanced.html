<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-advanced" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">高级选项和配置 | K3s</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.k3s.io/zh/advanced"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" property="og:locale:alternate" content="kr"><meta data-rh="true" property="og:locale:alternate" content="ja"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="高级选项和配置 | K3s"><meta data-rh="true" name="description" content="本文描述了用于运行和管理 K3s 的高级设置，以及为 K3s 准备主机操作系统所需的步骤。"><meta data-rh="true" property="og:description" content="本文描述了用于运行和管理 K3s 的高级设置，以及为 K3s 准备主机操作系统所需的步骤。"><link data-rh="true" rel="icon" href="/zh/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.k3s.io/zh/advanced"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/advanced" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/zh/advanced" hreflang="zh"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/kr/advanced" hreflang="kr"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/ja/advanced" hreflang="ja"><link data-rh="true" rel="alternate" href="https://docs.k3s.io/advanced" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="K3s RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="K3s Atom Feed"><link rel="stylesheet" href="/zh/assets/css/styles.dffee271.css">
<script src="/zh/assets/js/runtime~main.1428b873.js" defer="defer"></script>
<script src="/zh/assets/js/main.ddd28de7.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><div class="navbar__logo"><img src="/zh/img/k3s-logo-light.svg" alt="logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zh/img/k3s-logo-dark.svg" alt="logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="搜索" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/advanced" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/zh/advanced" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">简体中文</a></li><li><a href="/kr/advanced" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="kr">한국어</a></li><li><a href="/ja/advanced" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ja">日本語</a></li></ul></div><a class="navbar__item navbar__link navbar__icon navbar__blog" href="/zh/blog">Blog</a><a href="https://github.com/k3s-io/k3s/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__icon navbar__github">GitHub</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh/">K3s - 轻量级 Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh/quick-start">快速入门指南</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh/installation">安装</a><button aria-label="展开侧边栏分类 &#x27;安装&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh/datastore">集群数据 存储</a><button aria-label="展开侧边栏分类 &#x27;集群数据存储&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh/upgrades">升级</a><button aria-label="展开侧边栏分类 &#x27;升级&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh/security">安全</a><button aria-label="展开侧边栏分类 &#x27;安全&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh/cli">CLI 工具</a><button aria-label="展开侧边栏分类 &#x27;CLI 工具&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh/architecture">架构</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh/cluster-access">集群访问</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh/storage">卷和存储</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh/networking">Networking</a><button aria-label="展开侧边栏分类 &#x27;Networking&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh/helm">Helm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/zh/advanced">高级选项和配置</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/zh/reference/env-variables">参考</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/zh/release-notes/v1.32.X">Release Notes</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh/related-projects">Related Projects</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh/known-issues">已知问题</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh/faq">常见问题</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/zh/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">高级选项和配置</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>高级选项和配置</h1></header><p>本文描述了用于运行和管理 K3s 的高级设置，以及为 K3s 准备主机操作系统所需的步骤。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="证书管理">证书管理<a href="#证书管理" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ca-证书">CA 证书<a href="#ca-证书" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3>
<p>K3s 在第一个 Server 节点启动时生成自签名 CA 证书。这些 CA 证书的有效期为 10 年，不会自动更新。</p>
<p>有关使用自定义 CA 证书或更新自签名 CA 证书的信息，请参阅 <a href="/zh/cli/certificate#certificate-authority-ca-certificates"><code>k3s certificate rotate-ca</code> 命令文档</a>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="客户端和服务器证书">客户端和服务器证书<a href="#客户端和服务器证书" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3>
<p>K3s 客户端和服务器证书自颁发日起 365 天内有效。  每次启动 K3s 时，已过期或 90 天内过期的证书都会自动更新。</p>
<p>有关手动轮换客户端和服务器证书的信息，请参阅 <a href="/zh/cli/certificate#client-and-server-certificates"><code>k3s certificate rotate</code> 命令文档</a>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="token-管理">Token 管理<a href="#token-管理" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<p>默认情况下，K3s 为 Server 和 Agent 使用单个静态 Token。创建集群后不能更改此 Token。
你可以启用只能用于加入 Agent 的第二个静态 Token，或创建自动过期的临时 <code>kubeadm</code> 联接样式 Token。
有关详细信息，请参阅 <a href="/zh/cli/token"><code>k3s token</code> 命令文档</a>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置-http-代理">配置 HTTP 代理<a href="#配置-http-代理" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<p>如果你运行 K3s 的环境中只通过 HTTP 代理进行外部连接，你可以在 K3s 的 systemd 服务上配置代理。K3s 将使用这些代理设置，并向下传递到嵌入式 containerd 和 kubelet。</p>
<p>K3s 安装脚本会自动使用当前 shell 中的 <code>HTTP_PROXY</code>、<code>HTTPS_PROXY</code> 和 <code>NO_PROXY</code>，以及 <code>CONTAINERD_HTTP_PROXY</code>、<code>CONTAINERD_HTTPS_PROXY</code> 和 <code>CONTAINERD_NO_PROXY</code> 变量（如果存在），并将它们写入 systemd 服务的环境文件，通常是：</p>
<ul>
<li><code>/etc/systemd/system/k3s.service.env</code></li>
<li><code>/etc/systemd/system/k3s-agent.service.env</code></li>
</ul>
<p>你也可以通过编辑这些文件来配置代理。</p>
<p>K3s 会自动将集群内部 Pod 和 Service IP 范围以及集群 DNS 域添加到 <code>NO_PROXY</code> 条目列表中。你需要确保 Kubernetes 节点本身使用的 IP 地址范围（即节点的公共和私有 IP）包含在 <code>NO_PROXY</code> 列表中，或者可以通过代理访问节点。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTP_PROXY=http://your-proxy.example.com:8888</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTPS_PROXY=http://your-proxy.example.com:8888</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NO_PROXY=127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果你想在不影响 K3s 和 Kubelet 的情况下为 containerd 配置代理，你可以在变量前加上 <code>CONTAINERD_</code>：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CONTAINERD_HTTP_PROXY=http://your-proxy.example.com:8888</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CONTAINERD_HTTPS_PROXY=http://your-proxy.example.com:8888</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CONTAINERD_NO_PROXY=127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用-docker-作为容器运行时">使用 Docker 作为容器运行时<a href="#使用-docker-作为容器运行时" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<p>K3s 包含并默认为 <a href="https://containerd.io/" target="_blank" rel="noopener noreferrer">containerd</a>，它是一个行业标准的容器运行时。
从 Kubernetes 1.24 开始，Kubelet 不再包含 dockershim，该组件允许 kubelet 与 dockerd 通信。
K3s 1.24 及更高版本包括了 <a href="https://github.com/Mirantis/cri-dockerd" target="_blank" rel="noopener noreferrer">cri-dockerd</a>，它允许你无缝升级旧的 K3s 版本，同时继续使用 Docker 容器运行时。</p>
<p>要使用 Docker 而不是 containerd：</p>
<ol>
<li>
<p>在 K3s 节点上安装 Docker。你可以使用 Rancher 的一个 <a href="https://github.com/rancher/install-docker" target="_blank" rel="noopener noreferrer">Docker 安装脚本</a>来安装 Docker：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">curl https://releases.rancher.com/install-docker/20.10.sh | sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>使用 <code>--docker</code> 选项安装 K3s：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">curl -sfL https://get.k3s.io | sh -s - --docker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>确认集群可用：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ sudo k3s kubectl get pods --all-namespaces</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NAMESPACE     NAME                                     READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   local-path-provisioner-6d59f47c7-lncxn   1/1     Running     0          51s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   metrics-server-7566d596c8-9tnck          1/1     Running     0          51s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   helm-install-traefik-mbkn9               0/1     Completed   1          51s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   coredns-8655855d6-rtbnb                  1/1     Running     0          51s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   svclb-traefik-jbmvl                      2/2     Running     0          43s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   traefik-758cd5fc85-2wz97                 1/1     Running     0          43s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>确认 Docker 容器正在运行：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ sudo docker ps</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CONTAINER ID        IMAGE                     COMMAND                  CREATED              STATUS              PORTS               NAMES</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3e4d34729602        897ce3c5fc8f              &quot;entry&quot;                  About a minute ago   Up About a minute                       k8s_lb-port-443_svclb-traefik-jbmvl_kube-system_d46f10c6-073f-4c7e-8d7a-8e7ac18f9cb0_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bffdc9d7a65f        rancher/klipper-lb        &quot;entry&quot;                  About a minute ago   Up About a minute                       k8s_lb-port-80_svclb-traefik-jbmvl_kube-system_d46f10c6-073f-4c7e-8d7a-8e7ac18f9cb0_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">436b85c5e38d        rancher/library-traefik   &quot;/traefik --configfi…&quot;   About a minute ago   Up About a minute                       k8s_traefik_traefik-758cd5fc85-2wz97_kube-system_07abe831-ffd6-4206-bfa1-7c9ca4fb39e7_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">de8fded06188        rancher/pause:3.1         &quot;/pause&quot;                 About a minute ago   Up About a minute                       k8s_POD_svclb-traefik-jbmvl_kube-system_d46f10c6-073f-4c7e-8d7a-8e7ac18f9cb0_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">7c6a30aeeb2f        rancher/pause:3.1         &quot;/pause&quot;                 About a minute ago   Up About a minute                       k8s_POD_traefik-758cd5fc85-2wz97_kube-system_07abe831-ffd6-4206-bfa1-7c9ca4fb39e7_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ae6c58cab4a7        9d12f9848b99              &quot;local-path-provisio…&quot;   About a minute ago   Up About a minute                       k8s_local-path-provisioner_local-path-provisioner-6d59f47c7-lncxn_kube-system_2dbd22bf-6ad9-4bea-a73d-620c90a6c1c1_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">be1450e1a11e        9dd718864ce6              &quot;/metrics-server&quot;        About a minute ago   Up About a minute                       k8s_metrics-server_metrics-server-7566d596c8-9tnck_kube-system_031e74b5-e9ef-47ef-a88d-fbf3f726cbc6_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4454d14e4d3f        c4d3d16fe508              &quot;/coredns -conf /etc…&quot;   About a minute ago   Up About a minute                       k8s_coredns_coredns-8655855d6-rtbnb_kube-system_d05725df-4fb1-410a-8e82-2b1c8278a6a1_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">c3675b87f96c        rancher/pause:3.1         &quot;/pause&quot;                 About a minute ago   Up About a minute                       k8s_POD_coredns-8655855d6-rtbnb_kube-system_d05725df-4fb1-410a-8e82-2b1c8278a6a1_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4b1fddbe6ca6        rancher/pause:3.1         &quot;/pause&quot;                 About a minute ago   Up About a minute                       k8s_POD_local-path-provisioner-6d59f47c7-lncxn_kube-system_2dbd22bf-6ad9-4bea-a73d-620c90a6c1c1_0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">64d3517d4a95        rancher/pause:3.1         &quot;/pause&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用-etcdctl">使用 etcdctl<a href="#使用-etcdctl" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<p>etcdctl 提供了一个与 etcd 服务器交互的 CLI。K3s 附带 etcdctl。</p>
<p>如果你想使用 etcdctl 与 K3s 的嵌入式 etcd 进行交互，请参阅<a href="https://etcd.io/docs/latest/install/" target="_blank" rel="noopener noreferrer">官方文档</a>安装 etcdctl。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ETCD_VERSION=&quot;v3.5.5&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ETCD_URL=&quot;https://github.com/etcd-io/etcd/releases/download/${ETCD_VERSION}/etcd-${ETCD_VERSION}-linux-amd64.tar.gz&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">curl -sL ${ETCD_URL} | sudo tar -zxv --strip-components=1 -C /usr/local/bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后，你可以将 etcdctl 配置为使用 K3s 管理的证书和密钥来进行身份验证，从而使用 etcdctl：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo etcdctl version \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --cacert=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --cert=/var/lib/rancher/k3s/server/tls/etcd/client.crt \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --key=/var/lib/rancher/k3s/server/tls/etcd/client.key</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置-containerd">配置 Containerd<a href="#配置-containerd" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<p>K3s 会在 <code>/var/lib/rancher/k3s/agent/etc/containerd/config.toml</code> 中为 containerd 生成 config.toml。</p>
<p>如果要对这个文件进行高级定制，你可以在同一目录中创建另一个名为 <code>config.toml.tmpl</code> 的文件，此文件将会代替默认设置。</p>
<p><code>config.toml.tmpl</code> 是一个 Go 模板文件，并且 <code>config.Node</code> 结构会被传递给模板。有关如何使用该结构自定义配置文件的 Linux 和 Windows 示例，请参阅<a href="https://github.com/k3s-io/k3s/blob/master/pkg/agent/templates" target="_blank" rel="noopener noreferrer">此文件夹</a>。
config.Node golang 结构定义在<a href="https://github.com/k3s-io/k3s/blob/master/pkg/daemons/config/types.go#L37" target="_blank" rel="noopener noreferrer">这里</a>。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="nvidia-容器运行时支持">NVIDIA 容器运行时支持<a href="#nvidia-容器运行时支持" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<p>如果 NVIDIA 容器运行时在 K3s 启动时存在，K3s 将自动检测并配置它。</p>
<ol>
<li>按照以下说明在节点上安装 nvidia-container 包仓库：
<a href="https://nvidia.github.io/libnvidia-container/" target="_blank" rel="noopener noreferrer">https://nvidia.github.io/libnvidia-container/</a></li>
<li>安装 nvidia 容器运行时包。例如：
<code>apt install -y nvidia-container-runtime cuda-drivers-fabricmanager-515 nvidia-headless-515-server</code></li>
<li>安装 K3s，如果已经安装则重启它：
<code>curl -ksL get.k3s.io | sh -</code></li>
<li>确认 K3s 已经找到 nvidia 容器运行时：
<code>grep nvidia /var/lib/rancher/k3s/agent/etc/containerd/config.toml</code></li>
</ol>
<p>这将根据找到的运行时可执行文件自动将 <code>nvidia</code> 和/或 <code>nvidia-experimental</code> 运行时添加到 containerd 配置中。
你仍然必须向集群添加 RuntimeClass 定义，并通过在 Pod 规范中设置 <code>runtimeClassName: nvidia</code> 来部署显式请求运行时的 Pod：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> node.k8s.io/v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> RuntimeClass</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nvidia</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nvidia</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nbody</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">gpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">benchmark</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">restartPolicy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> OnFailure</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">runtimeClassName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nvidia</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cuda</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nvcr.io/nvidia/k8s/cuda</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">sample</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">nbody</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;nbody&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-gpu&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;-benchmark&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">limits</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> NVIDIA_VISIBLE_DEVICES</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> all</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> NVIDIA_DRIVER_CAPABILITIES</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>请注意，NVIDIA Container Runtime 也经常与 <a href="https://github.com/NVIDIA/k8s-device-plugin/" target="_blank" rel="noopener noreferrer">NVIDIA Device Plugin</a> 和 <a href="https://github.com/NVIDIA/gpu-feature-discovery/" target="_blank" rel="noopener noreferrer">GPU Feature Discovery</a> 一起使用，它们必须单独安装，而且需要修改以确保 Pod 规范能包括 <code>runtimeClassName: nvidia</code>，如前所述。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="运行无-agent-的-server实验性">运行无 Agent 的 Server（实验性）<a href="#运行无-agent-的-server实验性" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<blockquote>
<p><strong>警告</strong>：此功能是实验性的。</p>
</blockquote>
<p>当使用 <code>--disable-agent</code> 标志启动时，Server 不运行 kubelet、容器运行时或 CNI。它们不会在集群中注册 Node 资源，也不会出现在 <code>kubectl get nodes</code> 输出中。
因为它们不托管 kubelet，所以它们不能运行 pod，也不能由依赖枚举集群节点的 Operator 管理，包括嵌入式 etcd controller 和 system-upgrade-controller。</p>
<p>如果你想让 control plane 节点不被 Agent 和工作负载发现，你可以运行无 Agent 的 Server，但是代价是由于缺乏集群 Operator 支持，管理开销会增加。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用-rootless-模式运行-server实验性">使用 Rootless 模式运行 Server（实验性）<a href="#使用-rootless-模式运行-server实验性" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<blockquote>
<p><strong>警告</strong>：此功能是实验性的。</p>
</blockquote>
<p>Rootless 模式允许非特权用户运行 K3s Server，这样可以保护主机上真正的 root 免受潜在的容器攻击。</p>
<p>有关 Rootless 模式 Kubernetes 的更多信息，请参阅<a href="https://rootlesscontaine.rs/" target="_blank" rel="noopener noreferrer">此处</a>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rootless-模式的已知问题">Rootless 模式的已知问题<a href="#rootless-模式的已知问题" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3>
<ul>
<li>
<p><strong>端口</strong></p>
<p>如果以 Rootless 模式运行，将创建一个新的网络命名空间。换言之，K3s 实例在网络与主机完全分离的情况下运行。
要从主机访问在 K3s 中运行的 Service，唯一的方法是设置转发到 K3s 网络命名空间的端口。
Rootless 模式下的 K3s 包含控制器，它会自动将 6443 和低于 1024 的 Service 端口绑定到偏移量为 10000 的主机。</p>
<p>例如，端口 80 上的 Service 在主机上会变成 10080，但 8080 会变成 8080，没有任何偏移。目前只有 LoadBalancer Service 是自动绑定的。</p>
</li>
<li>
<p><strong>Cgroups</strong></p>
<p>不支持 Cgroup v1 和 Hybrid v1/v2，仅支持纯 Cgroup v2。如果 K3s 在 Rootless 模式下运行时由于缺少 cgroup 而无法启动，很可能你的节点处于 Hybrid 模式，而且“丢失”的 cgroup 仍然绑定了 v1 控制器。</p>
</li>
<li>
<p><strong>多节点/多进程集群</strong></p>
<p>目前，我们不支持多节点无根集群或同一节点上的多个无根 k3s 进程。有关详细信息，请参阅 <a href="https://github.com/k3s-io/k3s/issues/6488#issuecomment-1314998091" target="_blank" rel="noopener noreferrer">#6488</a>。</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动-rootless-server">启动 Rootless Server<a href="#启动-rootless-server" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3>
<ul>
<li>
<p>启用 cgroup v2 授权，请参阅 <a href="https://rootlesscontaine.rs/getting-started/common/cgroup2/%E3%80%82" target="_blank" rel="noopener noreferrer">https://rootlesscontaine.rs/getting-started/common/cgroup2/。</a>
此步骤是必需的。如果没有正确的 cgroups 授权，rootless kubelet 将无法启动。</p>
</li>
<li>
<p>从 <a href="https://github.com/k3s-io/k3s/blob/master/k3s-rootless.service" target="_blank" rel="noopener noreferrer"><code>https://github.com/k3s-io/k3s/blob/&lt;VERSION&gt;/k3s-rootless.service</code></a> 下载 <code>k3s-rootless.service</code>。
确保使用了相同版本的 <code>k3s-rootless.service</code> 和 <code>k3s</code>。</p>
</li>
<li>
<p>将 <code>k3s-rootless.service</code> 安装到 <code>~/.config/systemd/user/k3s-rootless.service</code>。
不支持将此文件安装为全系统服务 (<code>/etc/systemd/...</code>)。
根据 <code>k3s</code> 二进制文件的路径，你可能需要修改文件的 <code>ExecStart=/usr/local/bin/k3s ...</code> 行。</p>
</li>
<li>
<p>运行 <code>systemctl --user daemon-reload</code></p>
</li>
<li>
<p>运行 <code>systemctl --user enable --now k3s-rootless</code></p>
</li>
<li>
<p>运行 <code>KUBECONFIG=~/.kube/k3s.yaml kubectl get pods -A</code>，并确保 Pod 正在运行。</p>
</li>
</ul>
<blockquote>
<p><strong>注意</strong>：由于终端会话不允许 cgroup v2 授权，因此不要尝试在终端上运行 <code>k3s server --rootless</code>。
如果你确实需要在终端上使用，请使用 <code>systemd-run --user -p Delegate=yes --tty k3s server --rooless</code> 将其包装在 systemd 范围内。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="高级无根配置">高级无根配置<a href="#高级无根配置" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3>
<p>Rootless K3s 使用 <a href="https://github.com/rootless-containers/rootlesskit" target="_blank" rel="noopener noreferrer">rootlesskit</a> 和 <a href="https://github.com/rootless-containers/slirp4netns" target="_blank" rel="noopener noreferrer">slirp4netns</a> 在主机和用户网络命名空间之间进行通信。
rootlesskit 和 slirp4nets 使用的一些配置可以通过环境变量来设置。设置它们的最佳方法是将它们添加到 k3s-rootless systemd 单元的 <code>Environment</code> 字段中。</p>
<table><thead><tr><th>变量</th><th>默认</th><th>描述</th></tr></thead><tbody><tr><td><code>K3S_ROOTLESS_MTU</code></td><td>1500</td><td>为 slirp4netns 虚拟接口设置 MTU。</td></tr><tr><td><code>K3S_ROOTLESS_CIDR</code></td><td>10.41.0.0/16</td><td>设置 slirp4netns 虚拟接口使用的 CIDR。</td></tr><tr><td><code>K3S_ROOTLESS_ENABLE_IPV6</code></td><td>autotedected</td><td>启用 slirp4netns IPv6 支持。如果未指定，则在 K3s 配置为双栈时自动启用。</td></tr><tr><td><code>K3S_ROOTLESS_PORT_DRIVER</code></td><td>builtin</td><td>选择无根 port driver，可选值是 <code>builtin</code> 或 <code>slirp4netns</code>。<code>builtin</code> 速度更快，但会伪装入站数据包的原始源地址。</td></tr><tr><td><code>K3S_ROOTLESS_DISABLE_HOST_LOOPBACK</code></td><td>true</td><td>控制是否允许通过网关接口访问主机的环回地址。出于安全原因，建议不要更改此设置。</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rootless-模式故障排除">Rootless 模式故障排除<a href="#rootless-模式故障排除" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3>
<ul>
<li>运行 <code>systemctl --user status k3s-rootless</code> 来检查 daemon 状态</li>
<li>运行 <code>journalctl --user -f -u k3s-rootless</code> 来查看​​ daemon 日志</li>
<li>另见 <a href="https://rootlesscontaine.rs/" target="_blank" rel="noopener noreferrer">https://rootlesscontaine.rs/</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="节点标签和污点">节点标签和污点<a href="#节点标签和污点" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<p>K3s Agent 可以通过 <code>--node-label</code> 和 <code>--node-taint</code> 选项来配置，它们会为 kubelet 添加标签和污点。这两个选项仅在<a href="/zh/cli/agent#agent-%E7%9A%84%E8%8A%82%E7%82%B9%E6%A0%87%E7%AD%BE%E5%92%8C%E6%B1%A1%E7%82%B9">注册时</a>添加标签和/或污点，因此只能在节点首次加入集群时设置。</p>
<p>当前所有的 Kubernetes 版本都限制节点注册到带有 <code>kubernetes.io</code> 和 <code>k8s.io</code> 前缀的大部分标签，特别是 <code>kubernetes.io/role</code> 标签。如果你尝试启动带有不允许的标签的节点，K3s 将无法启动。正如 Kubernetes 作者所说：</p>
<blockquote>
<p>不允许节点断言自己的角色标签。节点角色通常用于识别节点的特权或 control plane 类型，如果允许节点将自己标记到该池，那么受感染的节点将能吸引可授予更高特权凭证访问权限的工作负载（如 control plane 守护进程）。</p>
</blockquote>
<p>有关详细信息，请参阅 <a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-auth/279-limit-node-access/README.md" target="_blank" rel="noopener noreferrer">SIG-Auth KEP 279</a>。</p>
<p>如果你想在节点注册后更改节点标签和污点，或者添加保留标签，请使用 <code>kubectl</code>。关于如何添加<a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/" target="_blank" rel="noopener noreferrer">污点</a>和<a href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#add-a-label-to-a-node" target="_blank" rel="noopener noreferrer">节点标签</a>的详细信息，请参阅官方 Kubernetes 文档。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用安装脚本启动服务">使用安装脚本启动服务<a href="#使用安装脚本启动服务" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<p>安装脚本将自动检测你的操作系统使用的是 systemd 还是 openrc，并在安装过程中启动该服务。</p>
<ul>
<li>使用 openrc 运行时，将在 <code>/var/log/k3s.log</code> 中创建日志。</li>
<li>使用 systemd 运行时，将在 <code>/var/log/syslog</code> 中创建日志，你可以通过 <code>journalctl -u k3s</code>（Agent 上是 <code>journalctl -u k3s-agent</code>）查看日志。</li>
</ul>
<p>使用安装脚本禁用自动启动和服务启用的示例：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">curl -sfL https://get.k3s.io | INSTALL_K3S_SKIP_START=true INSTALL_K3S_SKIP_ENABLE=true sh -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="其他操作系统准备">其他操作系统准备<a href="#其他操作系统准备" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="旧的-iptables-版本">旧的 iptables 版本<a href="#旧的-iptables-版本" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3>
<p>几个主流 Linux 发行版发布的 iptables 版本包含一个错误，该错误会导致重复规则的累积，从而对节点的性能和稳定性产生负面影响。有关如何确定你是否受此问题影响，请参阅 <a href="https://github.com/k3s-io/k3s/issues/3117" target="_blank" rel="noopener noreferrer">issue #3117</a>。</p>
<p>K3s 具有一个可以正常运行的 iptables (v1.8.8) 版本。你可以通过使用 <code>--prefer-bundled-bin</code> 选项来启动 K3s，或从操作系统中卸载 iptables/nftables 包，从而让 K3s 使用捆绑的 iptables 版本。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>版本</div><div class="admonitionContent_BuS1"><p><code>--prefer-bundled-bin</code> 标志从 2022-12 版本开始可用（v1.26.0+k3s1、v1.25.5+k3s1、v1.24.9+k3s1、v1.23.15+k3s1）。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="red-hat-enterprise-linux--centos">Red Hat Enterprise Linux / CentOS<a href="#red-hat-enterprise-linux--centos" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3>
<p>建议关闭 firewalld：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl disable firewalld --now</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果要保持启用 firewalld，默认情况下需要以下规则：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">firewall-cmd --permanent --add-port=6443/tcp #apiserver</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">firewall-cmd --permanent --zone=trusted --add-source=10.42.0.0/16 #pods</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">firewall-cmd --permanent --zone=trusted --add-source=10.43.0.0/16 #services</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">firewall-cmd --reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>你可能还需要打开其他端口。有关详细信息，请参阅<a href="/zh/installation/requirements#k3s-server-%E8%8A%82%E7%82%B9%E7%9A%84%E5%85%A5%E7%AB%99%E8%A7%84%E5%88%99">入站规则</a>。如果更改了 pod 或服务的默认 CIDR，则需要相应地更新防火墙规则。</p>
<p>如果启用，则需要禁用 nm-cloud-setup 并重新启动节点：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">systemctl disable nm-cloud-setup.service nm-cloud-setup.timer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">reboot</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ubuntu">Ubuntu<a href="#ubuntu" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3>
<p>建议关闭 ufw（不复杂的防火墙）：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ufw disable</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果要保持启用 ufw，默认情况下需要以下规则：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ufw allow 6443/tcp #apiserver</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ufw allow from 10.42.0.0/16 to any #pods</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ufw allow from 10.43.0.0/16 to any #services</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>你可能还需要打开其他端口。有关详细信息，请参阅<a href="/zh/installation/requirements#k3s-server-%E8%8A%82%E7%82%B9%E7%9A%84%E5%85%A5%E7%AB%99%E8%A7%84%E5%88%99">入站规则</a>。如果更改了 pod 或服务的默认 CIDR，则需要相应地更新防火墙规则。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="raspberry-pi">Raspberry Pi<a href="#raspberry-pi" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3>
<p>Raspberry Pi OS 基于 Debian，可能会受到旧 iptables 版本的影响。请参阅<a href="#%E6%97%A7%E7%9A%84-iptables-%E7%89%88%E6%9C%AC">解决方法</a>。</p>
<p>标准 Raspberry Pi OS 不会在启用 <code>cgroups</code> 的情况下开始。<strong>K3S</strong> 需要 <code>cgroups</code> 来启动 systemd 服务。你可以通过将 <code>cgroup_memory=1 cgroup_enable=memory</code> 附加到 <code>/boot/cmdline.txt</code> 来启用 <code>cgroups</code> 。</p>
<p>示例 cmdline.txt：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">console=serial0,115200 console=tty1 root=PARTUUID=58b06195-02 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait cgroup_memory=1 cgroup_enable=memory</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从 Ubuntu 21.10 开始，对 Raspberry Pi 的 vxlan 支持已移至单独的内核模块中。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo apt install linux-modules-extra-raspi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="在-docker-中运行-k3s">在 Docker 中运行 K3s<a href="#在-docker-中运行-k3s" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<p>在 Docker 中运行 K3s 有几种方法：</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">K3d</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Docker</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p><a href="https://github.com/k3d-io/k3d" target="_blank" rel="noopener noreferrer">k3d</a> 是一个用于在 Docker 中轻松运行多节点 K3s 集群的实用程序。</p><p>K3d 能让你轻松在 Docker 中创建单节点和多节点 K3s 集群（例如 Kubernetes 上的本地开发）。</p><p>有关如何安装和使用 K3d 的更多信息，请参阅<a href="https://k3d.io/#installation" target="_blank" rel="noopener noreferrer">安装</a>文档。</p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>要使用 Docker，你还可以使用 <code>rancher/k3s</code> 镜像来运行 K3s Server 和 Agent。
使用 <code>docker run</code> 命令：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo docker run \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --privileged \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --name k3s-server-1 \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  --hostname k3s-server-1 \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -p 6443:6443 \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -d rancher/k3s:v1.24.10-k3s1 \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>你必须指定一个有效的 K3s 版本作为标签；我们未维护 <code>latest</code> 标签。<br>
<!-- -->Docker 镜像不支持在标签中使用 <code>+</code> 符号，因此，请在标签中使用 <code>-</code> 符号。</p></div></div><p>K3s 运行后，你可以将 admin kubeconfig 从 Docker 容器中复制出来：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo docker cp k3s-server-1:/etc/rancher/k3s/k3s.yaml ~/.kube/config</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="selinux-支持">SELinux 支持<a href="#selinux-支持" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>版本</div><div class="admonitionContent_BuS1"><p>从 v1.19.4+k3s1 起可用</p></div></div>
<p>如果你在默认启用 SELinux 的系统（例如 CentOS）上安装 K3s，则必须确保已安装正确的 SELinux 策略。</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">自动安装</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">手动安装</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p>如果系统兼容，而且没有进行离线安装，那么<a href="/zh/installation/configuration#%E4%BD%BF%E7%94%A8%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC%E7%9A%84%E9%80%89%E9%A1%B9">安装脚本</a>将自动从 Rancher RPM 仓库安装 SELinux RPM。你通过设置 <code>INSTALL_K3S_SKIP_SELINUX_RPM=true</code> 来跳过自动安装。</p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>可以使用以下命令安装必要的策略：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">yum install -y container-selinux selinux-policy-base</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">yum install -y https://rpm.rancher.io/k3s/latest/common/centos/7/noarch/k3s-selinux-0.2-1.el7_8.noarch.rpm</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>要让安装脚本报告 warning 而不是 fail，你可以设置环境变量 <code>INSTALL_K3S_SELINUX_WARN=true</code>。</p></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="启用-selinux-强制执行">启用 SELinux 强制执行<a href="#启用-selinux-强制执行" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3>
<p>要利用 SELinux，请在启动 K3s Server 和 Agent 时指定 <code>--selinux</code> 标志。</p>
<p>你也可以在 K3s <a href="#">配置文件</a>中指定此选项。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">selinux: true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="  复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>不支持在 SELinux 下使用自定义 <code>--data-dir</code>。要自定义它，你可能需要自行编写自定义策略。如需指导，你可以参考 <a href="https://github.com/containers/container-selinux" target="_blank" rel="noopener noreferrer">containers/container-selinux</a> 仓库，仓库包含 Container Runtime 的 SELinux 策略文件，同时你可以参考 <a href="https://github.com/k3s-io/k3s-selinux" target="_blank" rel="noopener noreferrer">k3s-io/k3s-selinux</a> 仓库，该仓库包含 K3s 的 SELinux 策略。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="启用-estargz-的-lazy-pulling实验性">启用 eStargz 的 Lazy Pulling（实验性）<a href="#启用-estargz-的-lazy-pulling实验性" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="什么是-lazy-pulling-和-estargz">什么是 Lazy Pulling 和 eStargz？<a href="#什么是-lazy-pulling-和-estargz" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3>
<p>拉取镜像是容器生命周期中比较耗时的步骤之一
（根据 <a href="https://www.usenix.org/conference/fast16/technical-sessions/presentation/harter" target="_blank" rel="noopener noreferrer">Harter 等人</a>的说法）。</p>
<blockquote>
<p>拉包占容器启动时间的 76%，但却只读取了 6.4% 的数据。</p>
</blockquote>
<p>为了解决这个问题，K3s 的实验功能支持镜像内容的 <em>lazy pulling</em>。
这允许 K3s 在拉取整个镜像之前启动一个容器。
必要的内容块（例如单个文件）是按需获取的。
对于大镜像而言，这种技术可以缩短容器启动延迟。</p>
<p>要启用 lazy pulling，你需要将目标镜像格式化为 <a href="https://github.com/containerd/stargz-snapshotter/blob/main/docs/stargz-estargz.md" target="_blank" rel="noopener noreferrer"><em>eStargz</em></a>。
这是 OCI 的一个替代品，但它 100% OCI 兼容镜像格式，用于 Lazy Pulling。
由于兼容性，eStargz 可以推送到标准容器镜像仓库（例如 ghcr.io），并且即使在 eStargz-agnostic 运行时也<em>仍然可以运行</em>。</p>
<p>eStargz 是基于 <a href="https://github.com/google/crfs" target="_blank" rel="noopener noreferrer">Google CRFS 项目提出的 stargz 格式</a>开发的，具有内容验证和性能优化等实用功能。
有关 Lazy Pulling 和 eStargz 的更多信息，请参阅 <a href="https://github.com/containerd/stargz-snapshotter" target="_blank" rel="noopener noreferrer">Stargz Snapshotter 项目仓库</a>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置-k3s-进行-estargz-的-lazy-pulling">配置 K3s 进行 eStargz 的 Lazy Pulling<a href="#配置-k3s-进行-estargz-的-lazy-pulling" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3>
<p>如下所示，K3s Server 和 Agent 需要 <code>--snapshotter=stargz</code> 选项。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">k3s server --snapshotter=stargz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复 制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用此配置，你可以对 eStargz 格式的镜像进行 Lazy Pulling。
以下 Pod 清单示例使用 eStargz 格式的 <code>node:13.13.0</code> 镜像 (<code>ghcr.io/stargz-containers/node:13.13.0-esgz</code>)。
当启用 stargz snapshotter 时，K3s 会对该镜像进行 lazy pulling。</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nodejs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nodejs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">estargz</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ghcr.io/stargz</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">containers/node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">13.13.0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">esgz</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;node&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">e</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> var http = require(&#x27;http&#x27;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      http.createServer(function(req</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> res) </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        res.writeHead(200);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        res.end(&#x27;Hello World</span><span class="token tag" style="color:rgb(255, 85, 114)">!</span><span class="token plain">\n&#x27;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">).listen(80);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="其他日志来源">其他日志来源<a href="#其他日志来源" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<p>你可以在不使用 Rancher 的情况下为 K3s 安装 <a href="https://rancher.com/docs/rancher/v2.6/en/logging/helm-chart-options/" target="_blank" rel="noopener noreferrer">Rancher Logging</a>。为此，你可以执行以下命令：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">helm repo add rancher-charts https://charts.rancher.io</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">helm install --create-namespace -n cattle-logging-system rancher-logging-crd rancher-charts/rancher-logging-crd</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">helm install --create-namespace -n cattle-logging-system rancher-logging --set additionalLoggingSources.k3s.enabled=true rancher-charts/rancher-logging</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="其他网络策略日志">其他网络策略日志<a href="#其他网络策略日志" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2>
<p>支持记录网络策略丢弃的数据包。数据包被发送到 iptables NFLOG 操作，它显示了数据包的详细信息，包括阻止它的网络策略。</p>
<p>如果流量很大，日志消息的数量可能会非常多。要在每个策略上控制日志速率，你可以在 question 的网络策略中添加以下注释，从而设置 <code>limit</code> 和 <code>limit-burst</code> iptables 参数：</p>
<ul>
<li><code>kube-router.io/netpol-nflog-limit=&lt;LIMIT-VALUE&gt;</code></li>
<li><code>kube-router.io/netpol-nflog-limit-burst=&lt;LIMIT-BURST-VALUE&gt;</code></li>
</ul>
<p>默认值为 <code>limit=10/minute</code> 和 <code>limit-burst=10</code>。你可以查看 <a href="https://www.netfilter.org/documentation/HOWTO/packet-filtering-HOWTO-7.html#:~:text=restrict%20the%20rate%20of%20matches" target="_blank" rel="noopener noreferrer">iptables 手册</a>以进一步了解这些字段的格式和可选值。</p>
<p>要将 NFLOG 数据包转换为日志条目，请安装 ulogd2 并将 <code>[log1]</code> 配置为在 <code>group=100</code> 上读取。然后，重启 ulogd2 服务以提交新配置。
当数据包被网络策略规则阻止时，日志消息将出现在 <code>/var/log/ulog/syslogemu.log</code> 中。</p>
<p>发送到 NFLOG netlink 套接字的数据包也可以使用 tcpdump 或 tshark 等命令行工具读取：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">tcpdump -ni nflog:100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>虽然更容易获得，但 tcpdump 不会显示阻止数据包的网络策略的名称。你可以使用 wireshark 的 tshark 命令来显示完整的 NFLOG 数据包标头，其中包括包含了策略名称的 <code>nflog.prefix</code> 字段。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/k3s-io/docs/edit/main/docs/advanced.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->于 <b><time datetime="2025-04-07T16:38:18.000Z" itemprop="dateModified">2025年4月7日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh/helm"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Helm</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh/reference/env-variables"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">环境变量</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#证书管理" class="table-of-contents__link toc-highlight">证书管理</a><ul><li><a href="#ca-证书" class="table-of-contents__link toc-highlight">CA 证书</a></li><li><a href="#客户端和服务器证书" class="table-of-contents__link toc-highlight">客户端和服务器证书</a></li></ul></li><li><a href="#token-管理" class="table-of-contents__link toc-highlight">Token 管理</a></li><li><a href="#配置-http-代理" class="table-of-contents__link toc-highlight">配置 HTTP 代理</a></li><li><a href="#使用-docker-作为容器运行时" class="table-of-contents__link toc-highlight">使用 Docker 作为容器运行时</a></li><li><a href="#使用-etcdctl" class="table-of-contents__link toc-highlight">使用 etcdctl</a></li><li><a href="#配置-containerd" class="table-of-contents__link toc-highlight">配置 Containerd</a></li><li><a href="#nvidia-容器运行时支持" class="table-of-contents__link toc-highlight">NVIDIA 容器运行时支持</a></li><li><a href="#运行无-agent-的-server实验性" class="table-of-contents__link toc-highlight">运行无 Agent 的 Server（实验性）</a></li><li><a href="#使用-rootless-模式运行-server实验性" class="table-of-contents__link toc-highlight">使用 Rootless 模式运行 Server（实验性）</a><ul><li><a href="#rootless-模式的已知问题" class="table-of-contents__link toc-highlight">Rootless 模式的已知问题</a></li><li><a href="#启动-rootless-server" class="table-of-contents__link toc-highlight">启动 Rootless Server</a></li><li><a href="#高级无根配置" class="table-of-contents__link toc-highlight">高级无根配置</a></li><li><a href="#rootless-模式故障排除" class="table-of-contents__link toc-highlight">Rootless 模式故障排除</a></li></ul></li><li><a href="#节点标签和污点" class="table-of-contents__link toc-highlight">节点标签和污点</a></li><li><a href="#使用安装脚本启动服务" class="table-of-contents__link toc-highlight">使用安装脚本启动服务</a></li><li><a href="#其他操作系统准备" class="table-of-contents__link toc-highlight">其他操作系统准备</a><ul><li><a href="#旧的-iptables-版本" class="table-of-contents__link toc-highlight">旧的 iptables 版本</a></li><li><a href="#red-hat-enterprise-linux--centos" class="table-of-contents__link toc-highlight">Red Hat Enterprise Linux / CentOS</a></li><li><a href="#ubuntu" class="table-of-contents__link toc-highlight">Ubuntu</a></li><li><a href="#raspberry-pi" class="table-of-contents__link toc-highlight">Raspberry Pi</a></li></ul></li><li><a href="#在-docker-中运行-k3s" class="table-of-contents__link toc-highlight">在 Docker 中运行 K3s</a></li><li><a href="#selinux-支持" class="table-of-contents__link toc-highlight">SELinux 支持</a><ul><li><a href="#启用-selinux-强制执行" class="table-of-contents__link toc-highlight">启用 SELinux 强制执行</a></li></ul></li><li><a href="#启用-estargz-的-lazy-pulling实验性" class="table-of-contents__link toc-highlight">启用 eStargz 的 Lazy Pulling（实验性）</a><ul><li><a href="#什么是-lazy-pulling-和-estargz" class="table-of-contents__link toc-highlight">什么是 Lazy Pulling 和 eStargz？</a></li><li><a href="#配置-k3s-进行-estargz-的-lazy-pulling" class="table-of-contents__link toc-highlight">配置 K3s 进行 eStargz 的 Lazy Pulling</a></li></ul></li><li><a href="#其他日志来源" class="table-of-contents__link toc-highlight">其他日志来源</a></li><li><a href="#其他网络策略日志" class="table-of-contents__link toc-highlight">其他网络策略日志</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 K3s Project Authors. All rights reserved. <br>The Linux Foundation has registered trademarks
      and uses trademarks. For a list of trademarks of The Linux Foundation, 
      please see our <a href="https://www.linuxfoundation.org/trademark-usage"> Trademark Usage</a> page.</div></div></div></footer></div>
</body>
</html>