"use strict";(self.webpackChunkk_3_s_docs=self.webpackChunkk_3_s_docs||[]).push([[7402],{67984:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>a,contentTitle:()=>c,default:()=>l,frontMatter:()=>o,metadata:()=>n,toc:()=>i});const n=JSON.parse('{"id":"cli/etcd-snapshot","title":"etcd-snapshot","description":"This page describes how to use the k3s etcd-snapshot CLI tool to manage etcd snapshots and how to restore from an etcd snapshot.","source":"@site/docs/cli/etcd-snapshot.md","sourceDirName":"cli","slug":"/cli/etcd-snapshot","permalink":"/cli/etcd-snapshot","draft":false,"unlisted":false,"editUrl":"https://github.com/k3s-io/docs/edit/main/docs/cli/etcd-snapshot.md","tags":[],"version":"current","lastUpdatedAt":1760988387000,"frontMatter":{"title":"etcd-snapshot"},"sidebar":"mySidebar","previous":{"title":"certificate","permalink":"/cli/certificate"},"next":{"title":"secrets-encrypt","permalink":"/cli/secrets-encrypt"}}');var r=t(74848),d=t(28453);const o={title:"etcd-snapshot"},c="k3s etcd-snapshot",a={},i=[{value:"Creating Snapshots",id:"creating-snapshots",level:2},{value:"Deleting Snapshots",id:"deleting-snapshots",level:2},{value:"S3 Compatible Object Store Support",id:"s3-compatible-object-store-support",level:2},{value:"S3 Retention",id:"s3-retention",level:3},{value:"S3 Configuration Secret Support",id:"s3-configuration-secret-support",level:3},{value:"Restoring Snapshots",id:"restoring-snapshots",level:2},{value:"Snapshot Restore Steps",id:"snapshot-restore-steps",level:3},{value:"Restoring To New Hosts",id:"restoring-to-new-hosts",level:4},{value:"ETCDSnapshotFile Custom Resources",id:"etcdsnapshotfile-custom-resources",level:2}];function h(e){const s={a:"a",admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,d.R)(),...e.components},{TabItem:t,Tabs:n}=s;return t||p("TabItem",!0),n||p("Tabs",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"k3s-etcd-snapshot",children:"k3s etcd-snapshot"})}),"\n",(0,r.jsxs)(s.p,{children:["This page describes how to use the ",(0,r.jsx)(s.code,{children:"k3s etcd-snapshot"})," CLI tool to manage etcd snapshots and how to restore from an etcd snapshot."]}),"\n",(0,r.jsxs)(s.p,{children:["K3s etcd snapshots are stored on the node file system, and may optionally be uploaded to an S3 compatible object store for disaster recovery scenarios. Snapshots can be both automated on a reoccurring schedule, and taken manually on-demand.  The ",(0,r.jsx)(s.code,{children:"k3s etcd-snapshot"})," CLI tool offers a set of subcommands that can be used to create, delete, and manage snapshots."]}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Subcommand"}),(0,r.jsx)(s.th,{children:"Description"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"delete"}),(0,r.jsx)(s.td,{children:"Delete given snapshot(s)"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"ls, list, l"}),(0,r.jsx)(s.td,{children:"List snapshots"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"prune"}),(0,r.jsx)(s.td,{children:"Remove snapshots that exceed the configured retention count"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"save"}),(0,r.jsx)(s.td,{children:"Trigger an on-demand etcd snapshot"})]})]})]}),"\n",(0,r.jsxs)(s.p,{children:["For additional information on the etcd snapshot subcommands, run ",(0,r.jsx)(s.code,{children:"k3s etcd-snapshot --help"}),"."]}),"\n",(0,r.jsx)(s.h2,{id:"creating-snapshots",children:"Creating Snapshots"}),"\n",(0,r.jsxs)(n,{groupId:"snapshots",children:[(0,r.jsxs)(t,{value:"Scheduled",children:[(0,r.jsxs)(s.p,{children:["Scheduled snapshots are enabled by default, at 00:00 and 12:00 system time, with 5 snapshots retained. Scheduled snapshots have a name that starts with ",(0,r.jsx)(s.code,{children:"etcd-snapshot"}),", followed by the node name and timestamp."]}),(0,r.jsx)(s.p,{children:"The following options control the operation of scheduled snapshots:"}),(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Flag"}),(0,r.jsx)(s.th,{children:"Description"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-disable-snapshots"})}),(0,r.jsx)(s.td,{children:"Disable scheduled snapshots"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-snapshot-name"})}),(0,r.jsxs)(s.td,{children:["Sets the base name of etcd scheduled snapshots. (Default: ",(0,r.jsx)(s.code,{children:"etcd-snapshot"}),")"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-snapshot-compress"})}),(0,r.jsx)(s.td,{children:"Compress etcd snapshots"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-snapshot-dir"})}),(0,r.jsxs)(s.td,{children:["Directory to save db snapshots. (Default location: ",(0,r.jsx)(s.code,{children:"${data-dir}/db/snapshots"}),")"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-snapshot-retention"})}),(0,r.jsx)(s.td,{children:"Number of snapshots to retain (default: 5)"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-snapshot-schedule-cron"})}),(0,r.jsxs)(s.td,{children:["Snapshot interval time in cron spec. eg. every 5 hours ",(0,r.jsx)(s.code,{children:"0 */5 * * *"})," (default: ",(0,r.jsx)(s.code,{children:"0 */12 * * *"}),")"]})]})]})]}),(0,r.jsxs)(s.p,{children:["The data-dir value defaults to ",(0,r.jsx)(s.code,{children:"/var/lib/rancher/k3s"})," and can be changed independently by setting the ",(0,r.jsx)(s.code,{children:"--data-dir"})," flag."]}),(0,r.jsxs)(s.p,{children:["Scheduled snapshots are saved to the path set by the server's ",(0,r.jsx)(s.code,{children:"--etcd-snapshot-dir"})," value. If you want them replicated in S3 compatible object stores, refer to ",(0,r.jsx)(s.a,{href:"#s3-compatible-object-store-support",children:"S3 configuration options"})]})]}),(0,r.jsxs)(t,{value:"On-demand",children:[(0,r.jsxs)(s.p,{children:["Snapshots can be saved manually by running the ",(0,r.jsx)(s.code,{children:"k3s etcd-snapshot save"})," command. There is no retention for these on-demand snapshots and the user needs to remove them manually by using ",(0,r.jsx)(s.code,{children:"k3s etcd-snapshot delete"})," or ",(0,r.jsx)(s.code,{children:"k3s etcd-snapshot prune"})," commands. On-demand snapshots have a name that starts with ",(0,r.jsx)(s.code,{children:"on-demand"}),", followed by the node name and timestamp."]}),(0,r.jsx)(s.p,{children:"The following options control the operation of on-demand snapshots:"}),(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Flag"}),(0,r.jsx)(s.th,{children:"Description"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--name"})}),(0,r.jsxs)(s.td,{children:["Sets the base name of etcd on-demand snapshots. (Default: ",(0,r.jsx)(s.code,{children:"on-demand"}),")"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-snapshot-compress"})}),(0,r.jsx)(s.td,{children:"Compress etcd snapshots"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-snapshot-dir"})}),(0,r.jsxs)(s.td,{children:["Directory to save db snapshots. (Default location: ",(0,r.jsx)(s.code,{children:"${data-dir}/db/snapshots"}),")"]})]})]})]}),(0,r.jsxs)(s.p,{children:["The data-dir value defaults to ",(0,r.jsx)(s.code,{children:"/var/lib/rancher/k3s"})," and can be changed independently by setting the ",(0,r.jsx)(s.code,{children:"--data-dir"})," flag."]}),(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"--name"})," flag can only be set when running the ",(0,r.jsx)(s.code,{children:"k3s etcd-snapshot save"})," command. The other two can also be part of the ",(0,r.jsx)(s.code,{children:"k3s server"})," ",(0,r.jsx)(s.a,{href:"/installation/configuration#configuration-file",children:"configuration file"})]}),(0,r.jsxs)(s.p,{children:["On-demand snapshots are saved to the path set by the server's ",(0,r.jsx)(s.code,{children:"--etcd-snapshot-dir"})," value. If you want them replicated in S3 compatible object stores, refer to ",(0,r.jsx)(s.a,{href:"#s3-compatible-object-store-support",children:"S3 configuration options"})]})]})]}),"\n",(0,r.jsx)(s.h2,{id:"deleting-snapshots",children:"Deleting Snapshots"}),"\n",(0,r.jsx)(s.p,{children:"Scheduled snapshots are deleted automatically when the number of snapshots exceeds the configured retention count (5 by default). The oldest snapshots are removed first."}),"\n",(0,r.jsxs)(s.p,{children:["To manually delete scheduled snapshot(s) or on-demand snapshot(s), you can use the ",(0,r.jsx)(s.code,{children:"k3s etcd-snapshot delete"})," command:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"k3s etcd-snapshot delete <SNAPSHOT-NAME-1> <SNAPSHOT-NAME-2> ...\n"})}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"prune"})," subcommand removes snapshots that match the name prefix (",(0,r.jsx)(s.code,{children:"on-demand"})," by default) and exceed the configured retention count. It includes the flag ",(0,r.jsx)(s.code,{children:"--snapshot-retention"})," to set the retention count. For scheduled snapshots, it overrides the default retention policy. On-demand snapshots have no retention policy and hence this flag is required."]}),"\n",(0,r.jsx)(s.p,{children:'Prune "on-demand" snapshots down to a smaller amount:'}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"k3s etcd-snapshot prune --snapshot-retention  <NUM-OF-SNAPSHOTS-TO-RETAIN>\n"})}),"\n",(0,r.jsx)(s.p,{children:'Prune "scheduled" snapshots down to a smaller amount:'}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"k3s etcd-snapshot prune --name etcd-snapshot --etcd-snapshot-retention <NUM-OF-SNAPSHOTS-TO-RETAIN>\n"})}),"\n",(0,r.jsx)(s.h2,{id:"s3-compatible-object-store-support",children:"S3 Compatible Object Store Support"}),"\n",(0,r.jsx)(s.p,{children:"K3s supports replicating etcd snapshots to and restoring etcd snapshots from S3-compatible object stores. S3 support is available for both on-demand and scheduled snapshots."}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Flag"}),(0,r.jsx)(s.th,{children:"Description"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3"})}),(0,r.jsx)(s.td,{children:"Enable backup to S3"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3-endpoint"})}),(0,r.jsx)(s.td,{children:"S3 endpoint url"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3-endpoint-ca"})}),(0,r.jsx)(s.td,{children:"S3 custom CA cert to connect to S3 endpoint"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3-skip-ssl-verify"})}),(0,r.jsx)(s.td,{children:"Disables S3 SSL certificate validation"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3-access-key"})}),(0,r.jsx)(s.td,{children:"S3 access key"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3-secret-key"})}),(0,r.jsx)(s.td,{children:"S3 secret key"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3-bucket"})}),(0,r.jsx)(s.td,{children:"S3 bucket name"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3-region"})}),(0,r.jsx)(s.td,{children:"S3 region / bucket location (optional). defaults to us-east-1"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3-folder"})}),(0,r.jsx)(s.td,{children:"S3 folder"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3-proxy"})}),(0,r.jsx)(s.td,{children:"Proxy server to use when connecting to S3, overriding any proxy-releated environment variables"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3-insecure"})}),(0,r.jsx)(s.td,{children:"Disables S3 over HTTPS"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3-timeout"})}),(0,r.jsxs)(s.td,{children:["S3 timeout (default: ",(0,r.jsx)(s.code,{children:"5m0s"}),")"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3-config-secret"})}),(0,r.jsx)(s.td,{children:"Name of secret in the kube-system namespace used to configure S3, if etcd-s3 is enabled and no other etcd-s3 options are set"})]})]})]}),"\n",(0,r.jsx)(s.p,{children:"For example, this is how the creation and deletion of on-demand etcd snapshots in S3 would work:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-shell-session",children:"$ k3s etcd-snapshot --s3 --s3-bucket=test-bucket --s3-access-key=test --s3-secret-key=secret save\nINFO[0155] Snapshot on-demand-server-0-1753178523 saved. \nINFO[0155] Snapshot on-demand-server-0-1753178523 saved. \n\n$ k3s etcd-snapshot --s3 --s3-bucket=test-bucket --s3-access-key=test --s3-secret-key=secret ls\nName                              Location                                                                          Size    Created\non-demand-server-0-1753178523     s3://test-bucket/test-folder/on-demand-server-0-1753178523                        5062688 2025-07-22T10:02:03Z\non-demand-server-0-1753178523     file:///var/lib/rancher/k3s/server/db/snapshots/on-demand-server-0-1753178523     5062688 2025-07-22T10:02:03Z\n\n$ k3s etcd-snapshot --s3 --s3-bucket=test-bucket --s3-access-key=test --s3-secret-key=secret delete on-demand-server-0-1753178523\nINFO[0000] Snapshot on-demand-server-0-1753178523 deleted.\n\n$ k3s etcd-snapshot --s3 --s3-bucket=test-bucket --s3-access-key=test --s3-secret-key=secret ls\nName                              Location                                                                          Size    Created\n"})}),"\n",(0,r.jsx)(s.h3,{id:"s3-retention",children:"S3 Retention"}),"\n",(0,r.jsx)(s.admonition,{title:"Version Gate",type:"info",children:(0,r.jsx)(s.p,{children:"Starting in versions v1.34.0+k3s1, v1.33.4+k3s1, v1.32.8+k3s1, v1.31.12+k3s1, K3s includes a new flag for S3 retention. It has the same default value as the local snapshot retention."})}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Flag"}),(0,r.jsx)(s.th,{children:"Description"})]})}),(0,r.jsx)(s.tbody,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--etcd-s3-retention"})}),(0,r.jsxs)(s.td,{children:["Number of snapshots in S3 to retain (default: ",(0,r.jsx)(s.code,{children:"5"}),")"]})]})})]}),"\n",(0,r.jsx)(s.h3,{id:"s3-configuration-secret-support",children:"S3 Configuration Secret Support"}),"\n",(0,r.jsx)(s.admonition,{title:"Version Gate",type:"info",children:(0,r.jsx)(s.p,{children:"S3 Configuration Secret support is available as of the August 2024 releases: v1.30.4+k3s1, v1.29.8+k3s1, v1.28.13+k3s1"})}),"\n",(0,r.jsxs)(s.p,{children:["K3s supports reading etcd S3 snapshot configuration from a Kubernetes Secret.\nThis may be preferred to hardcoding credentials in K3s CLI flags or config files for security reasons, or if credentials need to be rotated without restarting K3s.\nTo pass S3 snapshot configuration via a Secret, start K3s with ",(0,r.jsx)(s.code,{children:"--etcd-s3"})," and ",(0,r.jsx)(s.code,{children:"--etcd-s3-config-secret=<SECRET-NAME>"}),".\nThe Secret does not need to exist when K3s is started, but it will be checked for every time a snapshot save/list/delete/prune operation is performed."]}),"\n",(0,r.jsx)(s.p,{children:"The S3 config Secret cannot be used when restoring a snapshot, as the apiserver is not available to provide the secret during a restore.\nS3 configuration must be passed via the CLI when restoring a snapshot stored on S3."}),"\n",(0,r.jsx)(s.admonition,{type:"note",children:(0,r.jsxs)(s.p,{children:["Pass only the the ",(0,r.jsx)(s.code,{children:"--etcd-s3"})," and ",(0,r.jsx)(s.code,{children:"--etcd-s3-config-secret"})," flags to enable the Secret.",(0,r.jsx)(s.br,{}),"\n","If any other S3 configuration flags are set, the Secret will be ignored."]})}),"\n",(0,r.jsxs)(s.p,{children:["Keys in the Secret correspond to the ",(0,r.jsx)(s.code,{children:"--etcd-s3-*"})," CLI flags listed above.\nThe ",(0,r.jsx)(s.code,{children:"etcd-s3-endpoint-ca"})," key accepts a PEM-encoded CA bundle, or the ",(0,r.jsx)(s.code,{children:"etcd-s3-endpoint-ca-name"})," key may be used to specify the name of a ConfigMap in the ",(0,r.jsx)(s.code,{children:"kube-system"})," namespace containing one or more PEM-encoded CA bundles."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Secret\nmetadata:\n  name: k3s-etcd-snapshot-s3-config\n  namespace: kube-system\ntype: etcd.k3s.cattle.io/s3-config-secret\nstringData:\n  etcd-s3-endpoint: ""\n  etcd-s3-endpoint-ca: ""\n  etcd-s3-endpoint-ca-name: ""\n  etcd-s3-skip-ssl-verify: "false"\n  etcd-s3-access-key: "AWS_ACCESS_KEY_ID"\n  etcd-s3-secret-key: "AWS_SECRET_ACCESS_KEY"\n  etcd-s3-bucket: "bucket"\n  etcd-s3-folder: "folder"\n  etcd-s3-region: "us-east-1"\n  etcd-s3-insecure: "false"\n  etcd-s3-timeout: "5m"\n  etcd-s3-proxy: ""\n'})}),"\n",(0,r.jsx)(s.h2,{id:"restoring-snapshots",children:"Restoring Snapshots"}),"\n",(0,r.jsx)(s.p,{children:"K3s runs through several steps when restoring a snapshot:"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"If the snapshot is stored on S3, the file is downloaded into the snapshot directory."}),"\n",(0,r.jsx)(s.li,{children:"If the snapshot is compressed, it is decompressed."}),"\n",(0,r.jsxs)(s.li,{children:["If present, the current etcd database files are moved to ",(0,r.jsx)(s.code,{children:"${data-dir}/server/db/etcd-old-$TIMESTAMP/"}),"."]}),"\n",(0,r.jsx)(s.li,{children:"The snapshot's contents are extracted out to disk, and the checksum is verified."}),"\n",(0,r.jsx)(s.li,{children:"Etcd is started, and all etcd cluster members except the current node are removed from the cluster."}),"\n",(0,r.jsx)(s.li,{children:"CA Certificates and other confidential data are extracted from the datastore and written to disk, for later use."}),"\n",(0,r.jsx)(s.li,{children:"The restore is complete, and K3s can be restarted and used normally on the server where the restore was performed."}),"\n",(0,r.jsx)(s.li,{children:"(optional) Agents and control-plane servers can be started normally."}),"\n",(0,r.jsx)(s.li,{children:"(optional) Etcd servers can be restarted to rejoin to the cluster after removing old database files."}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"When restoring a snapshot, you don't need to use the same K3s version that created it; a higher minor version is also acceptable."}),"\n",(0,r.jsx)(s.h3,{id:"snapshot-restore-steps",children:"Snapshot Restore Steps"}),"\n",(0,r.jsx)(s.p,{children:"Select the tab below that matches your cluster configuration."}),"\n",(0,r.jsxs)(n,{queryString:"etcdsnap",children:[(0,r.jsxs)(t,{value:"Single Server",default:!0,children:[(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsx)(s.p,{children:"Stop the K3s service:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"systemctl stop k3s\n"})}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:["Run ",(0,r.jsx)(s.code,{children:"k3s server"})," with the ",(0,r.jsx)(s.code,{children:"--cluster-reset"})," flag, and ",(0,r.jsx)(s.code,{children:"--cluster-reset-restore-path"})," indicating the path to the snapshot to restore.\nIf the snapshot is stored on S3, provide S3 configuration flags (",(0,r.jsx)(s.code,{children:"--etcd-s3"}),", ",(0,r.jsx)(s.code,{children:"--etcd-s3-bucket"}),", and so on), and give only the filename name of the snapshot as the restore path."]}),"\n",(0,r.jsx)(s.admonition,{type:"note",children:(0,r.jsxs)(s.p,{children:["Using the ",(0,r.jsx)(s.code,{children:"--cluster-reset"})," flag without specifying a snapshot to restore simply resets the etcd cluster to a single member without restoring a snapshot."]})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"k3s server \\\n  --cluster-reset \\\n  --cluster-reset-restore-path=<PATH-TO-SNAPSHOT>\n"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Result:"})," K3s restores the snapshot and resets cluster membership, then prints a message indicating that it is ready to be restarted:",(0,r.jsx)(s.br,{}),"\n",(0,r.jsx)(s.code,{children:"Managed etcd cluster membership has been reset, restart without --cluster-reset flag now."})]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsx)(s.p,{children:"Start K3s again:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"systemctl start k3s\n"})}),"\n"]}),"\n"]}),(0,r.jsxs)(s.p,{children:["If an etcd-s3 backup configuration is defined within the K3s config file, the k3s restore will attempt to pull the snapshot file from the configured S3 bucket. In this instance only the snapshot filename should be passed in the argument ",(0,r.jsx)(s.code,{children:"--cluster-reset-restore-path"}),". To restore from a local snapshot file, where an etcd-s3 backup configuration is present, add the argument ",(0,r.jsx)(s.code,{children:"--etcd-s3=false"})," and pass the full path to the local snapshot file in the argument ",(0,r.jsx)(s.code,{children:"--cluster-reset-restore-path"}),"."]}),(0,r.jsxs)(s.p,{children:["As a safety mechanism, when K3s resets the cluster, it creates an empty file at ",(0,r.jsx)(s.code,{children:"/var/lib/rancher/k3s/server/db/reset-flag"})," that prevents users from accidentally running multiple cluster resets in succession. This file is deleted when K3s starts normally."]})]}),(0,r.jsxs)(t,{value:"Multiple Servers",children:[(0,r.jsxs)(s.p,{children:["In this example there are 3 servers, ",(0,r.jsx)(s.code,{children:"S1"}),", ",(0,r.jsx)(s.code,{children:"S2"}),", and ",(0,r.jsx)(s.code,{children:"S3"}),". The snapshot is located on ",(0,r.jsx)(s.code,{children:"S1"}),"."]}),(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsx)(s.p,{children:"Stop K3s on all servers:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"systemctl stop k3s\n"})}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:["On S1, run ",(0,r.jsx)(s.code,{children:"k3s server"})," with the ",(0,r.jsx)(s.code,{children:"--cluster-reset"})," option, and ",(0,r.jsx)(s.code,{children:"--cluster-reset-restore-path"})," indicating the path to the snapshot to restore.\nIf the snapshot is stored on S3, provide S3 configuration flags (",(0,r.jsx)(s.code,{children:"--etcd-s3"}),", ",(0,r.jsx)(s.code,{children:"--etcd-s3-bucket"}),", and so on), and give only the filename name of the snapshot as the restore path."]}),"\n",(0,r.jsx)(s.admonition,{type:"note",children:(0,r.jsxs)(s.p,{children:["Using the ",(0,r.jsx)(s.code,{children:"--cluster-reset"})," flag without specifying a snapshot to restore simply resets the etcd cluster to a single member without restoring a snapshot."]})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"k3s server \\\n  --cluster-reset \\\n  --cluster-reset-restore-path=<PATH-TO-SNAPSHOT>\n"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Result:"})," K3s restores the snapshot and resets cluster membership, then prints a message indicating that it is ready to be restarted:",(0,r.jsx)(s.br,{}),"\n",(0,r.jsx)(s.code,{children:"Managed etcd cluster membership has been reset, restart without --cluster-reset flag now."}),(0,r.jsx)(s.br,{}),"\n",(0,r.jsx)(s.code,{children:"Backup and delete ${datadir}/server/db on each peer etcd server and rejoin the nodes."})]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsx)(s.p,{children:"On S1, start K3s again:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"systemctl start k3s\n"})}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:["On S2 and S3, delete the data directory, ",(0,r.jsx)(s.code,{children:"/var/lib/rancher/k3s/server/db/"}),":"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"rm -rf /var/lib/rancher/k3s/server/db/\n"})}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsx)(s.p,{children:"On S2 and S3, start K3s again to join the restored cluster:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"systemctl start k3s\n"})}),"\n"]}),"\n"]}),(0,r.jsxs)(s.p,{children:["If an etcd-s3 backup configuration is defined within the K3s config file, the k3s restore will attempt to pull the snapshot file from the configured S3 bucket. In this instance only the snapshot filename should be passed in the argument ",(0,r.jsx)(s.code,{children:"--cluster-reset-restore-path"}),". To restore from a local snapshot file, where an etcd-s3 backup configuration is present, add the argument ",(0,r.jsx)(s.code,{children:"--etcd-s3=false"})," and pass the full path to the local snapshot file in the argument ",(0,r.jsx)(s.code,{children:"--cluster-reset-restore-path"}),"."]}),(0,r.jsxs)(s.p,{children:["As a safety mechanism, when K3s resets the cluster, it creates an empty file at ",(0,r.jsx)(s.code,{children:"/var/lib/rancher/k3s/server/db/reset-flag"})," that prevents users from accidentally running multiple cluster resets in succession. This file is deleted when K3s starts normally."]})]})]}),"\n",(0,r.jsx)(s.h4,{id:"restoring-to-new-hosts",children:"Restoring To New Hosts"}),"\n",(0,r.jsxs)(s.p,{children:["It is possible to restore an etcd snapshot to a different host than it was taken on. When doing so, you must pass the ",(0,r.jsx)(s.a,{href:"/cli/token#server",children:"server token"})," that was originally used when taking the snapshot, as it is used to decrypt the bootstrap data inside the snapshot. The process is the same as above but changing step 2 by:"]}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:["In the node that took the snapshot save the value of: ",(0,r.jsx)(s.code,{children:"/var/lib/rancher/k3s/server/token"}),". This is ",(0,r.jsx)(s.code,{children:"<BACKED-UP-TOKEN-VALUE>"})," in step 3."]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:["Copy the snapshot to the new node. The path in the node is ",(0,r.jsx)(s.code,{children:"<PATH-TO-SNAPSHOT>"})," in step 3"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsx)(s.p,{children:"Initiate the restore from snapshot on the first server node with the following commands:"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"k3s server \\\n  --cluster-reset \\\n  --cluster-reset-restore-path=<PATH-TO-SNAPSHOT>\n  --token=<BACKED-UP-TOKEN-VALUE>\n"})}),"\n",(0,r.jsx)(s.p,{children:"The token value can also be set in the K3s config file."}),"\n",(0,r.jsx)(s.admonition,{type:"warning",children:(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Node resources are also included in the etcd snapshot. If restoring to a new set of nodes, you will need to manually delete any old nodes that are no longer present in the cluster."}),"\n",(0,r.jsxs)(s.li,{children:["If there is a token set in the K3s config file, make sure it is the same as the ",(0,r.jsx)(s.code,{children:"<BACKED-UP-TOKEN-VALUE>"}),", otherwise k3s will fail to start."]}),"\n"]})}),"\n",(0,r.jsx)(s.h2,{id:"etcdsnapshotfile-custom-resources",children:"ETCDSnapshotFile Custom Resources"}),"\n",(0,r.jsx)(s.admonition,{title:"Version Gate",type:"info",children:(0,r.jsx)(s.p,{children:"ETCDSnapshotFiles are available as of the November 2023 releases: v1.28.4+k3s2, v1.27.8+k3s2, v1.26.11+k3s2, v1.25.16+k3s4"})}),"\n",(0,r.jsxs)(s.p,{children:["Snapshots can be viewed remotely using any Kubernetes client by listing or describing cluster-scoped ",(0,r.jsx)(s.code,{children:"ETCDSnapshotFile"})," resources.\nUnlike the ",(0,r.jsx)(s.code,{children:"k3s etcd-snapshot list"})," command, which only shows snapshots visible to that node, ",(0,r.jsx)(s.code,{children:"ETCDSnapshotFile"})," resources track all snapshots present on cluster members."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-shell-session",children:"$ kubectl get etcdsnapshotfile\nNAME                                             SNAPSHOTNAME                        NODE           LOCATION                                                                            SIZE      CREATIONTIME\nlocal-on-demand-k3s-server-1-1730308816-3e9290   on-demand-k3s-server-1-1730308816   k3s-server-1   file:///var/lib/rancher/k3s/server/db/snapshots/on-demand-k3s-server-1-1730308816   2891808   2024-10-30T17:20:16Z\ns3-on-demand-k3s-server-1-1730308816-79b15c      on-demand-k3s-server-1-1730308816   s3             s3://etcd/k3s-test/on-demand-k3s-server-1-1730308816                                2891808   2024-10-30T17:20:16Z\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-shell-session",children:"$ kubectl describe etcdsnapshotfile s3-on-demand-k3s-server-1-1730308816-79b15c\nName:         s3-on-demand-k3s-server-1-1730308816-79b15c\nNamespace:\nLabels:       etcd.k3s.cattle.io/snapshot-storage-node=s3\nAnnotations:  etcd.k3s.cattle.io/snapshot-token-hash: b4b83cda3099\nAPI Version:  k3s.cattle.io/v1\nKind:         ETCDSnapshotFile\nMetadata:\n  Creation Timestamp:  2024-10-30T17:20:16Z\n  Finalizers:\n    wrangler.cattle.io/managed-etcd-snapshots-controller\n  Generation:        1\n  Resource Version:  790\n  UID:               bec9a51c-dbbe-4746-922e-a5136bef53fc\nSpec:\n  Location:   s3://etcd/k3s-test/on-demand-k3s-server-1-1730308816\n  Node Name:  s3\n  s3:\n    Bucket:           etcd\n    Endpoint:         s3.example.com\n    Prefix:           k3s-test\n    Region:           us-east-1\n    Skip SSL Verify:  true\n  Snapshot Name:      on-demand-k3s-server-1-1730308816\nStatus:\n  Creation Time:  2024-10-30T17:20:16Z\n  Ready To Use:   true\n  Size:           2891808\nEvents:\n  Type    Reason               Age   From            Message\n  ----    ------               ----  ----            -------\n  Normal  ETCDSnapshotCreated  113s  k3s-supervisor  Snapshot on-demand-k3s-server-1-1730308816 saved on S3\n"})})]})}function l(e={}){const{wrapper:s}={...(0,d.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}function p(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},28453:(e,s,t)=>{t.d(s,{R:()=>o,x:()=>c});var n=t(96540);const r={},d=n.createContext(r);function o(e){const s=n.useContext(d);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),n.createElement(d.Provider,{value:s},e.children)}}}]);