"use strict";(self.webpackChunkk_3_s_docs=self.webpackChunkk_3_s_docs||[]).push([[3502],{97052:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"security/secrets-encryption","title":"Secrets Encryption","description":"K3s supports enabling secrets encryption at rest. When first starting the server, passing the flag --secrets-encryption will do the following automatically:","source":"@site/docs/security/secrets-encryption.md","sourceDirName":"security","slug":"/security/secrets-encryption","permalink":"/security/secrets-encryption","draft":false,"unlisted":false,"editUrl":"https://github.com/k3s-io/docs/edit/main/docs/security/secrets-encryption.md","tags":[],"version":"current","lastUpdatedAt":1766444007000,"frontMatter":{"title":"Secrets Encryption"},"sidebar":"mySidebar","previous":{"title":"Security","permalink":"/security/"},"next":{"title":"CIS Hardening Guide","permalink":"/security/hardening-guide"}}');var t=i(74848),s=i(28453);const o={title:"Secrets Encryption"},c="Secrets Encryption Config",l={},d=[{value:"Choosing Encryption Provider",id:"choosing-encryption-provider",level:2},{value:"Migrating Providers",id:"migrating-providers",level:4},{value:"Generated encryption config file",id:"generated-encryption-config-file",level:2},{value:"Secrets Encryption Tool",id:"secrets-encryption-tool",level:2}];function a(e){const n={a:"a",admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",h4:"h4",header:"header",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"secrets-encryption-config",children:"Secrets Encryption Config"})}),"\n",(0,t.jsxs)(n.p,{children:["K3s supports enabling secrets encryption at rest. When first starting the server, passing the flag ",(0,t.jsx)(n.code,{children:"--secrets-encryption"})," will do the following automatically:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Generate an AES-CBC key"}),"\n",(0,t.jsx)(n.li,{children:"Generate an encryption config file with the generated key"}),"\n",(0,t.jsx)(n.li,{children:"Pass the config to the KubeAPI as encryption-provider-config"}),"\n"]}),"\n",(0,t.jsxs)(n.admonition,{type:"tip",children:[(0,t.jsx)(n.mdxAdmonitionTitle,{}),(0,t.jsxs)(n.p,{children:["Secrets-encryption cannot be enabled on an existing server without restarting it.",(0,t.jsx)(n.br,{}),"\n","Use ",(0,t.jsx)(n.code,{children:"curl -sfL https://get.k3s.io | sh -s - server --secrets-encryption"})," if installing from script, or other methods described in ",(0,t.jsx)(n.a,{href:"/installation/configuration#configuration-with-install-script",children:"Configuration Options"}),"."]})]}),"\n",(0,t.jsx)(n.h2,{id:"choosing-encryption-provider",children:"Choosing Encryption Provider"}),"\n",(0,t.jsx)(n.admonition,{title:"Version Gate",type:"info",children:(0,t.jsx)(n.p,{children:"Available as of the April 2025 releases: v1.30.12+k3s1, v1.31.8+k3s1, v1.32.4+k3s1, v1.33.0+k3s1"})}),"\n",(0,t.jsxs)(n.p,{children:["Using the ",(0,t.jsx)(n.code,{children:"--secrets-encryption-provider"})," flag, you can choose which encryption provider to use. The default is ",(0,t.jsx)(n.code,{children:"aescbc"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"K3s supports the following encryption providers:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"aescbc"}),": AES-CBC with PKCS#7 padding"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"secretbox"}),": XSalsa20 and Poly1305"]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"migrating-providers",children:"Migrating Providers"}),"\n",(0,t.jsxs)(n.p,{children:["You can migrate from the ",(0,t.jsx)(n.code,{children:"aescbc"})," provider to the ",(0,t.jsx)(n.code,{children:"secretbox"})," provider by following these steps:"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Ensure that the ",(0,t.jsx)(n.code,{children:"secretbox"})," provider is supported by your K3s version."]}),"\n",(0,t.jsxs)(n.li,{children:["Update/Add the ",(0,t.jsx)(n.code,{children:"secrets-encryption-provider"})," flag in your K3s configuration file to ",(0,t.jsx)(n.code,{children:"secretbox"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Rotate the encryption keys, following the ",(0,t.jsx)(n.a,{href:"/cli/secrets-encrypt#encryption-key-rotation",children:"Encryption Key Rotation"})," section below."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"generated-encryption-config-file",children:"Generated encryption config file"}),"\n",(0,t.jsxs)(n.p,{children:["When you start the server with ",(0,t.jsx)(n.code,{children:"--secrets-encryption"}),", K3s will generate an encryption config file at ",(0,t.jsx)(n.code,{children:"/var/lib/rancher/k3s/server/cred/encryption-config.json"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["Below is an example of the generated encryption config file with the default ",(0,t.jsx)(n.code,{children:"aescbc"})," provider:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "kind": "EncryptionConfiguration",\n  "apiVersion": "apiserver.config.k8s.io/v1",\n  "resources": [\n    {\n      "resources": [\n        "secrets"\n      ],\n      "providers": [\n        {\n          "aescbc": {\n            "keys": [\n              {\n                "name": "aescbckey",\n                "secret": "xxxxxxxxxxxxxxxxxxx"\n              }\n            ]\n          }\n        },\n        {\n          "identity": {}\n        }\n      ]\n    }\n  ]\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"secrets-encryption-tool",children:"Secrets Encryption Tool"}),"\n",(0,t.jsxs)(n.p,{children:["K3s contains a utility tool ",(0,t.jsx)(n.code,{children:"secrets-encrypt"}),", which enables automatic control over the following:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Disabling/Enabling secrets encryption"}),"\n",(0,t.jsx)(n.li,{children:"Adding new encryption keys"}),"\n",(0,t.jsx)(n.li,{children:"Rotating and deleting encryption keys"}),"\n",(0,t.jsx)(n.li,{children:"Reencrypting secrets"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["For more information, see the ",(0,t.jsxs)(n.a,{href:"/cli/secrets-encrypt",children:[(0,t.jsx)(n.code,{children:"k3s secrets-encrypt"})," command documentation"]}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>c});var r=i(96540);const t={},s=r.createContext(t);function o(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);